

I'll create a comprehensive online version with Google authentication, sharing, and discussion features. This is a major upgrade that transforms StudyBuddy from a local app to a full social learning platform.

```html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>StudyBuddy - Social Learning Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

<style>
:root {
  --bg: #c7c0f0;
  --bg2: #b8b0e8;
  --bg3: #d4cef5;
  --surface: rgba(255,255,255,0.5);
  --surface2: rgba(255,255,255,0.35);
  --surface3: rgba(255,255,255,0.2);
  --card: rgba(255,255,255,0.55);
  --card-hover: rgba(255,255,255,0.72);
  --border: rgba(255,255,255,0.45);
  --border2: rgba(255,255,255,0.6);
  --glass: rgba(255,255,255,0.38);
  --glass2: rgba(255,255,255,0.25);
  --purple: #7c5ce0;
  --purple-l: #9b85f0;
  --purple-d: #5b3cc4;
  --purple-g: rgba(124,92,224,0.18);
  --pink: #e87bb0;
  --pink-l: #f09cc8;
  --pink-soft: rgba(232,123,176,0.12);
  --mint: #43d9ad;
  --mint-l: #6ee7c4;
  --mint-soft: rgba(67,217,173,0.15);
  --yellow: #f5c542;
  --yellow-l: #f7d56a;
  --yellow-soft: rgba(245,197,66,0.18);
  --green: #43d9ad;
  --green-l: #6ee7c4;
  --green-soft: rgba(67,217,173,0.12);
  --blue: #5b9cf5;
  --blue-l: #82b5f8;
  --blue-soft: rgba(91,156,245,0.12);
  --orange: #f09348;
  --orange-l: #f5aa6e;
  --orange-soft: rgba(240,147,72,0.12);
  --teal: #38c9c9;
  --teal-l: #5ed8d8;
  --teal-soft: rgba(56,201,201,0.12);
  --red: #f06060;
  --red-soft: rgba(240,96,96,0.12);
  --text: #2a1f5e;
  --text2: #5e4f8c;
  --text3: #9488b8;
  --shadow: rgba(80,50,160,0.12);
  --shadow2: rgba(80,50,160,0.22);
  --shadow-c: rgba(124,92,224,0.25);
  --r: 22px;
  --r-sm: 16px;
  --r-lg: 28px;
  --r-xl: 36px;
  --r-pill: 50px;
  --transition: 0.35s cubic-bezier(0.4,0,0.2,1);
  --bounce: 0.5s cubic-bezier(0.34,1.56,0.64,1);
  --smooth: cubic-bezier(0.22,1,0.36,1);
}
[data-theme="dark"] {
  --bg: #1a1235; --bg2: #14102a; --bg3: #221a45;
  --surface: rgba(45,35,80,0.7); --surface2: rgba(55,42,95,0.6); --surface3: rgba(65,50,110,0.45);
  --card: rgba(50,38,90,0.65); --card-hover: rgba(60,48,100,0.8);
  --border: rgba(100,80,170,0.3); --border2: rgba(120,100,190,0.35);
  --glass: rgba(40,30,75,0.6); --glass2: rgba(50,38,90,0.5);
  --text: #ede5ff; --text2: #b5a8d5; --text3: #7a6da0;
  --shadow: rgba(0,0,0,0.3); --shadow2: rgba(0,0,0,0.45);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;overflow:hidden;user-select:none;transition:background var(--transition),color var(--transition);}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-thumb{background:rgba(124,92,224,0.3);border-radius:3px;}

.app-bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;background:linear-gradient(160deg,var(--bg3) 0%,var(--bg) 40%,var(--bg2) 100%);transition:background 0.5s ease;}
.bg-orb{position:absolute;border-radius:50%;filter:blur(70px);opacity:0.45;will-change:transform;}
[data-theme="dark"] .bg-orb{opacity:0.18;}
.bg-orb-1{width:280px;height:280px;background:#a78bfa;top:-60px;right:-40px;animation:orbFloat 8s ease-in-out infinite;}
.bg-orb-2{width:220px;height:220px;background:#67e8f9;bottom:120px;left:-60px;animation:orbFloat 10s ease-in-out infinite reverse;}
.bg-orb-3{width:180px;height:180px;background:#f0abfc;top:45%;left:60%;animation:orbFloat 12s ease-in-out infinite 2s;}
.bg-orb-4{width:160px;height:160px;background:#43d9ad;bottom:250px;right:-30px;animation:orbFloat 9s ease-in-out infinite 1s;}
@keyframes orbFloat{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-25px) scale(1.08);}}

/* Splash */
#splash{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;}
.splash-bg{position:absolute;inset:0;background:linear-gradient(160deg,#d4cef5 0%,#b8b0e8 25%,#9078d0 55%,#6840c6 85%,#4a20a8 100%);background-size:400% 400%;animation:splashGrad 4s ease infinite;}
@keyframes splashGrad{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
.splash-particles{position:absolute;inset:0;overflow:hidden;}
.splash-particle{position:absolute;border-radius:50%;background:rgba(255,255,255,0.12);animation:spFloat linear infinite;}
@keyframes spFloat{0%{transform:translateY(100vh) rotate(0deg);opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{transform:translateY(-10vh) rotate(720deg);opacity:0;}}
.splash-rings{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;}
.splash-ring{position:absolute;border-radius:50%;border:1.5px solid rgba(255,255,255,0.08);animation:ringExp 3s ease-out infinite;}
.splash-ring:nth-child(1){width:100px;height:100px;}.splash-ring:nth-child(2){width:180px;height:180px;animation-delay:0.5s;}.splash-ring:nth-child(3){width:260px;height:260px;animation-delay:1s;}.splash-ring:nth-child(4){width:340px;height:340px;animation-delay:1.5s;}
@keyframes ringExp{0%{transform:scale(0.5);opacity:0.5;}100%{transform:scale(2.2);opacity:0;}}
.splash-logo-wrap{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;opacity:0;transform:scale(0.3) translateY(30px);animation:splashEntry 1s cubic-bezier(0.34,1.56,0.64,1) 0.5s forwards;}
@keyframes splashEntry{0%{opacity:0;transform:scale(0.3) translateY(30px) rotate(-8deg);}60%{opacity:1;transform:scale(1.06) translateY(-4px) rotate(1deg);}100%{opacity:1;transform:scale(1) translateY(0) rotate(0);}}

.logo-mark{position:relative;width:120px;height:120px;margin-bottom:16px;}
.logo-shield{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:72px;height:80px;background:linear-gradient(145deg,#7c5ce0 0%,#9b78f0 40%,#b490ff 100%);border-radius:18px 18px 36px 36px;box-shadow:0 8px 28px rgba(124,92,224,0.4),0 0 50px rgba(124,92,224,0.12);display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;}
.logo-shield::before{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,0.18),transparent);border-radius:18px 18px 0 0;}
.logo-bulb{width:20px;height:20px;position:relative;margin-bottom:3px;z-index:1;}
.logo-bulb-g{width:16px;height:16px;margin:0 auto;background:linear-gradient(135deg,#f5c542,#f09348);border-radius:50% 50% 35% 35%;box-shadow:0 0 12px rgba(245,197,66,0.5);position:relative;}
.logo-bulb-g::before{content:'';position:absolute;top:3px;left:3px;width:5px;height:4px;background:rgba(255,255,255,0.45);border-radius:50%;}
.logo-bulb-b{width:9px;height:3px;margin:-1px auto 0;background:linear-gradient(90deg,#aaa,#ddd,#aaa);border-radius:0 0 3px 3px;}
.logo-book{position:relative;width:38px;height:26px;z-index:1;}
.logo-pg-l{position:absolute;left:0;top:1px;width:18px;height:24px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:2px 0 0 3px;transform:perspective(50px) rotateY(10deg);transform-origin:right center;box-shadow:-1px 1px 4px rgba(0,0,0,0.1);}
.logo-pg-l::before{content:'';position:absolute;top:4px;left:3px;right:4px;height:1.5px;background:rgba(180,130,20,0.2);border-radius:1px;box-shadow:0 4px 0 rgba(180,130,20,0.15),0 8px 0 rgba(180,130,20,0.1);}
.logo-pg-r{position:absolute;right:0;top:1px;width:18px;height:24px;background:linear-gradient(225deg,#fffbeb,#fef3c7);border-radius:0 2px 3px 0;transform:perspective(50px) rotateY(-10deg);transform-origin:left center;box-shadow:1px 1px 4px rgba(0,0,0,0.08);}
.logo-pg-r::before{content:'';position:absolute;top:4px;left:4px;right:3px;height:1.5px;background:rgba(180,130,20,0.2);border-radius:1px;box-shadow:0 4px 0 rgba(180,130,20,0.15),0 8px 0 rgba(180,130,20,0.1);}
.logo-spine{position:absolute;left:50%;top:0;transform:translateX(-50%);width:3px;height:25px;background:linear-gradient(180deg,#b45309,#92400e);border-radius:1.5px;}
.logo-sb{font-family:'Baloo 2',sans-serif;font-size:10px;font-weight:800;color:rgba(255,255,255,0.85);letter-spacing:2px;z-index:1;margin-top:1px;}
.logo-ring{position:absolute;inset:-4px;border-radius:50%;border:2.5px solid transparent;border-top-color:rgba(255,255,255,0.35);border-right-color:rgba(245,197,66,0.3);animation:logoSpin 4s linear infinite;}
@keyframes logoSpin{to{transform:rotate(360deg);}}
.logo-star{position:absolute;z-index:3;animation:starPulse 2s ease-in-out infinite;}
.logo-star-1{top:4px;right:8px;}.logo-star-2{top:14px;left:6px;animation-delay:0.6s;}.logo-star-3{bottom:18px;right:4px;animation-delay:1.2s;}
@keyframes starPulse{0%,100%{transform:scale(1);opacity:0.7;}50%{transform:scale(1.25);opacity:1;}}
.logo-dot{position:absolute;border-radius:50%;z-index:3;animation:dotBob 3s ease-in-out infinite;}
.logo-dot-1{width:5px;height:5px;background:#e87bb0;top:20px;right:1px;}.logo-dot-2{width:4px;height:4px;background:#5b9cf5;bottom:12px;left:4px;animation-delay:1s;}.logo-dot-3{width:3px;height:3px;background:#43d9ad;top:42px;right:-1px;animation-delay:2s;}
@keyframes dotBob{0%,100%{transform:translateY(0);}50%{transform:translateY(-4px);}}

.logo-mini{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,#7c5ce0,#9b78f0,#e87bb0);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;box-shadow:0 3px 10px rgba(124,92,224,0.3);}
.logo-mini::before{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,0.2),transparent);border-radius:12px 12px 0 0;}
.logo-mini-inner{font-family:'Baloo 2',sans-serif;font-size:14px;font-weight:800;color:#fff;z-index:1;text-shadow:0 1px 3px rgba(0,0,0,0.15);}

.splash-title{font-family:'Baloo 2',sans-serif;font-size:38px;font-weight:800;color:#fff;margin-bottom:6px;letter-spacing:-0.02em;text-shadow:0 4px 20px rgba(0,0,0,0.15);opacity:0;animation:fadeSlide 0.7s var(--smooth) 1.1s forwards;}
.splash-tagline{font-size:14px;color:rgba(255,255,255,0.75);text-align:center;line-height:1.6;max-width:260px;opacity:0;animation:fadeSlide 0.7s var(--smooth) 1.3s forwards;}
@keyframes fadeSlide{0%{opacity:0;transform:translateY(16px);}100%{opacity:1;transform:translateY(0);}}
.splash-loader{margin-top:40px;width:140px;height:4px;border-radius:4px;background:rgba(255,255,255,0.12);overflow:hidden;opacity:0;animation:fadeSlide 0.5s var(--smooth) 1.6s forwards;}
.splash-loader-fill{height:100%;width:0%;border-radius:4px;background:linear-gradient(90deg,#43d9ad,#f09cc8,#9b85f0,#5b9cf5);background-size:200% 100%;animation:loaderFill 2s ease 1.8s forwards,loaderShimmer 1s ease infinite;}
@keyframes loaderFill{0%{width:0%;}100%{width:100%;}}
@keyframes loaderShimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.splash-ready{position:absolute;bottom:60px;font-size:12px;font-weight:700;color:rgba(255,255,255,0.4);letter-spacing:0.1em;text-transform:uppercase;opacity:0;animation:fadeSlide 0.5s var(--smooth) 2s forwards;}
#splash.exit{animation:splashOut 0.8s ease forwards;}
#splash.exit .splash-logo-wrap{animation:splashLogoOut 0.5s var(--smooth) forwards;}
@keyframes splashOut{0%{opacity:1;}100%{opacity:0;pointer-events:none;}}
@keyframes splashLogoOut{0%{opacity:1;transform:scale(1);}100%{opacity:0;transform:scale(0.8) translateY(-30px);}}

.particle{position:fixed;border-radius:50%;pointer-events:none;z-index:99998;will-change:transform,opacity;animation:particleFly 1s ease-out forwards;}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0);}}

/* Screens */
.screen{display:none;flex-direction:column;flex:1;overflow:hidden;position:relative;z-index:1;will-change:transform,opacity;}
.screen.active{display:flex;}
.screen.entering{animation:scrIn 0.5s var(--smooth) forwards;}
.screen.exiting{animation:scrOut 0.35s var(--smooth) forwards;pointer-events:none;}
.screen.entering-left{animation:scrInL 0.5s var(--smooth) forwards;}
.screen.entering-right{animation:scrInR 0.5s var(--smooth) forwards;}
.screen.exiting-left{animation:scrOutL 0.35s var(--smooth) forwards;pointer-events:none;}
.screen.exiting-right{animation:scrOutR 0.35s var(--smooth) forwards;pointer-events:none;}
.screen.entering-up{animation:scrInU 0.5s var(--smooth) forwards;}
.screen.exiting-down{animation:scrOutD 0.35s var(--smooth) forwards;pointer-events:none;}
@keyframes scrIn{0%{opacity:0;transform:translateY(20px) scale(0.97);}100%{opacity:1;transform:none;}}
@keyframes scrOut{0%{opacity:1;transform:none;}100%{opacity:0;transform:translateY(-14px) scale(0.98);}}
@keyframes scrInL{0%{opacity:0;transform:translateX(45px) scale(0.97);}100%{opacity:1;transform:none;}}
@keyframes scrInR{0%{opacity:0;transform:translateX(-45px) scale(0.97);}100%{opacity:1;transform:none;}}
@keyframes scrOutL{0%{opacity:1;transform:none;}100%{opacity:0;transform:translateX(-28px) scale(0.98);}}
@keyframes scrOutR{0%{opacity:1;transform:none;}100%{opacity:0;transform:translateX(28px) scale(0.98);}}
@keyframes scrInU{0%{opacity:0;transform:translateY(50px) scale(0.96);}100%{opacity:1;transform:none;}}
@keyframes scrOutD{0%{opacity:1;transform:none;}100%{opacity:0;transform:translateY(35px) scale(0.97);}}

#app{height:100dvh;display:flex;flex-direction:column;max-width:480px;margin:0 auto;position:relative;}
.scroll-body{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}

/* Topbar */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 12px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(24px) saturate(1.6);-webkit-backdrop-filter:blur(24px) saturate(1.6);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;transition:background var(--transition);}
.topbar-logo-wrap{display:flex;align-items:center;gap:10px;}
.topbar-logo{font-family:'Baloo 2',sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--purple),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.topbar-title{font-size:17px;font-weight:800;color:var(--text);}
.back-btn{width:40px;height:40px;border-radius:var(--r-sm);background:var(--surface);backdrop-filter:blur(12px);border:1.5px solid var(--border);color:var(--text2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.25s var(--smooth);flex-shrink:0;box-shadow:0 2px 10px var(--shadow);}
.back-btn:hover{background:var(--card-hover);color:var(--text);transform:scale(1.05);}

/* Bottom Nav */
.bottom-nav{display:flex;margin:0 14px 12px;padding:6px 6px;border-radius:var(--r-pill);background:var(--surface);backdrop-filter:blur(24px) saturate(1.6);border:1.5px solid var(--border);box-shadow:0 8px 32px var(--shadow2);flex-shrink:0;}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;cursor:pointer;transition:all 0.4s var(--smooth);border-radius:var(--r-pill);position:relative;margin:2px;}
.nav-icon{font-size:20px;transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);}
.nav-label{font-size:9px;font-weight:800;letter-spacing:0.03em;color:var(--text3);transition:all 0.35s var(--smooth);}
.nav-item.active{background:linear-gradient(135deg,var(--purple),var(--purple-d));box-shadow:0 4px 16px var(--shadow-c);}
.nav-item.active .nav-icon{transform:scale(1.15) translateY(-1px);filter:brightness(10);}
.nav-item.active .nav-label{color:#fff;font-weight:900;}

/* Buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 26px;border-radius:var(--r-pill);font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;border:none;transition:all 0.3s var(--smooth);white-space:nowrap;}
.btn-primary{background:linear-gradient(135deg,var(--purple),#9060e8,var(--pink));color:#fff;box-shadow:0 6px 24px var(--shadow-c);}
.btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 36px rgba(124,92,224,0.4);}
.btn-primary:active{transform:translateY(1px) scale(0.98);}
.btn-mint{background:linear-gradient(135deg,#43d9ad,#38c99d);color:#fff;box-shadow:0 6px 20px rgba(67,217,173,0.3);}
.btn-mint:hover{transform:translateY(-3px);}
.btn-secondary{background:var(--surface);backdrop-filter:blur(12px);border:1.5px solid var(--border2);color:var(--text);font-weight:700;box-shadow:0 2px 10px var(--shadow);}
.btn-secondary:hover{background:var(--card-hover);transform:translateY(-2px);}
.btn-ghost{background:transparent;color:var(--text2);padding:10px 16px;border-radius:var(--r-pill);}
.btn-ghost:hover{color:var(--text);background:var(--surface3);}
.btn-danger{background:var(--red-soft);border:1.5px solid rgba(240,96,96,0.3);color:var(--red);border-radius:var(--r-pill);}
.btn-full{width:100%;}
.btn-sm{padding:10px 18px;font-size:13px;}
.btn-xs{padding:7px 14px;font-size:11px;}

/* Google sign in button */
.btn-google{background:#fff;color:#333;border:1.5px solid #ddd;padding:14px 24px;font-size:15px;font-weight:700;box-shadow:0 4px 16px rgba(0,0,0,0.1);display:flex;align-items:center;gap:12px;}
.btn-google:hover{transform:translateY(-3px);box-shadow:0 8px 28px rgba(0,0,0,0.15);}
.btn-google img{width:22px;height:22px;}

/* Forms */
.form-input{width:100%;padding:14px 18px;background:var(--surface);backdrop-filter:blur(12px);border:1.5px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Nunito',sans-serif;font-size:15px;font-weight:600;outline:none;transition:all 0.3s var(--smooth);box-shadow:0 2px 10px var(--shadow);}
.form-input:focus{border-color:var(--purple-l);box-shadow:0 0 0 4px rgba(124,92,224,0.12),0 4px 16px var(--shadow);}
.form-input::placeholder{color:var(--text3);}
textarea.form-input{resize:none;line-height:1.7;}
select.form-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239488b8' stroke-width='3' stroke-linecap='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center;}
.pill{padding:4px 14px;border-radius:var(--r-pill);font-size:11px;font-weight:700;background:var(--surface2);border:1px solid var(--border);color:var(--text2);}
.section-label{font-size:11px;font-weight:900;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:12px;}
.form-group{margin-bottom:20px;}
.form-label{font-size:12px;font-weight:900;color:var(--text2);margin-bottom:8px;display:block;letter-spacing:0.06em;text-transform:uppercase;}

/* Toast */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface);backdrop-filter:blur(24px);border:1.5px solid var(--border2);border-radius:var(--r-pill);padding:14px 24px;font-size:14px;font-weight:700;z-index:9990;opacity:0;transition:all 0.45s var(--smooth);white-space:nowrap;pointer-events:none;max-width:90vw;text-align:center;box-shadow:0 8px 32px var(--shadow2);color:var(--text);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* Achievement popup */
.ach-popup{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120px);background:var(--surface);backdrop-filter:blur(24px);border:2px solid var(--yellow);border-radius:var(--r-lg);padding:16px 22px;z-index:9991;opacity:0;transition:all 0.6s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;gap:14px;max-width:340px;box-shadow:0 8px 40px rgba(245,197,66,0.25);}
.ach-popup.show{opacity:1;transform:translateX(-50%) translateY(0);}
.ach-pop-icon{font-size:36px;}
.ach-pop-text h4{font-size:10px;font-weight:900;color:var(--yellow);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:3px;}
.ach-pop-text p{font-size:14px;font-weight:800;color:var(--text);}

/* Theme toggle */
.theme-toggle{width:44px;height:26px;border-radius:13px;background:var(--surface2);border:1.5px solid var(--border);cursor:pointer;position:relative;transition:all 0.4s var(--smooth);flex-shrink:0;}
.theme-toggle-knob{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--yellow),var(--orange));position:absolute;top:2px;left:2px;transition:all 0.45s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;justify-content:center;font-size:11px;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
[data-theme="dark"] .theme-toggle-knob{left:20px;background:linear-gradient(135deg,#6366f1,#8b5cf6);}

/* Modal */
.modal-overlay{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.35);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:all 0.4s var(--smooth);}
.modal-overlay.show{opacity:1;pointer-events:auto;}
.modal-content{background:var(--surface);backdrop-filter:blur(24px);border:1.5px solid var(--border);border-radius:var(--r-xl);padding:24px;width:calc(100% - 40px);max-width:440px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px var(--shadow2);transform:translateY(40px) scale(0.92);transition:all 0.5s cubic-bezier(0.34,1.56,0.64,1);}
.modal-overlay.show .modal-content{transform:translateY(0) scale(1);}
.modal-title{font-family:'Baloo 2',sans-serif;font-size:22px;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:8px;color:var(--text);}
.modal-subtitle{font-size:12px;color:var(--text2);margin-bottom:18px;}
.modal-close{position:absolute;top:16px;right:16px;width:30px;height:30px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--text3);transition:all 0.25s var(--smooth);}
.modal-close:hover{background:var(--red-soft);color:var(--red);transform:scale(1.1);}

/* Welcome/Auth */
.welcome-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:36px 24px;text-align:center;}
.welcome-logo-text{font-family:'Baloo 2',sans-serif;font-size:42px;font-weight:800;background:linear-gradient(135deg,var(--purple-d),var(--purple),var(--pink),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px;animation:fadeUp 0.7s var(--smooth) both;}
.welcome-sub{font-size:15px;color:var(--text2);margin-bottom:36px;line-height:1.6;animation:fadeUp 0.7s var(--smooth) 0.1s both;}
.welcome-features{display:flex;flex-direction:column;gap:10px;width:100%;margin-bottom:32px;animation:fadeUp 0.7s var(--smooth) 0.2s both;}
.wf{display:flex;align-items:center;gap:14px;padding:15px 18px;background:var(--card);backdrop-filter:blur(16px);border:1.5px solid var(--border);border-radius:var(--r);text-align:left;transition:all 0.3s var(--smooth);box-shadow:0 4px 16px var(--shadow);}
.wf:hover{border-color:var(--purple-l);transform:translateX(4px);}
.wf-icon{font-size:28px;flex-shrink:0;}
.wf-text h4{font-size:14px;font-weight:800;margin-bottom:1px;color:var(--text);}
.wf-text p{font-size:12px;color:var(--text2);}
.welcome-cta{width:100%;animation:fadeUp 0.7s var(--smooth) 0.3s both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:translateY(0);}}

/* Setup */
.setup-body{padding:24px 20px;}
.setup-h{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:700;margin-bottom:6px;}
.setup-sub{font-size:14px;color:var(--text2);margin-bottom:24px;}
.avatar-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.av-opt{aspect-ratio:1;background:var(--card);backdrop-filter:blur(12px);border:2.5px solid var(--border);border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 2px 8px var(--shadow);position:relative;}
.av-opt.sel{border-color:var(--purple);background:var(--purple-g);box-shadow:0 4px 16px var(--shadow-c);transform:scale(1.1);}
.av-opt.sel::after{content:'\2713';position:absolute;bottom:2px;right:4px;font-size:12px;color:var(--purple);font-weight:900;}
.grade-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.grade-opt{padding:12px 6px;background:var(--card);backdrop-filter:blur(12px);border:1.5px solid var(--border);border-radius:var(--r-sm);text-align:center;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s var(--smooth);color:var(--text2);box-shadow:0 2px 8px var(--shadow);}
.grade-opt.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple);}

/* Quiz */
.quiz-header{padding:14px 18px 12px;flex-shrink:0;}
.quiz-prog-bar{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin-bottom:8px;}
.quiz-prog-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--pink),var(--mint));border-radius:5px;transition:width 0.6s var(--smooth);}
.quiz-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--text3);font-weight:700;}
.quiz-body{flex:1;overflow-y:auto;padding:20px;}
.quiz-scenario{background:linear-gradient(135deg,rgba(124,92,224,0.15),rgba(232,123,176,0.1));backdrop-filter:blur(12px);border:1.5px solid rgba(124,92,224,0.2);border-radius:var(--r-lg);padding:18px;margin-bottom:20px;}
.quiz-scenario .scenario-label{font-size:10px;font-weight:900;color:var(--purple);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px;}
.quiz-qtext{font-family:'Baloo 2',sans-serif;font-size:20px;font-weight:700;line-height:1.35;margin-bottom:18px;}
.quiz-opts{display:flex;flex-direction:column;gap:9px;}
.quiz-opt{padding:14px 16px;background:var(--card);backdrop-filter:blur(12px);border:1.5px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:12px;font-size:13px;font-weight:700;color:var(--text2);box-shadow:0 2px 10px var(--shadow);}
.quiz-opt:hover{border-color:var(--border2);color:var(--text);transform:translateX(4px);}
.quiz-opt.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple);transform:translateX(6px);}
.quiz-dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--border2);flex-shrink:0;transition:all 0.3s var(--smooth);display:flex;align-items:center;justify-content:center;font-size:11px;}
.quiz-opt.sel .quiz-dot{border-color:var(--purple);background:var(--purple);color:#fff;transform:scale(1.1);}
.quiz-footer{padding:10px 18px 14px;flex-shrink:0;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--glass);backdrop-filter:blur(16px);}

/* Results */
.results-hero{padding:28px 20px 0;text-align:center;}
.results-bigicon{font-size:64px;margin-bottom:12px;display:block;animation:pop 0.6s cubic-bezier(0.34,1.56,0.64,1) both;}
.results-h{font-family:'Baloo 2',sans-serif;font-size:30px;font-weight:800;margin-bottom:6px;}
.results-sub{font-size:13px;color:var(--text2);margin-bottom:20px;}
.results-body{padding:0 18px 20px;}
.result-card{padding:16px;border-radius:var(--r);margin-bottom:10px;display:flex;align-items:center;gap:12px;border:2px solid;cursor:pointer;transition:all 0.3s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(12px);box-shadow:0 4px 16px var(--shadow);}
.result-card:hover{transform:translateX(6px);}
.result-rank{font-family:'Baloo 2',sans-serif;font-size:30px;font-weight:800;flex-shrink:0;width:42px;text-align:center;}
.result-info h4{font-size:14px;font-weight:800;margin-bottom:3px;}
.result-info p{font-size:11px;opacity:0.7;line-height:1.4;}
.result-pct-wrap{margin-left:auto;text-align:right;flex-shrink:0;}
.result-pct{font-family:'Baloo 2',sans-serif;font-size:26px;font-weight:800;line-height:1;}
.result-pct-label{font-size:9px;font-weight:700;opacity:0.6;text-transform:uppercase;}
.result-bar-bg{position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(0,0,0,0.08);}
.result-bar-fill{height:100%;border-radius:0 4px 0 0;transition:width 1.2s var(--smooth);}
@keyframes pop{from{transform:scale(0) rotate(-20deg);opacity:0;}to{transform:none;opacity:1;}}

/* Home */
.home-scroll{padding:16px 16px 20px;}
.greeting{margin-bottom:18px;}
.greeting-hi{font-size:14px;color:var(--text2);font-weight:600;}
.greeting-name{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;}
.xp-card{background:var(--card);backdrop-filter:blur(20px);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px 20px;margin-bottom:14px;display:flex;gap:14px;align-items:center;box-shadow:0 4px 20px var(--shadow);}
.xp-icon{font-size:34px;}.xp-info{flex:1;}
.xp-lbl{font-size:12px;color:var(--text2);font-weight:700;margin-bottom:6px;display:flex;justify-content:space-between;}
.xp-track{height:12px;background:var(--surface3);border-radius:6px;overflow:hidden;}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--pink),var(--mint));border-radius:6px;transition:width 1s var(--smooth);}
.streak-card{background:var(--card);backdrop-filter:blur(20px);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:14px 16px;margin-bottom:14px;display:flex;gap:12px;align-items:center;box-shadow:0 4px 20px var(--shadow);}
.streak-days{display:flex;gap:5px;flex:1;}
.sday{flex:1;aspect-ratio:1;border-radius:12px;background:var(--surface2);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:9px;font-weight:800;color:var(--text3);transition:all 0.3s var(--smooth);}
.sday.done{background:var(--purple-g);color:var(--purple);}
.sday.today{background:linear-gradient(135deg,var(--purple),var(--pink));color:#fff;}
.sday-dot{width:5px;height:5px;border-radius:50%;background:currentColor;opacity:0.7;}
.streak-stat{text-align:center;}
.streak-num{font-family:'Baloo 2',sans-serif;font-size:34px;font-weight:800;color:var(--orange);line-height:1;}
.streak-lbl{font-size:9px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;}
.tech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px;}
.tc{background:var(--card);backdrop-filter:blur(16px);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px 16px;cursor:pointer;transition:all 0.35s var(--smooth);position:relative;overflow:hidden;box-shadow:0 4px 16px var(--shadow);}
.tc:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 12px 36px var(--shadow2);}
.tc-icon{font-size:34px;margin-bottom:10px;display:block;}
.tc-name{font-size:14px;font-weight:800;margin-bottom:4px;}
.tc-desc{font-size:11px;color:var(--text2);line-height:1.4;}
.tc-badge{position:absolute;top:12px;right:12px;font-size:9px;font-weight:900;padding:4px 10px;border-radius:var(--r-pill);text-transform:uppercase;}
.tc-best{background:linear-gradient(135deg,var(--yellow),var(--orange));color:#fff;}
.tc-match{background:var(--surface2);color:var(--text3);border:1px solid var(--border);}
.tip-card{background:linear-gradient(135deg,rgba(124,92,224,0.12),rgba(67,217,173,0.1));backdrop-filter:blur(12px);border:1.5px solid rgba(124,92,224,0.15);border-radius:var(--r-lg);padding:18px 20px;margin-bottom:16px;box-shadow:0 4px 16px var(--shadow);}
.tip-card p{font-size:13px;color:var(--text2);line-height:1.7;}

/* Study List */
.tech-list-item{display:flex;align-items:center;gap:14px;padding:16px 18px;background:var(--card);backdrop-filter:blur(16px);border:1.5px solid var(--border);border-radius:var(--r-lg);cursor:pointer;transition:all 0.3s var(--smooth);margin-bottom:10px;box-shadow:0 4px 16px var(--shadow);}
.tech-list-item:hover{border-color:var(--purple-l);transform:translateX(6px);}
.tli-icon{font-size:34px;flex-shrink:0;}.tli-info{flex:1;}.tli-name{font-size:15px;font-weight:800;margin-bottom:3px;}.tli-desc{font-size:12px;color:var(--text2);}
.tli-match{margin-top:6px;display:inline-flex;align-items:center;gap:4px;padding:4px 12px;border-radius:var(--r-pill);font-size:10px;font-weight:800;}

/* ══ COMMUNITY / SHARED REVIEWERS ══ */
.shared-card{background:var(--card);backdrop-filter:blur(16px);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px;margin-bottom:12px;box-shadow:0 4px 16px var(--shadow);transition:all 0.3s var(--smooth);cursor:pointer;}
.shared-card:hover{transform:translateY(-3px);box-shadow:0 8px 28px var(--shadow2);}
.shared-card-header{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.shared-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.shared-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.shared-user-info{flex:1;}
.shared-username{font-size:14px;font-weight:800;color:var(--text);}
.shared-time{font-size:11px;color:var(--text3);}
.shared-card-body h4{font-size:16px;font-weight:800;margin-bottom:4px;}
.shared-card-body p{font-size:12px;color:var(--text2);line-height:1.5;margin-bottom:8px;}
.shared-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.shared-tag{padding:3px 10px;border-radius:var(--r-pill);font-size:10px;font-weight:700;background:var(--purple-g);color:var(--purple);border:1px solid rgba(124,92,224,0.2);}
.shared-stats{display:flex;gap:16px;font-size:11px;font-weight:700;color:var(--text3);}
.shared-stat{display:flex;align-items:center;gap:4px;cursor:pointer;transition:color 0.2s;}
.shared-stat:hover{color:var(--purple);}
.shared-stat.liked{color:var(--pink);}

/* Comment section */
.comment-section{border-top:1px solid var(--border);padding-top:14px;margin-top:10px;}
.comment-item{display:flex;gap:10px;margin-bottom:12px;padding:10px;background:var(--surface);border-radius:var(--r-sm);border:1px solid var(--border);}
.comment-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--mint),var(--blue));display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;overflow:hidden;}
.comment-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.comment-body{flex:1;}
.comment-user{font-size:12px;font-weight:800;margin-bottom:2px;}
.comment-text{font-size:12px;color:var(--text2);line-height:1.5;}
.comment-time{font-size:10px;color:var(--text3);margin-top:3px;}
.comment-input-wrap{display:flex;gap:8px;align-items:center;margin-top:10px;}
.comment-input{flex:1;padding:10px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-pill);font-family:'Nunito',sans-serif;font-size:13px;font-weight:600;color:var(--text);outline:none;}
.comment-input:focus{border-color:var(--purple-l);}
.comment-send{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--pink));color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:transform 0.2s;flex-shrink:0;}
.comment-send:hover{transform:scale(1.1);}

/* Share modal */
.share-type-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px;}
.share-type{padding:14px 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);text-align:center;cursor:pointer;transition:all 0.3s var(--smooth);}
.share-type:hover{border-color:var(--purple-l);}
.share-type.sel{border-color:var(--purple);background:var(--purple-g);}
.share-type-icon{font-size:28px;display:block;margin-bottom:6px;}
.share-type-name{font-size:12px;font-weight:800;}

/* Profile card in community */
.profile-bar{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card);backdrop-filter:blur(16px);border:1.5px solid var(--border);border-radius:var(--r-lg);margin-bottom:14px;box-shadow:0 4px 16px var(--shadow);}
.profile-bar-avatar{width:44px;height:44px;border-radius:50%;overflow:hidden;border:2px solid var(--purple);flex-shrink:0;}
.profile-bar-avatar img{width:100%;height:100%;object-fit:cover;}
.profile-bar-info{flex:1;}
.profile-bar-name{font-size:15px;font-weight:800;}
.profile-bar-email{font-size:11px;color:var(--text3);}
.profile-bar-actions{display:flex;gap:6px;}

/* Search bar */
.search-bar{display:flex;gap:8px;margin-bottom:14px;}
.search-input{flex:1;padding:12px 18px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-pill);font-family:'Nunito',sans-serif;font-size:14px;font-weight:600;color:var(--text);outline:none;}
.search-input:focus{border-color:var(--purple-l);}
.search-filter{padding:12px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-pill);font-size:13px;font-weight:700;color:var(--text2);cursor:pointer;}

/* Online indicator */
.online-dot{width:8px;height:8px;border-radius:50%;background:#43d9ad;display:inline-block;margin-right:4px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

/* Spinner overlay */
.loading-overlay{position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
.spinner{width:20px;height:20px;border:2.5px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;}
.spinner-lg{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* Flashcard study */
.fc-tabs{display:flex;gap:0;flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);}
.fc-tab{flex:1;padding:12px 8px;text-align:center;font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.35s var(--smooth);border-bottom:3px solid transparent;}
.fc-tab.active{color:var(--purple);border-bottom-color:var(--purple);}
.fc-section{display:none;padding:16px;flex:1;overflow-y:auto;}
.fc-section.active{display:block;}
.deck-card{background:var(--card);backdrop-filter:blur(12px);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:12px;box-shadow:0 4px 16px var(--shadow);}
.deck-card:hover{border-color:var(--purple-l);transform:translateX(4px);}
.deck-dot{width:14px;height:14px;border-radius:6px;flex-shrink:0;}.deck-info h4{font-size:15px;font-weight:800;margin-bottom:2px;}.deck-info p{font-size:11px;color:var(--text2);}.deck-count{margin-left:auto;font-size:13px;font-weight:800;color:var(--text3);}
.create-deck-form{background:var(--card);backdrop-filter:blur(16px);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;margin-bottom:14px;box-shadow:0 4px 16px var(--shadow);}
.create-deck-form h4{font-size:14px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.color-picker{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.color-swatch{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 2px 8px var(--shadow);}
.color-swatch.sel{border-color:#fff;transform:scale(1.25);}
.fc-scene{perspective:1000px;height:220px;cursor:pointer;margin-bottom:16px;}
.fc-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 0.7s var(--smooth);}
.fc-inner.flipped{transform:rotateY(180deg);}
.fc-face{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;background:var(--card);backdrop-filter:blur(16px);border:2px solid var(--border);border-radius:var(--r-lg);display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column;gap:8px;box-shadow:0 8px 32px var(--shadow);}
.fc-back-face{transform:rotateY(180deg);background:linear-gradient(135deg,var(--surface),var(--surface2));}
.fc-face-label{font-size:10px;font-weight:900;color:var(--text3);letter-spacing:0.12em;text-transform:uppercase;}
.fc-face-text{font-size:18px;font-weight:800;text-align:center;line-height:1.4;}
.fc-face-hint{font-size:11px;color:var(--text3);margin-top:4px;}
.fc-rate-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.fc-rate{padding:12px 6px;border-radius:var(--r-sm);font-size:12px;font-weight:800;cursor:pointer;border:1.5px solid;transition:all 0.25s var(--smooth);text-align:center;}
.fc-again{background:var(--red-soft);border-color:rgba(240,96,96,0.3);color:var(--red);}
.fc-hard{background:var(--orange-soft);border-color:rgba(240,147,72,0.3);color:var(--orange);}
.fc-good{background:var(--green-soft);border-color:rgba(67,217,173,0.3);color:var(--green);}
.fc-rate:hover{transform:translateY(-3px);}
.ai-gen-box{background:linear-gradient(135deg,rgba(124,92,224,0.12),rgba(67,217,173,0.08));backdrop-filter:blur(12px);border:1.5px solid rgba(124,92,224,0.2);border-radius:var(--r-lg);padding:18px;margin-bottom:14px;}
.ai-gen-box h4{font-size:14px;font-weight:800;margin-bottom:4px;display:flex;align-items:center;gap:6px;}
.ai-gen-box p{font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.5;}
.upload-area{border:2px dashed var(--border2);border-radius:var(--r);padding:22px;text-align:center;cursor:pointer;transition:all 0.3s var(--smooth);background:var(--surface);margin-bottom:10px;}
.upload-area:hover{border-color:var(--purple-l);background:var(--purple-g);}
.upload-icon{font-size:36px;margin-bottom:8px;display:block;}.upload-text{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:4px;}.upload-hint{font-size:11px;color:var(--text3);}

/* Blurting */
.blurt-timer-big{font-family:'Baloo 2',sans-serif;font-size:52px;font-weight:800;color:var(--purple);text-align:center;margin:8px 0 12px;}
.phase-badge{display:inline-flex;align-items:center;gap:6px;padding:7px 18px;border-radius:var(--r-pill);font-size:12px;font-weight:800;margin-bottom:12px;}
.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.compare-box{background:var(--surface);backdrop-filter:blur(12px);border:1.5px solid var(--border);border-radius:var(--r);padding:12px;font-size:12px;line-height:1.6;color:var(--text2);min-height:90px;}
.compare-box h5{font-size:10px;font-weight:900;color:var(--text3);margin-bottom:8px;text-transform:uppercase;}

/* Feynman */
.feynman-steps{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px;background:var(--glass);}
.feynman-step{flex:1;padding:10px 6px;text-align:center;font-size:10px;font-weight:800;color:var(--text3);border-bottom:3px solid transparent;cursor:pointer;transition:all 0.35s var(--smooth);text-transform:uppercase;}
.feynman-step.active{color:var(--purple);border-bottom-color:var(--purple);}

/* Cornell */
.cornell-grid{display:grid;grid-template-columns:1fr 2fr;gap:10px;margin-bottom:10px;}
.cornell-lbl{font-size:10px;font-weight:900;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;}

/* RRR */
.rrr-btns{display:flex;gap:8px;margin-bottom:14px;}
.rrr-btn{flex:1;padding:12px 6px;border-radius:var(--r-pill);font-size:12px;font-weight:800;text-align:center;border:1.5px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text2);transition:all 0.3s var(--smooth);}
.rrr-btn.active{background:var(--purple-g);border-color:var(--purple);color:var(--purple);}

/* Whiteboard */
.wb-topbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);flex-wrap:wrap;}
.wb-colors{display:flex;gap:6px;align-items:center;}
.wb-color{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);flex-shrink:0;}
.wb-color.sel{border-color:#fff;transform:scale(1.3);}
.wb-sizes{display:flex;gap:4px;}
.wb-sz{width:32px;height:32px;border-radius:10px;background:var(--surface);border:1.5px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:var(--text2);}
.wb-sz.sel{border-color:var(--purple);color:var(--purple);background:var(--purple-g);}
.wb-tools{display:flex;gap:4px;}
.wb-tool{padding:7px 14px;border-radius:var(--r-pill);background:var(--surface);border:1.5px solid var(--border);cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);}
.wb-tool.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple);}
.wb-canvas-wrap{flex:1;position:relative;overflow:hidden;}
#wbCanvas{display:block;width:100%;height:100%;touch-action:none;}

/* Diagram */
.diag-toolbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);overflow-x:auto;}
.diag-color{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;flex-shrink:0;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);}
.diag-color.sel{border-color:#fff;transform:scale(1.3);}
.diag-add-input{flex:1;min-width:100px;padding:8px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;outline:none;}
.diag-canvas-wrap{flex:1;position:relative;overflow:hidden;background:var(--surface3);}
#diagCanvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}
.diag-nodes-layer{position:absolute;inset:0;}
.diag-node{position:absolute;padding:10px 16px;border-radius:var(--r-sm);font-size:13px;font-weight:800;cursor:move;border:2px solid;touch-action:none;box-shadow:0 4px 16px var(--shadow);max-width:200px;word-break:break-word;backdrop-filter:blur(10px);}
.diag-node.root{border-width:3px;font-size:14px;}
.diag-node-del{position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity 0.2s;}
.diag-node:hover .diag-node-del{opacity:1;}
.diag-bottom-bar{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:var(--glass);}

/* Schedule */
.sched-week{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:16px;}
.sched-day{aspect-ratio:0.9;border-radius:var(--r-sm);background:var(--surface);border:1.5px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:2px;}
.sched-dlbl{font-size:8px;font-weight:900;color:var(--text3);text-transform:uppercase;}
.sched-dnum{font-size:13px;font-weight:800;color:var(--text2);}
.sched-day.has{border-color:var(--purple);background:var(--purple-g);}
.sched-day.has .sched-dnum{color:var(--purple);}
.sched-day.rest{border-color:var(--teal);background:var(--teal-soft);}
.sched-day.today{border-color:var(--orange);box-shadow:0 4px 16px rgba(240,147,72,0.2);}
.sched-day.today .sched-dnum{color:var(--orange);}
.sess-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);margin-bottom:8px;box-shadow:0 2px 10px var(--shadow);}
.sess-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.sess-info h4{font-size:14px;font-weight:800;margin-bottom:2px;}
.sess-info p{font-size:11px;color:var(--text2);}
.sess-time{margin-left:auto;font-size:12px;font-weight:800;color:var(--text3);}
.timer-wrap{text-align:center;padding:20px 0;}
.timer-ring{width:170px;height:170px;border-radius:50%;background:var(--card);border:4px solid var(--border);margin:0 auto 14px;display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',sans-serif;font-size:42px;font-weight:800;color:var(--purple);box-shadow:0 8px 40px var(--shadow);}
.timer-ring.focus-mode{border-color:var(--purple);box-shadow:0 8px 48px var(--shadow-c);}
.timer-ring.break-mode{border-color:var(--mint);}
.timer-phase{font-size:14px;color:var(--text2);font-weight:700;margin-bottom:14px;}

/* Achievements */
.ach-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.ach-card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 14px;text-align:center;transition:all 0.3s var(--smooth);position:relative;overflow:hidden;}
.ach-card.unlocked:hover{transform:translateY(-4px);}
.ach-card.locked{opacity:0.35;}
.ach-icon{font-size:36px;display:block;margin-bottom:8px;}
.ach-name{font-size:13px;font-weight:800;margin-bottom:4px;}
.ach-desc{font-size:10px;color:var(--text2);line-height:1.4;margin-bottom:8px;}
.ach-rarity{font-size:9px;font-weight:900;padding:3px 10px;border-radius:var(--r-pill);text-transform:uppercase;display:inline-block;}
.r-common{background:var(--green-soft);color:var(--green);}
.r-rare{background:var(--blue-soft);color:var(--blue);}
.r-epic{background:rgba(155,120,240,0.15);color:#9b78f0;}
.r-legendary{background:var(--yellow-soft);color:var(--orange);}

.tech-body{padding:14px;flex:1;overflow-y:auto;}

/* Tab bar for community/shared */
.tab-bar{display:flex;border-bottom:1px solid var(--border);background:var(--glass);backdrop-filter:blur(16px);}
.tab-bar-item{flex:1;padding:12px;text-align:center;font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;border-bottom:3px solid transparent;transition:all 0.3s;}
.tab-bar-item.active{color:var(--purple);border-bottom-color:var(--purple);}

/* Time Picker */
.time-picker-wrap{display:flex;align-items:center;justify-content:center;gap:6px;margin:16px 0;}
.time-col{display:flex;flex-direction:column;align-items:center;gap:4px;}
.time-spin-btn{width:44px;height:34px;border-radius:var(--r-sm);background:var(--surface2);border:1.5px solid var(--border);color:var(--text2);font-size:18px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.time-display{width:56px;height:56px;border-radius:var(--r);background:var(--surface);border:2px solid var(--purple-l);display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;color:var(--purple);}
.time-sep{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;color:var(--text3);margin:0 2px;padding-top:20px;}
.time-ampm{display:flex;flex-direction:column;gap:4px;margin-left:8px;}
.ampm-btn{padding:6px 14px;border-radius:var(--r-sm);background:var(--surface2);border:1.5px solid var(--border);font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;}
.ampm-btn.active{background:var(--purple-g);border-color:var(--purple-l);color:var(--purple);}
.time-presets{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;justify-content:center;}
.time-preset{padding:6px 14px;border-radius:var(--r-pill);background:var(--surface2);border:1.5px solid var(--border);font-size:11px;font-weight:700;color:var(--text2);cursor:pointer;}
.time-preset:hover{border-color:var(--purple-l);color:var(--purple);background:var(--purple-g);}

/* Empty state */
.empty-state{text-align:center;padding:40px 20px;color:var(--text3);}
.empty-state .empty-icon{font-size:56px;margin-bottom:12px;display:block;}
.empty-state h3{font-size:16px;font-weight:800;color:var(--text);margin-bottom:6px;}
.empty-state p{font-size:13px;line-height:1.5;}
</style>
</head>
<body>

<div class="app-bg"><div class="bg-orb bg-orb-1"></div><div class="bg-orb bg-orb-2"></div><div class="bg-orb bg-orb-3"></div><div class="bg-orb bg-orb-4"></div></div>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-bg"></div>
  <div class="splash-particles" id="splash-particles"></div>
  <div class="splash-rings"><div class="splash-ring"></div><div class="splash-ring"></div><div class="splash-ring"></div><div class="splash-ring"></div></div>
  <div class="splash-logo-wrap">
    <div class="logo-mark">
      <div class="logo-ring"></div>
      <div class="logo-star logo-star-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="#f5c542"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 16.8l-6.2 4.5 2.4-7.4L2 9.4h7.6z"/></svg></div>
      <div class="logo-star logo-star-2"><svg width="10" height="10" viewBox="0 0 24 24" fill="#f09cc8"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 16.8l-6.2 4.5 2.4-7.4L2 9.4h7.6z"/></svg></div>
      <div class="logo-star logo-star-3"><svg width="8" height="8" viewBox="0 0 24 24" fill="#82b5f8"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 16.8l-6.2 4.5 2.4-7.4L2 9.4h7.6z"/></svg></div>
      <div class="logo-dot logo-dot-1"></div><div class="logo-dot logo-dot-2"></div><div class="logo-dot logo-dot-3"></div>
      <div class="logo-shield"><div class="logo-bulb"><div class="logo-bulb-g"></div><div class="logo-bulb-b"></div></div><div class="logo-book"><div class="logo-pg-l"></div><div class="logo-spine"></div><div class="logo-pg-r"></div></div><div class="logo-sb">SB</div></div>
    </div>
    <div class="splash-title">StudyBuddy</div>
    <div class="splash-tagline">Your social study companion.<br>Learn smarter, together.</div>
  </div>
  <div class="splash-loader"><div class="splash-loader-fill"></div></div>
  <div class="splash-ready">Connecting to cloud...</div>
</div>

<div id="app">

  <!-- AUTH / LOGIN SCREEN -->
  <div class="screen" id="screen-auth">
    <div class="welcome-content">
      <div class="logo-mark" style="margin-bottom:10px;transform:scale(0.75);animation:fadeUp 0.5s ease both;">
        <div class="logo-ring" style="animation:logoSpin 4s linear infinite;opacity:1;"></div>
        <div class="logo-star logo-star-1" style="opacity:1;"><svg width="12" height="12" viewBox="0 0 24 24" fill="#f5c542"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 16.8l-6.2 4.5 2.4-7.4L2 9.4h7.6z"/></svg></div>
        <div class="logo-dot logo-dot-1"></div><div class="logo-dot logo-dot-2"></div>
        <div class="logo-shield"><div class="logo-bulb"><div class="logo-bulb-g"></div><div class="logo-bulb-b"></div></div><div class="logo-book"><div class="logo-pg-l"></div><div class="logo-spine"></div><div class="logo-pg-r"></div></div><div class="logo-sb">SB</div></div>
      </div>
      <div class="welcome-logo-text">StudyBuddy</div>
      <div class="welcome-sub">Your social study companion.<br>Learn smarter, together.</div>
      <div class="welcome-features">
        <div class="wf"><span class="wf-icon">🧠</span><div class="wf-text"><h4>Personalized Assessment</h4><p>Find your best study style through scenarios</p></div></div>
        <div class="wf"><span class="wf-icon">🌐</span><div class="wf-text"><h4>Share & Discuss Reviewers</h4><p>Community-powered learning with comments</p></div></div>
        <div class="wf"><span class="wf-icon">🏆</span><div class="wf-text"><h4>Achievements & Streaks</h4><p>Earn rewards as you grow smarter</p></div></div>
      </div>
      <div class="welcome-cta">
        <button class="btn btn-google btn-full" onclick="signInWithGoogle()">
          <svg width="22" height="22" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Sign in with Google
        </button>
        <div style="margin-top:12px;font-size:11px;color:var(--text3);line-height:1.6;">Your data is synced securely via Google Cloud.<br>We only store your study progress.</div>
      </div>
    </div>
  </div>

  <!-- SETUP -->
  <div class="screen" id="screen-setup">
    <div class="topbar"><div class="topbar-logo-wrap"><div class="logo-mini"><div class="logo-mini-inner">SB</div></div><div class="topbar-logo">StudyBuddy</div></div><span style="font-size:12px;color:var(--text3);font-weight:700;">Profile Setup</span></div>
    <div class="scroll-body"><div class="setup-body">
      <div class="setup-h">Complete your profile</div>
      <div class="setup-sub">Pick an avatar and grade level</div>
      <div class="form-group"><label class="form-label">Display Name</label><input class="form-input" id="inp-name" type="text" placeholder="e.g. Maria Santos" maxlength="30"></div>
      <div class="form-group"><label class="form-label">Pick an Avatar</label><div class="avatar-grid" id="av-grid"></div></div>
      <div class="form-group"><label class="form-label">Grade Level</label><div class="grade-grid" id="gr-grid"></div></div>
      <button class="btn btn-primary btn-full" onclick="SFX.tap();saveProfile()" style="margin-top:8px;">Next: Take the Assessment</button>
    </div></div>
  </div>

  <!-- QUIZ -->
  <div class="screen" id="screen-quiz">
    <div class="quiz-header">
      <div style="display:flex;align-items:center;margin-bottom:10px;"><div class="topbar-logo-wrap"><div class="logo-mini"><div class="logo-mini-inner">SB</div></div><div class="topbar-logo" style="font-size:16px;">StudyBuddy</div></div><span style="font-size:12px;color:var(--text3);font-weight:700;margin-left:auto;">Assessment</span></div>
      <div class="quiz-prog-bar"><div class="quiz-prog-fill" id="q-prog" style="width:2%"></div></div>
      <div class="quiz-meta"><span id="q-num">Q1 / 50</span><span id="q-hint" style="color:var(--purple);">Results at Q50</span></div>
    </div>
    <div class="quiz-body" id="q-body"></div>
    <div class="quiz-footer"><button class="btn btn-secondary" onclick="SFX.tap();qPrev()" id="q-prev" style="width:80px;">Back</button><button class="btn btn-primary" onclick="SFX.tap();qNext()" id="q-next" style="flex:1;">Next</button></div>
  </div>

  <!-- RESULTS -->
  <div class="screen" id="screen-results">
    <div class="scroll-body"><div class="results-hero"><span class="results-bigicon">🎉</span><div class="results-h">Your Results Are In!</div><div class="results-sub" id="r-sub">Here is how your learning styles ranked</div></div><div class="results-body" id="r-body"></div><div style="padding:0 18px 24px;"><button class="btn btn-mint btn-full" onclick="SFX.success();goToHome()">Start Learning</button></div></div>
  </div>

  <!-- HOME -->
  <div class="screen" id="screen-home">
    <div class="topbar">
      <div class="topbar-logo-wrap"><div class="logo-mini"><div class="logo-mini-inner">SB</div></div><div class="topbar-logo">StudyBuddy</div></div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="theme-toggle" onclick="toggleTheme()"><div class="theme-toggle-knob" id="theme-knob">☀️</div></div>
        <div id="home-av-wrap" style="width:32px;height:32px;border-radius:50%;overflow:hidden;cursor:pointer;border:2px solid var(--purple);" onclick="switchNav('profile')"><span id="home-av" style="font-size:20px;display:flex;align-items:center;justify-content:center;height:100%;">🦊</span></div>
      </div>
    </div>
    <div class="scroll-body home-scroll" id="home-body"></div>
    <div class="bottom-nav" id="home-nav">
      <div class="nav-item active" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div>
      <div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div>
      <div class="nav-item" onclick="SFX.tap();switchNav('community')"><span class="nav-icon">🌐</span><span class="nav-label">Community</span></div>
      <div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div>
      <div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div>
    </div>
  </div>

  <!-- STUDY -->
  <div class="screen" id="screen-study">
    <div class="topbar"><div class="topbar-title">Study Tools</div></div>
    <div class="scroll-body" style="padding:14px;" id="study-list-body"></div>
    <div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('community')"><span class="nav-icon">🌐</span><span class="nav-label">Community</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div></div>
  </div>

  <!-- COMMUNITY -->
  <div class="screen" id="screen-community">
    <div class="topbar"><div class="topbar-title"><span class="online-dot"></span>Community</div><button class="btn btn-sm btn-primary" onclick="SFX.tap();showShareModal()">+ Share</button></div>
    <div class="tab-bar" id="community-tabs">
      <div class="tab-bar-item active" onclick="switchCommunityTab('feed',this)">🔥 Feed</div>
      <div class="tab-bar-item" onclick="switchCommunityTab('my',this)">📁 My Shares</div>
      <div class="tab-bar-item" onclick="switchCommunityTab('saved',this)">⭐ Saved</div>
    </div>
    <div class="scroll-body" style="padding:14px;" id="community-body"></div>
    <div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('community')"><span class="nav-icon">🌐</span><span class="nav-label">Community</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div></div>
  </div>

  <!-- REVIEWER DETAIL (shared reviewer view) -->
  <div class="screen" id="screen-reviewer">
    <div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title" id="reviewer-title">Reviewer</div><button class="btn btn-xs btn-secondary" onclick="SFX.tap();copyShareLink()" style="font-size:11px;">🔗 Copy Link</button></div>
    <div class="scroll-body" style="padding:14px;" id="reviewer-body"></div>
  </div>

  <!-- SCHEDULE -->
  <div class="screen" id="screen-schedule">
    <div class="topbar"><div class="topbar-title">My Schedule</div><button class="btn btn-sm btn-mint" onclick="SFX.tap();showAddSessionModal()">+ Add</button></div>
    <div class="scroll-body" style="padding:14px;" id="sched-body"><div class="section-label">This Week</div><div class="sched-week" id="sched-week"></div><div class="section-label" style="margin-top:14px;">Sessions</div><div id="sess-list"></div><div style="margin-top:10px;"><button class="btn btn-secondary btn-full" onclick="SFX.tap();toggleRest()">Toggle Rest Day Today</button></div><div class="section-label" style="margin-top:20px;">Pomodoro Timer</div><div class="timer-wrap"><div class="timer-ring" id="timer-ring">25:00</div><div class="timer-phase" id="timer-phase">Focus Session</div><div style="display:flex;gap:10px;justify-content:center;"><button class="btn btn-primary" onclick="SFX.tap();toggleTimer()" id="timer-btn">Start</button><button class="btn btn-secondary" onclick="SFX.tap();resetTimer()">Reset</button></div></div></div>
    <div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('community')"><span class="nav-icon">🌐</span><span class="nav-label">Community</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div></div>
  </div>

  <!-- ACHIEVEMENTS -->
  <div class="screen" id="screen-achievements">
    <div class="topbar"><div class="topbar-title">Achievements</div><span style="font-size:12px;color:var(--text2);font-weight:700;" id="ach-count">0/20</span></div>
    <div class="scroll-body" style="padding:14px;"><div class="ach-grid" id="ach-grid"></div></div>
    <div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('community')"><span class="nav-icon">🌐</span><span class="nav-label">Community</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div></div>
  </div>

  <!-- PROFILE -->
  <div class="screen" id="screen-profile">
    <div class="topbar"><div class="back-btn" onclick="SFX.tap();switchNav('home')">&#8592;</div><div class="topbar-title">My Profile</div></div>
    <div class="scroll-body" style="padding:14px;" id="profile-body"></div>
  </div>

  <!-- STUDY TECHNIQUE SCREENS -->
  <div class="screen" id="screen-flashcards"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Flashcards</div></div><div class="fc-tabs"><div class="fc-tab active" onclick="switchFcTab('decks',this)">Decks</div><div class="fc-tab" onclick="switchFcTab('create',this)">Create</div><div class="fc-tab" onclick="switchFcTab('ai',this)">AI Gen</div></div><div class="fc-section active" id="fc-decks"></div><div class="fc-section" id="fc-create"></div><div class="fc-section" id="fc-ai"></div><div class="fc-section" id="fc-study"></div></div>
  <div class="screen" id="screen-blurting"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Blurting</div></div><div class="scroll-body tech-body" id="blurt-body"></div></div>
  <div class="screen" id="screen-question"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Question Method</div></div><div class="scroll-body tech-body" id="cornell-body"></div></div>
  <div class="screen" id="screen-feynman"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Feynman Technique</div></div><div class="scroll-body tech-body" id="feynman-body"></div></div>
  <div class="screen" id="screen-rrr"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Read, Recite, Review</div></div><div class="scroll-body tech-body" id="rrr-body"></div></div>
  <div class="screen" id="screen-whiteboard"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Brain Dump</div></div><div class="wb-topbar" id="wb-toolbar"></div><div class="wb-canvas-wrap"><canvas id="wbCanvas"></canvas></div><div style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:var(--glass);"><button class="btn btn-secondary btn-sm" onclick="SFX.tap();wbClear()">Clear</button><button class="btn btn-mint btn-sm" onclick="SFX.tap();shareCurrentWork('whiteboard')">Share</button><button class="btn btn-primary btn-sm" style="flex:1;" onclick="SFX.tap();wbSave()">Save</button></div></div>
  <div class="screen" id="screen-diagram"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Active Diagramming</div></div><div class="diag-toolbar" id="diag-toolbar"></div><div class="diag-canvas-wrap" id="diag-wrap"><canvas id="diagCanvas"></canvas><div class="diag-nodes-layer" id="diag-nodes"></div></div><div class="diag-bottom-bar"><button class="btn btn-danger btn-sm" onclick="SFX.tap();diagClear()">Clear</button><button class="btn btn-secondary btn-sm" onclick="SFX.tap();diagConnect()">Connect</button><button class="btn btn-mint btn-sm" onclick="SFX.tap();shareCurrentWork('diagram')">Share</button><button class="btn btn-primary btn-sm" style="flex:1;" onclick="SFX.tap();diagSave()">Save</button></div></div>

  <!-- MODALS -->
  <div class="modal-overlay" id="session-modal"><div class="modal-content" style="position:relative;"><div class="modal-close" onclick="hideAddSessionModal()">x</div><div class="modal-title">New Study Session</div><div class="modal-subtitle">Plan your next study session</div><div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="modal-subject" placeholder="e.g. Biology Chapter 5"></div><div class="form-group"><label class="form-label">Technique</label><select class="form-input" id="modal-technique"><option value="flashcards">Flashcards</option><option value="blurting">Blurting</option><option value="question">Question Method</option><option value="feynman">Feynman Technique</option><option value="rrr">Read, Recite, Review</option><option value="whiteboard">Brain Dump</option><option value="diagram">Active Diagramming</option></select></div><div class="form-group"><label class="form-label">Duration (minutes)</label><input class="form-input" id="modal-duration" type="number" value="30" min="5" max="180"></div><div class="form-group"><label class="form-label">Time</label><div style="text-align:center;cursor:pointer;padding:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);font-weight:800;color:var(--purple);" onclick="showTimePicker()" id="modal-time-display">2:00 PM - Tap to change</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;"><button class="btn btn-secondary" onclick="hideAddSessionModal()">Cancel</button><button class="btn btn-mint" onclick="SFX.correct();confirmAddSession()">Add Session</button></div></div></div>

  <div class="modal-overlay" id="time-modal"><div class="modal-content" style="position:relative;"><div class="modal-close" onclick="hideTimePicker()">x</div><div class="modal-title">Set Time</div><div class="time-picker-wrap"><div class="time-col"><div class="time-spin-btn" onclick="spinTime('h',1)">&#9650;</div><div class="time-display" id="tp-hour">02</div><div class="time-spin-btn" onclick="spinTime('h',-1)">&#9660;</div></div><div class="time-sep">:</div><div class="time-col"><div class="time-spin-btn" onclick="spinTime('m',1)">&#9650;</div><div class="time-display" id="tp-min">00</div><div class="time-spin-btn" onclick="spinTime('m',-1)">&#9660;</div></div><div class="time-ampm"><div class="ampm-btn active" id="tp-pm-am" onclick="setAMPM('AM')">AM</div><div class="ampm-btn" id="tp-pm-pm" onclick="setAMPM('PM')">PM</div></div></div><div class="time-presets" id="time-presets"></div><button class="btn btn-primary btn-full" style="margin-top:16px;" onclick="confirmTimePick()">Confirm Time</button></div></div>

  <!-- SHARE MODAL -->
  <div class="modal-overlay" id="share-modal"><div class="modal-content" style="position:relative;"><div class="modal-close" onclick="hideShareModal()">x</div><div class="modal-title">📤 Share a Reviewer</div><div class="modal-subtitle">Share your study material with the community</div>
    <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="share-title" placeholder="e.g. Biology Chapter 5 - Cell Division"></div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="share-desc" rows="3" placeholder="What's this reviewer about?"></textarea></div>
    <div class="form-group"><label class="form-label">Type</label>
      <div class="share-type-grid" id="share-type-grid">
        <div class="share-type sel" onclick="selectShareType('flashcards',this)"><span class="share-type-icon">🃏</span><div class="share-type-name">Flashcards</div></div>
        <div class="share-type" onclick="selectShareType('notes',this)"><span class="share-type-icon">📝</span><div class="share-type-name">Notes</div></div>
        <div class="share-type" onclick="selectShareType('diagram',this)"><span class="share-type-icon">🗺️</span><div class="share-type-name">Diagram</div></div>
        <div class="share-type" onclick="selectShareType('quiz',this)"><span class="share-type-icon">❓</span><div class="share-type-name">Quiz</div></div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Content</label><textarea class="form-input" id="share-content" rows="6" placeholder="Paste your study content here... For flashcards use format: Question | Answer (one per line)"></textarea></div>
    <div class="form-group"><label class="form-label">Tags (comma separated)</label><input class="form-input" id="share-tags" placeholder="e.g. biology, cells, science"></div>
    <div class="form-group"><label class="form-label">Select Deck to Share (optional)</label><select class="form-input" id="share-deck-select"><option value="">-- None (use content above) --</option></select></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-secondary" onclick="hideShareModal()">Cancel</button><button class="btn btn-primary" onclick="publishReviewer()">🚀 Publish</button></div>
  </div></div>

  <div class="toast" id="toast"></div>
  <div class="ach-popup" id="ach-popup"><span class="ach-pop-icon" id="ap-icon">🏆</span><div class="ach-pop-text"><h4>Achievement Unlocked!</h4><p id="ap-name"></p></div></div>
</div>

<script>
// ═══════════ FIREBASE CONFIG ═══════════
// IMPORTANT: Replace with your own Firebase config from Firebase Console
var firebaseConfig = {
  apiKey:"AIzaSyCzn2gjw22hjWigy4o9QCR54WobJbmWoIY",
  authDomain: "studybuddy-b3246.firebaseapp.com",
  projectId: "studybuddy-b3246",
  storageBucket: "studybuddy-b3246.firebasestorage.app",
  messagingSenderId: "1085631070192s",
  appId: "1:1085631070192:web:8fdc94289b98e068836735"
};

var firebaseReady = false;
var db, auth, currentUser = null;

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  firebaseReady = true;
} catch(e) {
  console.warn('Firebase not configured. Running in offline/demo mode.', e);
}

// ═══════════ SPLASH ═══════════
(function(){var pc=document.getElementById('splash-particles');for(var i=0;i<20;i++){var p=document.createElement('div');p.className='splash-particle';var sz=4+Math.random()*12;p.style.width=sz+'px';p.style.height=sz+'px';p.style.left=Math.random()*100+'%';p.style.animationDuration=(4+Math.random()*6)+'s';p.style.animationDelay=Math.random()*4+'s';pc.appendChild(p);}})();

// ═══════════ SOUND ENGINE ═══════════
var SFX=(function(){var ctx=null;function getCtx(){if(!ctx)try{ctx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}return ctx;}function play(f,t,d,v){var c=getCtx();if(!c)return;try{var o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type=t||'sine';o.frequency.value=f;g.gain.setValueAtTime(v||0.12,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+(d||0.12));o.start(c.currentTime);o.stop(c.currentTime+(d||0.12)+0.1);}catch(e){}}function chord(f,t,d){f.forEach(function(x,i){setTimeout(function(){play(x,t,d,0.1);},i*50);});}return{tap:function(){play(520,'triangle',0.06,0.08);},select:function(){play(523,'sine',0.08,0.1);setTimeout(function(){play(659,'sine',0.08,0.08);},60);},correct:function(){chord([523,659,784],'sine',0.15);},success:function(){chord([523,659,784,1047],'sine',0.25);},flip:function(){play(660,'triangle',0.05,0.07);setTimeout(function(){play(880,'triangle',0.04,0.05);},50);},unlock:function(){play(784,'sine',0.12,0.12);setTimeout(function(){play(1047,'sine',0.15,0.15);},120);setTimeout(function(){play(1319,'sine',0.2,0.18);},250);},error:function(){play(200,'sawtooth',0.1,0.08);setTimeout(function(){play(180,'sawtooth',0.1,0.06);},80);},whoosh:function(){var c=getCtx();if(!c)return;try{var o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='sine';o.frequency.setValueAtTime(900,c.currentTime);o.frequency.exponentialRampToValueAtTime(200,c.currentTime+0.25);g.gain.setValueAtTime(0.08,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.25);o.start();o.stop(c.currentTime+0.25);}catch(e){}},timer:function(){chord([880,1108,1320],'sine',0.25);},navigate:function(){play(440,'triangle',0.06,0.06);setTimeout(function(){play(554,'triangle',0.06,0.05);},40);},pop:function(){play(880,'sine',0.04,0.06);},erase:function(){play(300,'triangle',0.08,0.05);},startup:function(){setTimeout(function(){play(392,'sine',0.15,0.08);},0);setTimeout(function(){play(523,'sine',0.15,0.08);},150);setTimeout(function(){play(659,'sine',0.15,0.08);},300);setTimeout(function(){play(784,'sine',0.2,0.1);},450);}};})();

function burst(x,y,colors,count){colors=colors||['#7c5ce0','#e87bb0','#f5c542','#43d9ad'];count=count||12;for(var i=0;i<count;i++){var p=document.createElement('div');p.className='particle';var a=(i/count)*360;var d=40+Math.random()*70;p.style.cssText='left:'+x+'px;top:'+y+'px;width:'+(4+Math.random()*8)+'px;height:'+(4+Math.random()*8)+'px;background:'+colors[i%colors.length]+';--tx:'+Math.cos(a*Math.PI/180)*d+'px;--ty:'+Math.sin(a*Math.PI/180)*d+'px;animation-duration:'+(0.6+Math.random()*0.4)+'s;';document.body.appendChild(p);setTimeout(function(el){el.remove();}.bind(null,p),1200);}}

// ═══════════ THEME ═══════════
var currentTheme=localStorage.getItem('sb-theme')||'light';
function applyTheme(){document.documentElement.setAttribute('data-theme',currentTheme);var k=document.getElementById('theme-knob');if(k)k.textContent=currentTheme==='dark'?'🌙':'☀️';}
function toggleTheme(){currentTheme=currentTheme==='light'?'dark':'light';localStorage.setItem('sb-theme',currentTheme);applyTheme();SFX.select();}
applyTheme();

// ═══════════ DATA ═══════════
var AVATARS=['🦊','🐼','🐸','🦁','🐺','🐻','🦋','🐬','🦄','🐙'];
var GRADES=['Grade 7','Grade 8','Grade 9','Grade 10','Grade 11','Grade 12','College'];
var DECK_COLORS=['#7c5ce0','#e87bb0','#f5c542','#43d9ad','#5b9cf5','#f09348','#38c9c9','#f06060'];
var TECHNIQUES=[
  {id:'flashcards',name:'Flashcards',icon:'🃏',cval:'#5b9cf5',soft:'var(--blue-soft)',screen:'screen-flashcards',desc:'Spaced repetition for rapid recall'},
  {id:'blurting',name:'Blurting',icon:'✍️',cval:'#e87bb0',soft:'var(--pink-soft)',screen:'screen-blurting',desc:'Active recall through free writing'},
  {id:'question',name:'Question Method',icon:'❓',cval:'#43d9ad',soft:'var(--green-soft)',screen:'screen-question',desc:'Cornell note-taking and self-quiz'},
  {id:'feynman',name:'Feynman Technique',icon:'🧑‍🏫',cval:'#f09348',soft:'var(--orange-soft)',screen:'screen-feynman',desc:'Learn by teaching simply'},
  {id:'rrr',name:'Read, Recite, Review',icon:'📖',cval:'#38c9c9',soft:'var(--teal-soft)',screen:'screen-rrr',desc:'Structured reading cycle'},
  {id:'whiteboard',name:'Brain Dump',icon:'🖊️',cval:'#f5c542',soft:'var(--yellow-soft)',screen:'screen-whiteboard',desc:'Free-form canvas drawing'},
  {id:'diagram',name:'Active Diagramming',icon:'🗺️',cval:'#7c5ce0',soft:'rgba(124,92,224,0.12)',screen:'screen-diagram',desc:'Mind maps and visual thinking'}
];
var TIPS=["Spaced repetition is 2-3x more effective than cramming.","The Feynman Technique reveals gaps instantly.","Rest days are not lazy days. Sleep consolidates memory.","Short sessions beat long marathons.","Sharing your notes helps you learn better too!","Discussing concepts with others deepens understanding."];
var ACHIEVEMENTS_DEF=[
  {key:'first_profile',icon:'👤',name:'Identity Found',desc:'Created your first profile',rarity:'common'},
  {key:'quiz_complete',icon:'🧠',name:'Self-Aware Learner',desc:'Completed the assessment',rarity:'common'},
  {key:'first_fc',icon:'🃏',name:'First Flip',desc:'Reviewed your first flashcard',rarity:'common'},
  {key:'first_blurt',icon:'✍️',name:'Brain Unlocked',desc:'Completed a Blurting session',rarity:'common'},
  {key:'first_sched',icon:'📅',name:'Planner Pro',desc:'Added your first study session',rarity:'common'},
  {key:'first_timer',icon:'⏱',name:'Time Keeper',desc:'Completed a Pomodoro session',rarity:'common'},
  {key:'first_wb',icon:'🖊️',name:'Canvas Pioneer',desc:'Saved your first Brain Dump',rarity:'common'},
  {key:'first_share',icon:'📤',name:'Generous Scholar',desc:'Shared your first reviewer',rarity:'common'},
  {key:'first_comment',icon:'💬',name:'Discussion Starter',desc:'Left your first comment',rarity:'common'},
  {key:'streak_3',icon:'🔥',name:'On Fire',desc:'Studied 3 days in a row',rarity:'rare'},
  {key:'streak_7',icon:'💥',name:'Unstoppable',desc:'7-day study streak',rarity:'rare'},
  {key:'five_decks',icon:'🗂️',name:'Deck Builder',desc:'Created 5 flashcard decks',rarity:'rare'},
  {key:'five_shares',icon:'🌟',name:'Community Hero',desc:'Shared 5 reviewers',rarity:'rare'},
  {key:'ten_likes',icon:'❤️',name:'Popular Reviewer',desc:'Got 10 total likes',rarity:'rare'},
  {key:'all_techniques',icon:'🌈',name:'Technique Explorer',desc:'Used all 7 techniques',rarity:'epic'},
  {key:'hours_10',icon:'⏰',name:'10-Hour Club',desc:'10+ hours studied',rarity:'epic'},
  {key:'twenty_comments',icon:'🗨️',name:'Active Discusser',desc:'Posted 20 comments',rarity:'epic'},
  {key:'fifty_shares_received',icon:'📥',name:'Knowledge Hub',desc:'Your shares viewed 50 times',rarity:'epic'},
  {key:'all_ach',icon:'🌟',name:'StudyBuddy Legend',desc:'Every achievement unlocked',rarity:'legendary'},
  {key:'hours_50',icon:'💯',name:'Century Scholar',desc:'50+ hours studied',rarity:'legendary'}
];

// 15 representative questions (trimmed from 50 for code length)
var QUESTIONS=[{scenario:"You have a big exam tomorrow.",q:"What do you naturally do first?",opts:[{label:"Reread the notes several times",w:{rrr:5,question:2}},{label:"Explain the topic out loud",w:{feynman:5,blurting:2}},{label:"Create a mind map",w:{diagram:5,whiteboard:3}},{label:"Make flashcards and test yourself",w:{flashcards:5}},{label:"Write everything you remember",w:{blurting:5}}]},{scenario:"Your teacher just finished a complex lecture.",q:"How do you process the information?",opts:[{label:"Rewrite notes in simpler words",w:{feynman:4,blurting:3}},{label:"Turn notes into questions",w:{question:5,flashcards:3}},{label:"Draw a flowchart",w:{diagram:5,whiteboard:2}},{label:"Read notes again carefully",w:{rrr:5}},{label:"Write a summary from memory",w:{blurting:5,rrr:2}}]},{scenario:"A classmate asks you to explain a topic.",q:"How do you explain it?",opts:[{label:"Use simple everyday analogies",w:{feynman:5}},{label:"Draw diagrams or sketches",w:{diagram:5,whiteboard:3}},{label:"Quiz them with prepared questions",w:{question:5,flashcards:3}},{label:"Walk through the textbook step by step",w:{rrr:4,question:2}},{label:"Brainstorm freely on a board",w:{whiteboard:5,blurting:2}}]},{scenario:"A topic feels really confusing.",q:"What is your go-to strategy?",opts:[{label:"Explain it like I am 10 years old",w:{feynman:5}},{label:"Write what I DO know, find gaps",w:{blurting:5}},{label:"Read the material more slowly",w:{rrr:5,question:2}},{label:"Create a visual map",w:{diagram:5,whiteboard:3}},{label:"Make Q and A flashcards",w:{flashcards:5,question:2}}]},{scenario:"You have 20 minutes for a quick review.",q:"What do you grab first?",opts:[{label:"Flashcard deck",w:{flashcards:5}},{label:"Blank paper for brain dump",w:{blurting:5,whiteboard:2}},{label:"Notes to skim",w:{rrr:4}},{label:"Mind map diagram",w:{diagram:5}},{label:"Self-made questions",w:{question:5}}]},{scenario:"Setting up a 2-hour study session.",q:"What does your plan look like?",opts:[{label:"Read, hide notes, recite, review cycle",w:{rrr:5}},{label:"Create flashcards then drill them",w:{flashcards:5}},{label:"Build a big mind map",w:{diagram:5,whiteboard:3}},{label:"Write from memory, compare, repeat",w:{blurting:5}},{label:"Pretend teaching the topic",w:{feynman:5}}]},{scenario:"Memorizing vocabulary for a test.",q:"What method works best?",opts:[{label:"Flashcards with spaced repetition",w:{flashcards:5}},{label:"Write definitions from memory",w:{blurting:4,rrr:2}},{label:"Group words in a concept map",w:{diagram:5}},{label:"Create a quiz about each term",w:{question:5}},{label:"Explain each word simply",w:{feynman:4,blurting:2}}]},{scenario:"Studying a complex process like photosynthesis.",q:"What helps you most?",opts:[{label:"Draw a step-by-step diagram",w:{diagram:5,whiteboard:3}},{label:"Explain each step aloud simply",w:{feynman:5}},{label:"Read textbook then recite",w:{rrr:5}},{label:"Make flashcards for each step",w:{flashcards:5}},{label:"Write the process from memory",w:{blurting:5}}]},{scenario:"You realize you keep forgetting one concept.",q:"What do you do?",opts:[{label:"Extra flashcard, review more",w:{flashcards:5}},{label:"Explain just that concept simply",w:{feynman:5}},{label:"Write it from memory 5 times",w:{blurting:5}},{label:"Draw a diagram for it",w:{diagram:5}},{label:"Read the explanation again, recite",w:{rrr:5}}]},{scenario:"Preparing for an essay exam.",q:"How do you prepare?",opts:[{label:"Practice writing from memory",w:{blurting:5}},{label:"Outline diagrams for each topic",w:{diagram:5}},{label:"Flashcards with key arguments",w:{flashcards:4,question:2}},{label:"Practice explaining clearly aloud",w:{feynman:5}},{label:"Read model essays, recite structure",w:{rrr:5}}]},{scenario:"Reviewing for finals covering the semester.",q:"How do you plan review?",opts:[{label:"Master mind map of all topics",w:{diagram:5}},{label:"Go through all flashcard decks",w:{flashcards:5}},{label:"Massive brain dump of everything",w:{blurting:5}},{label:"Re-read notes, reciting key points",w:{rrr:5}},{label:"Self-quiz covering all topics",w:{question:5}}]},{scenario:"You want TRUE understanding, not just memorization.",q:"What do you do?",opts:[{label:"Explain the WHY in simple terms",w:{feynman:5}},{label:"Concept map showing cause-effect",w:{diagram:5}},{label:"Write understanding from memory",w:{blurting:5}},{label:"Deep thinking questions",w:{question:5}},{label:"Read different source for new perspective",w:{rrr:4,flashcards:2}}]},{scenario:"Study schedule packed, need max efficiency.",q:"Most time-efficient technique?",opts:[{label:"Flashcards anywhere in short bursts",w:{flashcards:5}},{label:"Quick brain dumps to find gaps",w:{blurting:5}},{label:"One focused read-recite cycle",w:{rrr:5}},{label:"Rapid mind mapping",w:{diagram:4,whiteboard:2}},{label:"Quick teach-back sessions",w:{feynman:5}}]},{scenario:"Starting a brand new subject from zero.",q:"How do you begin?",opts:[{label:"Read overview first, recite key ideas",w:{rrr:5}},{label:"Start drawing a mind map",w:{diagram:5}},{label:"Explain what little I know, build",w:{feynman:4,blurting:2}},{label:"Make flashcards for every new term",w:{flashcards:5}},{label:"Write questions to guide learning",w:{question:5}}]},{scenario:"Final check before the exam.",q:"What is your last review?",opts:[{label:"Run through flashcards I keep missing",w:{flashcards:5}},{label:"Final brain dump for gaps",w:{blurting:5}},{label:"Glance at mind map overview",w:{diagram:5}},{label:"Explain hardest concepts one more time",w:{feynman:5}},{label:"Quick re-read of summary notes",w:{rrr:5}}]}];

// ═══════════ STATE ═══════════
var S={profile:null,quizAnswers:{},scores:{},topTech:null,xp:0,ach:[],sessions:[],restDays:[],streak:0,lastStudy:null,decks:[],techUsed:{},mins:0,feynmanCt:0,diagCt:0,blurtCt:0,commentCt:0,shareCt:0,totalLikes:0,savedReviewers:[],uid:null};
var curScreen='',prevScreen='',quizQ=0,isTransitioning=false;
var timerInt=null,timerSecs=25*60,timerOn=false,timerPhase='focus';
var tpH=2,tpM=0,tpAMPM='PM';
var NAV_ORDER={home:0,study:1,community:2,schedule:3,achievements:4,profile:5};
var NAV_SCREENS={home:'screen-home',study:'screen-study',community:'screen-community',schedule:'screen-schedule',achievements:'screen-achievements',profile:'screen-profile'};
var communityTab='feed';
var shareType='flashcards';
var currentReviewerId=null;

function save(){try{localStorage.setItem('sb6',JSON.stringify(S));if(firebaseReady&&currentUser)db.collection('users').doc(currentUser.uid).set(S,{merge:true}).catch(function(){});}catch(e){}}
function loadLocal(){try{var d=localStorage.getItem('sb6');if(d){S=Object.assign(S,JSON.parse(d));return true;}}catch(e){}return false;}
function esc(t){return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}
function timeAgo(ts){var d=Date.now()-ts;if(d<60000)return'just now';if(d<3600000)return Math.floor(d/60000)+'m ago';if(d<86400000)return Math.floor(d/3600000)+'h ago';return Math.floor(d/86400000)+'d ago';}

// ═══════════ AUTH ═══════════
function signInWithGoogle(){
  if(!firebaseReady){showToast('Firebase not configured. Add your config!');SFX.error();
    // Demo mode - simulate login
    currentUser={uid:'demo_'+Date.now(),displayName:'Demo User',email:'demo@studybuddy.app',photoURL:null};
    S.uid=currentUser.uid;
    onAuthSuccess();
    return;
  }
  var provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(function(result){
    currentUser=result.user;
    S.uid=currentUser.uid;
    onAuthSuccess();
  }).catch(function(error){showToast('Sign-in failed: '+error.message);SFX.error();});
}

function onAuthSuccess(){
  showToast('Welcome, '+(currentUser.displayName||'Learner')+'!');SFX.success();
  // Try loading from Firestore first
  if(firebaseReady&&currentUser.uid!=='demo_'+currentUser.uid){
    db.collection('users').doc(currentUser.uid).get().then(function(doc){
      if(doc.exists){S=Object.assign(S,doc.data());S.uid=currentUser.uid;}else{loadLocal();}
      afterAuth();
    }).catch(function(){loadLocal();afterAuth();});
  }else{loadLocal();afterAuth();}
}

function afterAuth(){
  if(S.profile&&S.scores&&Object.keys(S.scores).length>0){
    renderHome();navigateTo('screen-home');
  }else{
    initSetup();
    if(currentUser&&currentUser.displayName){document.getElementById('inp-name').value=currentUser.displayName;}
    navigateTo('screen-setup');
  }
}

function signOut(){
  if(firebaseReady)auth.signOut();
  currentUser=null;
  localStorage.removeItem('sb6');
  S={profile:null,quizAnswers:{},scores:{},topTech:null,xp:0,ach:[],sessions:[],restDays:[],streak:0,lastStudy:null,decks:[],techUsed:{},mins:0,feynmanCt:0,diagCt:0,blurtCt:0,commentCt:0,shareCt:0,totalLikes:0,savedReviewers:[],uid:null};
  navigateTo('screen-auth');showToast('Signed out');
}

// ═══════════ NAVIGATION ═══════════
function navigateTo(id,animType){if(isTransitioning||id===curScreen)return;isTransitioning=true;animType=animType||'default';var oldEl=curScreen?document.getElementById(curScreen):null;var newEl=document.getElementById(id);if(!newEl){isTransitioning=false;return;}var exitClass='exiting',enterClass='entering';if(animType==='left'){exitClass='exiting-left';enterClass='entering-left';}else if(animType==='right'){exitClass='exiting-right';enterClass='entering-right';}else if(animType==='up'){exitClass='exiting';enterClass='entering-up';}else if(animType==='down'){exitClass='exiting-down';enterClass='entering';}if(oldEl&&oldEl!==newEl){oldEl.classList.add(exitClass);var oldRef=oldEl,exitRef=exitClass;setTimeout(function(){oldRef.classList.remove('active',exitRef);},400);}var delay=oldEl&&oldEl!==newEl?120:0;setTimeout(function(){newEl.classList.add('active',enterClass);setTimeout(function(){newEl.classList.remove(enterClass);isTransitioning=false;},550);},delay);prevScreen=curScreen;curScreen=id;SFX.navigate();}
function goBack(){navigateTo(prevScreen||'screen-home','down');}
function switchNav(tab){var scr=NAV_SCREENS[tab];if(!scr||scr===curScreen)return;var curTab='home';Object.keys(NAV_SCREENS).forEach(function(k){if(NAV_SCREENS[k]===curScreen)curTab=k;});var dir=(NAV_ORDER[tab]||0)>(NAV_ORDER[curTab]||0)?'left':'right';SFX.whoosh();navigateTo(scr,dir);if(tab==='achievements')renderAch();if(tab==='schedule'){renderSched();renderSessList();}if(tab==='study')renderStudyList();if(tab==='home')renderHome();if(tab==='community')renderCommunity();if(tab==='profile')renderProfile();setTimeout(function(){document.querySelectorAll('.bottom-nav').forEach(function(nav){var tabs=['home','study','community','schedule','achievements'];nav.querySelectorAll('.nav-item').forEach(function(n,i){n.classList.toggle('active',tabs[i]===tab);});});},50);}
function openTech(id){if(!S.techUsed)S.techUsed={};S.techUsed[id]=(S.techUsed[id]||0)+1;save();if(Object.keys(S.techUsed).length>=7)unlock('all_techniques');var t=TECHNIQUES.find(function(x){return x.id===id;});if(!t)return;switch(id){case'flashcards':initFC();break;case'blurting':initBlurt();break;case'question':initCornell();break;case'feynman':initFeynman();break;case'rrr':initRRR();break;case'whiteboard':navigateTo(t.screen,'up');setTimeout(initWB,250);return;case'diagram':navigateTo(t.screen,'up');setTimeout(initDiag,250);return;}navigateTo(t.screen,'up');}

// ═══════════ SPLASH ═══════════
function hideSplash(){setTimeout(function(){SFX.startup();},1500);setTimeout(function(){var sp=document.getElementById('splash');sp.classList.add('exit');burst(window.innerWidth/2,window.innerHeight/2,['#9b85f0','#f09cc8','#f5c542','#5b9cf5','#43d9ad'],20);setTimeout(function(){sp.style.display='none';},900);
  if(firebaseReady){auth.onAuthStateChanged(function(user){if(user){currentUser=user;S.uid=user.uid;onAuthSuccess();}else{navigateTo('screen-auth');}});}else{if(loadLocal()&&S.profile&&S.scores&&Object.keys(S.scores).length>0){currentUser={uid:'offline',displayName:S.profile.name,email:'offline@local',photoURL:null};renderHome();navigateTo('screen-home');}else{navigateTo('screen-auth');}}
},3800);}

// ═══════════ SETUP ═══════════
var selectedAvatarIdx=0,selGr='';
function initSetup(){var ag=document.getElementById('av-grid');ag.innerHTML=AVATARS.map(function(a,i){return'<div class="av-opt '+(i===0?'sel':'')+'" data-idx="'+i+'">'+a+'</div>';}).join('');ag.onclick=function(e){var opt=e.target.closest('.av-opt');if(!opt)return;selectedAvatarIdx=parseInt(opt.dataset.idx);ag.querySelectorAll('.av-opt').forEach(function(el,j){el.classList.toggle('sel',j===selectedAvatarIdx);});SFX.select();};var gg=document.getElementById('gr-grid');gg.innerHTML=GRADES.map(function(g){return'<div class="grade-opt" data-grade="'+g+'">'+g+'</div>';}).join('');gg.onclick=function(e){var opt=e.target.closest('.grade-opt');if(!opt)return;selGr=opt.dataset.grade;gg.querySelectorAll('.grade-opt').forEach(function(el){el.classList.remove('sel');});opt.classList.add('sel');SFX.select();};}
function saveProfile(){var name=document.getElementById('inp-name').value.trim();if(!name){showToast('Please enter your name');SFX.error();return;}if(!selGr){showToast('Please pick your grade level');SFX.error();return;}S.profile={name:name,avatar:AVATARS[selectedAvatarIdx],grade:selGr,photoURL:currentUser?currentUser.photoURL:null};save();unlock('first_profile');startQuiz();}

// ═══════════ QUIZ ═══════════
function startQuiz(){S.quizAnswers={};quizQ=0;navigateTo('screen-quiz');renderQ();}
function renderQ(){var q=QUESTIONS[quizQ];var pct=((quizQ+1)/QUESTIONS.length*100).toFixed(1);document.getElementById('q-prog').style.width=pct+'%';document.getElementById('q-num').textContent='Q'+(quizQ+1)+' / '+QUESTIONS.length;document.getElementById('q-hint').textContent='Results at Q'+QUESTIONS.length;var sel=S.quizAnswers[quizQ];document.getElementById('q-body').innerHTML='<div class="quiz-scenario"><div class="scenario-label">Scenario</div><div style="font-size:15px;font-weight:700;color:var(--text);line-height:1.5;">'+q.scenario+'</div></div><div class="quiz-qtext">'+q.q+'</div><div class="quiz-opts">'+q.opts.map(function(o,i){return'<div class="quiz-opt '+(sel===i?'sel':'')+'" onclick="pickQ('+i+',this)"><div class="quiz-dot">'+(sel===i?'✓':'')+'</div><span>'+String.fromCharCode(65+i)+'. '+o.label+'</span></div>';}).join('')+'</div>';document.getElementById('q-prev').style.opacity=quizQ===0?'0.35':'1';document.getElementById('q-next').textContent=quizQ===QUESTIONS.length-1?'See My Results':'Next';}
function pickQ(v,el){S.quizAnswers[quizQ]=v;document.querySelectorAll('.quiz-opt').forEach(function(o){o.classList.remove('sel');o.querySelector('.quiz-dot').innerHTML='';});el.classList.add('sel');el.querySelector('.quiz-dot').innerHTML='✓';SFX.select();}
function qNext(){if(S.quizAnswers[quizQ]===undefined){showToast('Please select an answer');SFX.error();return;}if(quizQ<QUESTIONS.length-1){quizQ++;renderQ();}else computeResults();}
function qPrev(){if(quizQ>0){quizQ--;renderQ();}}
function computeResults(){var sc={};TECHNIQUES.forEach(function(t){sc[t.id]=0;});QUESTIONS.forEach(function(q,i){var ai=S.quizAnswers[i];if(ai===undefined)return;var o=q.opts[ai];if(o&&o.w)Object.keys(o.w).forEach(function(id){if(sc[id]!==undefined)sc[id]+=o.w[id];});});var max=Math.max.apply(null,Object.values(sc).concat([1]));var norm={};Object.keys(sc).forEach(function(k){norm[k]=Math.round(sc[k]/max*100);});S.scores=norm;S.topTech=Object.keys(norm).sort(function(a,b){return norm[b]-norm[a];})[0];save();unlock('quiz_complete');renderResults();navigateTo('screen-results');SFX.success();}
function renderResults(){var sorted=Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a];});var tm={};TECHNIQUES.forEach(function(t){tm[t.id]=t;});var medals=['🥇','🥈','🥉'];document.getElementById('r-sub').textContent='Hi '+S.profile.name+'! Here is how your techniques scored:';document.getElementById('r-body').innerHTML=sorted.map(function(id,i){var t=tm[id];var pct=S.scores[id];if(!t)return'';return'<div class="result-card" style="background:'+t.soft+';border-color:'+t.cval+'40;color:'+t.cval+';"><div class="result-rank">'+(medals[i]||'#'+(i+1))+'</div><div class="result-info"><h4>'+t.icon+' '+t.name+'</h4><p>'+t.desc+'</p></div><div class="result-pct-wrap"><div class="result-pct">'+pct+'%</div><div class="result-pct-label">match</div></div><div class="result-bar-bg"><div class="result-bar-fill" style="background:'+t.cval+';width:0%;" data-w="'+pct+'"></div></div></div>';}).join('');setTimeout(function(){document.querySelectorAll('.result-bar-fill').forEach(function(b){b.style.width=b.dataset.w+'%';});},200);}
function goToHome(){renderHome();navigateTo('screen-home');}

// ═══════════ HOME ═══════════
function renderHome(){if(!S.profile)return;var photoHtml=currentUser&&currentUser.photoURL?'<img src="'+currentUser.photoURL+'" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">':'<span style="font-size:20px;display:flex;align-items:center;justify-content:center;height:100%;">'+S.profile.avatar+'</span>';document.getElementById('home-av-wrap').innerHTML=photoHtml;var h=new Date().getHours();var lv=Math.floor(S.xp/200)+1,xI=S.xp%200;var sorted=S.scores?Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a];}):[];document.getElementById('home-body').innerHTML='<div class="greeting"><div class="greeting-hi">'+(h<12?'Good morning,':h<17?'Good afternoon,':'Good evening,')+'</div><div class="greeting-name">'+esc(S.profile.name)+' '+S.profile.avatar+'</div></div><div class="xp-card"><span class="xp-icon">⚡</span><div class="xp-info"><div class="xp-lbl"><span>Level '+lv+'</span><span>'+xI+'/200 XP</span></div><div class="xp-track"><div class="xp-fill" style="width:'+(xI/200*100)+'%"></div></div></div></div><div class="streak-card"><div class="streak-days" id="streak-days"></div><div class="streak-stat"><div class="streak-num">'+(S.streak||0)+'</div><div class="streak-lbl">Streak</div></div></div><div class="section-label">Recommended Techniques</div><div class="tech-grid">'+TECHNIQUES.slice(0,4).map(function(t){var rank=sorted.indexOf(t.id)+1;return'<div class="tc" onclick="SFX.tap();openTech(\''+t.id+'\')"><div style="position:absolute;top:0;left:0;right:0;height:4px;border-radius:var(--r-lg) var(--r-lg) 0 0;background:'+t.cval+';"></div>'+(rank===1?'<div class="tc-badge tc-best">Best</div>':'')+'<span class="tc-icon">'+t.icon+'</span><div class="tc-name">'+t.name+'</div><div class="tc-desc">'+t.desc+'</div></div>';}).join('')+'</div><div class="section-label">Quick Actions</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;"><button class="btn btn-secondary btn-sm" onclick="SFX.tap();switchNav(\'community\')">🌐 Community</button><button class="btn btn-secondary btn-sm" onclick="SFX.tap();switchNav(\'schedule\')">📅 Schedule</button><button class="btn btn-secondary btn-sm" onclick="SFX.tap();switchNav(\'achievements\')">🏆 Awards</button></div><div class="section-label">Daily Tip</div><div class="tip-card"><p>'+TIPS[new Date().getDate()%TIPS.length]+'</p></div>';renderStreakDays();applyTheme();}
function renderStreakDays(){var days=['Su','Mo','Tu','We','Th','Fr','Sa'];var today=new Date().getDay();var el=document.getElementById('streak-days');if(!el)return;el.innerHTML=days.map(function(d,i){var isT=i===today;return'<div class="sday '+(isT?'today':'')+'"><span>'+d+'</span></div>';}).join('');}
function renderStudyList(){var sorted=S.scores?Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a];}):[];document.getElementById('study-list-body').innerHTML='<div class="section-label">Choose a technique</div>'+TECHNIQUES.map(function(t){var rank=sorted.indexOf(t.id)+1;var pct=S.scores[t.id]||0;return'<div class="tech-list-item" onclick="SFX.tap();openTech(\''+t.id+'\')"><span class="tli-icon">'+t.icon+'</span><div class="tli-info"><div class="tli-name">'+t.name+'</div><div class="tli-desc">'+t.desc+'</div>'+(pct>0?'<div class="tli-match" style="background:'+t.soft+';color:'+t.cval+';">'+(rank===1?'Best match':'#'+rank)+' '+pct+'%</div>':'')+'</div><span style="color:var(--text3);font-size:20px;">›</span></div>';}).join('');}

// ═══════════ COMMUNITY ═══════════
function renderCommunity(){
  switchCommunityTab(communityTab);
}
function switchCommunityTab(tab,el){
  communityTab=tab;
  document.querySelectorAll('#community-tabs .tab-bar-item').forEach(function(t){t.classList.remove('active');});
  if(el)el.classList.add('active');else document.querySelectorAll('#community-tabs .tab-bar-item')[['feed','my','saved'].indexOf(tab)].classList.add('active');
  var body=document.getElementById('community-body');
  if(tab==='feed')loadCommunityFeed(body);
  else if(tab==='my')loadMyShares(body);
  else if(tab==='saved')loadSavedReviewers(body);
}

function loadCommunityFeed(el){
  el.innerHTML='<div class="search-bar"><input class="search-input" placeholder="🔍 Search reviewers..." oninput="filterCommunity(this.value)"><button class="search-filter" onclick="SFX.pop();">Filter</button></div><div id="feed-list"><div style="text-align:center;padding:20px;"><div class="spinner-lg"></div><div style="margin-top:10px;font-size:13px;color:var(--text3);">Loading community feed...</div></div></div>';
  if(firebaseReady){
    db.collection('shared_reviewers').orderBy('createdAt','desc').limit(30).get().then(function(snap){
      var items=[];snap.forEach(function(doc){items.push(Object.assign({id:doc.id},doc.data()));});
      renderFeedItems(items);
    }).catch(function(){renderDemoFeed();});
  }else{renderDemoFeed();}
}

function renderDemoFeed(){
  var demo=[
    {id:'demo1',title:'Biology: Cell Division',desc:'Complete reviewer for mitosis and meiosis with key terms and diagrams.',type:'flashcards',tags:['biology','cells','science'],userName:'Maria Santos',userPhoto:null,userAvatar:'🦊',likes:12,comments:[{user:'Alex',avatar:'🐼',text:'This is really helpful! Thanks for sharing.',time:Date.now()-3600000},{user:'Sam',avatar:'🐸',text:'Can you add more about prophase?',time:Date.now()-1800000}],content:'Mitosis|Cell division producing two identical daughter cells\nMeiosis|Cell division producing four genetically different cells\nProphase|Chromosomes condense and become visible\nMetaphase|Chromosomes align at the cell equator\nAnaphase|Sister chromatids separate and move to poles\nTelophase|Nuclear envelope reforms around chromosomes',createdAt:Date.now()-86400000,views:45},
    {id:'demo2',title:'Philippine History: Key Events',desc:'Timeline of important events in Philippine history for Grade 10.',type:'notes',tags:['history','philippines','araling panlipunan'],userName:'Juan dela Cruz',userPhoto:null,userAvatar:'🦁',likes:8,comments:[{user:'Ria',avatar:'🦋',text:'Very comprehensive! Saved this for my exam.',time:Date.now()-7200000}],content:'1521 - Magellan arrives in the Philippines\n1565 - Spanish colonization begins under Legazpi\n1896 - Philippine Revolution against Spain\n1898 - Declaration of Philippine Independence\n1899-1902 - Philippine-American War\n1935 - Commonwealth period begins\n1941-1945 - Japanese occupation\n1946 - Full independence from the United States\n1972 - Martial Law declared\n1986 - EDSA People Power Revolution',createdAt:Date.now()-172800000,views:67},
    {id:'demo3',title:'Math: Quadratic Formula',desc:'Step by step guide to solving quadratic equations.',type:'notes',tags:['math','algebra','quadratic'],userName:'Anna Lee',userPhoto:null,userAvatar:'🐬',likes:15,comments:[],content:'The quadratic formula: x = (-b ± √(b²-4ac)) / 2a\n\nSteps:\n1. Write equation in standard form: ax² + bx + c = 0\n2. Identify a, b, and c\n3. Calculate the discriminant: D = b² - 4ac\n4. If D > 0: two real solutions\n5. If D = 0: one real solution\n6. If D < 0: no real solutions\n7. Substitute into the formula',createdAt:Date.now()-259200000,views:92}
  ];
  renderFeedItems(demo);
}

function renderFeedItems(items){
  var el=document.getElementById('feed-list');
  if(!items||items.length===0){
    el.innerHTML='<div class="empty-state"><span class="empty-icon">🌐</span><h3>No reviewers yet</h3><p>Be the first to share a reviewer with the community!</p></div>';
    return;
  }
  el.innerHTML=items.map(function(item){
    var isLiked=(S.savedReviewers||[]).indexOf(item.id)>=0;
    var photoHtml=item.userPhoto?'<img src="'+item.userPhoto+'">':'<span>'+esc(item.userAvatar||'📚')+'</span>';
    return'<div class="shared-card" onclick="openReviewer(\''+item.id+'\')"><div class="shared-card-header"><div class="shared-avatar">'+photoHtml+'</div><div class="shared-user-info"><div class="shared-username">'+esc(item.userName||'Anonymous')+'</div><div class="shared-time">'+timeAgo(item.createdAt)+' · '+esc(item.type)+'</div></div></div><div class="shared-card-body"><h4>'+esc(item.title)+'</h4><p>'+esc(item.desc)+'</p></div><div class="shared-tags">'+((item.tags||[]).map(function(t){return'<span class="shared-tag">'+esc(t)+'</span>';}).join(''))+'</div><div class="shared-stats"><span class="shared-stat '+(isLiked?'liked':'')+'" onclick="event.stopPropagation();toggleLike(\''+item.id+'\')">❤️ '+(item.likes||0)+'</span><span class="shared-stat">💬 '+((item.comments||[]).length)+'</span><span class="shared-stat">👁 '+(item.views||0)+'</span></div></div>';
  }).join('');
  window._feedItems=items;
}

function filterCommunity(q){
  if(!window._feedItems)return;
  var filtered=window._feedItems.filter(function(i){
    q=q.toLowerCase();
    return(i.title||'').toLowerCase().includes(q)||(i.desc||'').toLowerCase().includes(q)||(i.tags||[]).some(function(t){return t.toLowerCase().includes(q);});
  });
  renderFeedItems(filtered);
}

function loadMyShares(el){
  if(!firebaseReady||!currentUser){el.innerHTML='<div class="empty-state"><span class="empty-icon">📤</span><h3>Your shared reviewers</h3><p>Sign in and share reviewers to see them here.</p></div>';return;}
  el.innerHTML='<div style="text-align:center;padding:20px;"><div class="spinner-lg"></div></div>';
  db.collection('shared_reviewers').where('uid','==',currentUser.uid).orderBy('createdAt','desc').get().then(function(snap){
    var items=[];snap.forEach(function(doc){items.push(Object.assign({id:doc.id},doc.data()));});
    if(items.length===0){el.innerHTML='<div class="empty-state"><span class="empty-icon">📤</span><h3>No shares yet</h3><p>Tap the + Share button to share your first reviewer!</p></div>';return;}
    el.innerHTML=items.map(function(item){return'<div class="shared-card" onclick="openReviewer(\''+item.id+'\')"><div class="shared-card-body"><h4>'+esc(item.title)+'</h4><p>'+esc(item.desc)+'</p></div><div class="shared-stats"><span class="shared-stat">❤️ '+(item.likes||0)+'</span><span class="shared-stat">💬 '+((item.comments||[]).length)+'</span><span class="shared-stat">👁 '+(item.views||0)+'</span></div></div>';}).join('');
  }).catch(function(){el.innerHTML='<div class="empty-state"><span class="empty-icon">⚠️</span><h3>Could not load</h3><p>Check your connection and try again.</p></div>';});
}

function loadSavedReviewers(el){
  if(!S.savedReviewers||S.savedReviewers.length===0){el.innerHTML='<div class="empty-state"><span class="empty-icon">⭐</span><h3>No saved reviewers</h3><p>Like reviewers in the feed to save them here.</p></div>';return;}
  el.innerHTML='<div style="font-size:13px;color:var(--text2);margin-bottom:14px;">You have '+S.savedReviewers.length+' saved reviewers.</div>'+S.savedReviewers.map(function(id){return'<div class="shared-card" onclick="openReviewer(\''+id+'\')"><div class="shared-card-body"><h4>Saved Reviewer</h4><p>ID: '+id+'</p></div></div>';}).join('');
}

// ═══════════ REVIEWER DETAIL ═══════════
function openReviewer(id){
  currentReviewerId=id;
  var el=document.getElementById('reviewer-body');
  el.innerHTML='<div style="text-align:center;padding:40px;"><div class="spinner-lg"></div></div>';
  navigateTo('screen-reviewer','up');

  // Try getting from feed items cache first
  var item=window._feedItems?window._feedItems.find(function(x){return x.id===id;}):null;
  if(item){renderReviewerDetail(item);return;}
  if(firebaseReady){
    db.collection('shared_reviewers').doc(id).get().then(function(doc){
      if(doc.exists)renderReviewerDetail(Object.assign({id:doc.id},doc.data()));
      else el.innerHTML='<div class="empty-state"><span class="empty-icon">🔍</span><h3>Not Found</h3></div>';
    }).catch(function(){el.innerHTML='<div class="empty-state"><span class="empty-icon">⚠️</span><h3>Error loading</h3></div>';});
  }else if(item){renderReviewerDetail(item);}
}

function renderReviewerDetail(item){
  document.getElementById('reviewer-title').textContent=item.title||'Reviewer';
  var el=document.getElementById('reviewer-body');
  var photoHtml=item.userPhoto?'<img src="'+item.userPhoto+'">':'<span>'+esc(item.userAvatar||'📚')+'</span>';
  var isLiked=(S.savedReviewers||[]).indexOf(item.id)>=0;

  // Parse content based on type
  var contentHtml='';
  if(item.type==='flashcards'){
    var cards=(item.content||'').split('\n').filter(function(l){return l.includes('|');});
    contentHtml='<div class="section-label" style="margin-top:14px;">Flashcards ('+cards.length+')</div>'+cards.map(function(c,i){var parts=c.split('|');return'<div class="deck-card" style="cursor:default;"><div class="deck-dot" style="background:'+DECK_COLORS[i%DECK_COLORS.length]+';"></div><div class="deck-info"><h4>'+esc(parts[0])+'</h4><p>'+esc(parts[1]||'')+'</p></div></div>';}).join('')+'<button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="importReviewer(\''+item.id+'\')">📥 Import to My Decks</button>';
  }else{
    contentHtml='<div class="section-label" style="margin-top:14px;">Content</div><div style="padding:16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);font-size:13px;line-height:1.8;color:var(--text2);white-space:pre-wrap;">'+esc(item.content)+'</div>';
  }

  el.innerHTML='<div class="shared-card-header"><div class="shared-avatar">'+photoHtml+'</div><div class="shared-user-info"><div class="shared-username">'+esc(item.userName||'Anonymous')+'</div><div class="shared-time">'+timeAgo(item.createdAt)+'</div></div></div><div style="font-family:\'Baloo 2\',sans-serif;font-size:22px;font-weight:800;margin:10px 0 4px;">'+esc(item.title)+'</div><div style="font-size:13px;color:var(--text2);margin-bottom:10px;line-height:1.6;">'+esc(item.desc)+'</div><div class="shared-tags">'+((item.tags||[]).map(function(t){return'<span class="shared-tag">'+esc(t)+'</span>';}).join(''))+'</div><div class="shared-stats" style="margin:10px 0;"><span class="shared-stat '+(isLiked?'liked':'')+'" onclick="toggleLike(\''+item.id+'\')">❤️ '+(item.likes||0)+' likes</span><span class="shared-stat">👁 '+(item.views||0)+' views</span></div>'+contentHtml+'<div class="comment-section"><div class="section-label" style="margin-top:18px;">💬 Discussion ('+((item.comments||[]).length)+')</div><div id="reviewer-comments">'+((item.comments||[]).map(function(c){var cPhoto=c.userPhoto?'<img src="'+c.userPhoto+'">':'<span>'+esc(c.avatar||'👤')+'</span>';return'<div class="comment-item"><div class="comment-avatar">'+cPhoto+'</div><div class="comment-body"><div class="comment-user">'+esc(c.user)+'</div><div class="comment-text">'+esc(c.text)+'</div><div class="comment-time">'+timeAgo(c.time)+'</div></div></div>';}).join('')||'<div style="text-align:center;padding:16px;color:var(--text3);font-size:13px;">No comments yet. Start the discussion!</div>')+'</div><div class="comment-input-wrap"><input class="comment-input" id="comment-input" placeholder="Add a comment..."><button class="comment-send" onclick="postComment(\''+item.id+'\')">➤</button></div></div>';

  // Increment view count
  if(firebaseReady&&item.id.indexOf('demo')!==0){
    db.collection('shared_reviewers').doc(item.id).update({views:firebase.firestore.FieldValue.increment(1)}).catch(function(){});
  }
}

function importReviewer(id){
  var item=window._feedItems?window._feedItems.find(function(x){return x.id===id;}):null;
  if(!item){showToast('Could not find reviewer');return;}
  var cards=(item.content||'').split('\n').filter(function(l){return l.includes('|');}).map(function(c){var p=c.split('|');return{front:p[0].trim(),back:(p[1]||'').trim(),rating:-1,created:Date.now()};});
  if(!S.decks)S.decks=[];
  S.decks.push({name:item.title,subject:'Imported',color:DECK_COLORS[S.decks.length%DECK_COLORS.length],cards:cards});
  save();
  showToast(cards.length+' cards imported! +15 XP');addXP(15);SFX.success();burst(window.innerWidth/2,window.innerHeight/2);
}

function toggleLike(id){
  if(!S.savedReviewers)S.savedReviewers=[];
  var idx=S.savedReviewers.indexOf(id);
  if(idx>=0){S.savedReviewers.splice(idx,1);showToast('Removed from saved');}
  else{S.savedReviewers.push(id);showToast('Saved! ❤️');S.totalLikes=(S.totalLikes||0)+1;if(S.totalLikes>=10)unlock('ten_likes');}
  save();SFX.select();
  if(firebaseReady&&id.indexOf('demo')!==0){
    db.collection('shared_reviewers').doc(id).update({likes:firebase.firestore.FieldValue.increment(idx>=0?-1:1)}).catch(function(){});
  }
}

function postComment(reviewerId){
  var input=document.getElementById('comment-input');
  var text=input.value.trim();
  if(!text){showToast('Write a comment first');SFX.error();return;}
  var comment={user:S.profile?S.profile.name:'Anonymous',avatar:S.profile?S.profile.avatar:'👤',userPhoto:currentUser?currentUser.photoURL:null,text:text,time:Date.now(),uid:currentUser?currentUser.uid:null};
  input.value='';
  SFX.correct();
  S.commentCt=(S.commentCt||0)+1;save();
  unlock('first_comment');
  if(S.commentCt>=20)unlock('twenty_comments');

  // Add to local display
  var commentsEl=document.getElementById('reviewer-comments');
  var cPhoto=comment.userPhoto?'<img src="'+comment.userPhoto+'">':'<span>'+esc(comment.avatar)+'</span>';
  commentsEl.innerHTML+='<div class="comment-item"><div class="comment-avatar">'+cPhoto+'</div><div class="comment-body"><div class="comment-user">'+esc(comment.user)+'</div><div class="comment-text">'+esc(comment.text)+'</div><div class="comment-time">just now</div></div></div>';
  showToast('Comment posted! +5 XP');addXP(5);

  // Save to Firestore
  if(firebaseReady&&reviewerId.indexOf('demo')!==0){
    db.collection('shared_reviewers').doc(reviewerId).update({comments:firebase.firestore.FieldValue.arrayUnion(comment)}).catch(function(){});
  }
  // For demo items, update local cache
  if(window._feedItems){var item=window._feedItems.find(function(x){return x.id===reviewerId;});if(item){if(!item.comments)item.comments=[];item.comments.push(comment);}}
}

function copyShareLink(){
  var link=window.location.origin+window.location.pathname+'?reviewer='+currentReviewerId;
  if(navigator.clipboard){navigator.clipboard.writeText(link).then(function(){showToast('Link copied! 🔗');SFX.correct();});}
  else{showToast('Link: '+link);SFX.correct();}
}

// ═══════════ SHARE MODAL ═══════════
function showShareModal(){
  document.getElementById('share-modal').classList.add('show');
  // Populate deck selector
  var sel=document.getElementById('share-deck-select');
  sel.innerHTML='<option value="">-- None (use content above) --</option>'+((S.decks||[]).map(function(d,i){return'<option value="'+i+'">'+esc(d.name)+' ('+d.cards.length+' cards)</option>';}).join(''));
}
function hideShareModal(){document.getElementById('share-modal').classList.remove('show');}
function selectShareType(type,el){
  shareType=type;
  document.querySelectorAll('.share-type').forEach(function(t){t.classList.remove('sel');});
  el.classList.add('sel');SFX.pop();
}

function publishReviewer(){
  var title=document.getElementById('share-title').value.trim();
  var desc=document.getElementById('share-desc').value.trim();
  var content=document.getElementById('share-content').value.trim();
  var tags=document.getElementById('share-tags').value.split(',').map(function(t){return t.trim();}).filter(Boolean);
  var deckIdx=document.getElementById('share-deck-select').value;

  // If deck selected, auto-populate content
  if(deckIdx!==''&&S.decks[parseInt(deckIdx)]){
    var deck=S.decks[parseInt(deckIdx)];
    if(!title)title=deck.name;
    content=deck.cards.map(function(c){return c.front+'|'+c.back;}).join('\n');
    shareType='flashcards';
  }

  if(!title){showToast('Please add a title');SFX.error();return;}
  if(!content){showToast('Please add content');SFX.error();return;}

  var reviewer={
    title:title,desc:desc,type:shareType,content:content,tags:tags,
    uid:currentUser?currentUser.uid:null,
    userName:S.profile?S.profile.name:'Anonymous',
    userPhoto:currentUser?currentUser.photoURL:null,
    userAvatar:S.profile?S.profile.avatar:'📚',
    likes:0,comments:[],views:0,createdAt:Date.now()
  };

  if(firebaseReady){
    db.collection('shared_reviewers').add(reviewer).then(function(){
      showToast('Published! 🚀 +20 XP');addXP(20);SFX.success();
      burst(window.innerWidth/2,window.innerHeight/2);
      S.shareCt=(S.shareCt||0)+1;save();
      unlock('first_share');
      if(S.shareCt>=5)unlock('five_shares');
      hideShareModal();
      switchCommunityTab('feed');
    }).catch(function(e){showToast('Error publishing: '+e.message);SFX.error();});
  }else{
    // Demo mode - just add to local feed
    reviewer.id='local_'+Date.now();
    if(!window._feedItems)window._feedItems=[];
    window._feedItems.unshift(reviewer);
    showToast('Published locally! 🚀 +20 XP');addXP(20);SFX.success();
    burst(window.innerWidth/2,window.innerHeight/2);
    S.shareCt=(S.shareCt||0)+1;save();
    unlock('first_share');
    if(S.shareCt>=5)unlock('five_shares');
    hideShareModal();
    renderFeedItems(window._feedItems);
  }
}

function shareCurrentWork(type){
  showShareModal();
  selectShareType(type,document.querySelectorAll('.share-type')[type==='diagram'?2:1]);
}

// ═══════════ PROFILE ═══════════
function renderProfile(){
  var el=document.getElementById('profile-body');
  var photoHtml=currentUser&&currentUser.photoURL?'<img src="'+currentUser.photoURL+'" style="width:80px;height:80px;border-radius:50%;border:3px solid var(--purple);">':'<div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:40px;border:3px solid var(--purple);">'+esc(S.profile?S.profile.avatar:'👤')+'</div>';
  el.innerHTML='<div style="text-align:center;padding:20px 0;">'+photoHtml+'<div style="font-family:\'Baloo 2\',sans-serif;font-size:24px;font-weight:800;margin-top:10px;">'+esc(S.profile?S.profile.name:'Learner')+'</div><div style="font-size:13px;color:var(--text2);">'+(currentUser?currentUser.email:'Offline Mode')+'</div><div style="font-size:12px;color:var(--text3);margin-top:4px;">'+(S.profile?S.profile.grade:'')+'</div></div><div class="section-label">Stats</div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;"><div style="background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px;text-align:center;"><div style="font-family:\'Baloo 2\',sans-serif;font-size:24px;font-weight:800;color:var(--purple);">'+(S.xp||0)+'</div><div style="font-size:10px;font-weight:800;color:var(--text3);text-transform:uppercase;">XP</div></div><div style="background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px;text-align:center;"><div style="font-family:\'Baloo 2\',sans-serif;font-size:24px;font-weight:800;color:var(--orange);">'+(S.streak||0)+'</div><div style="font-size:10px;font-weight:800;color:var(--text3);text-transform:uppercase;">Streak</div></div><div style="background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px;text-align:center;"><div style="font-family:\'Baloo 2\',sans-serif;font-size:24px;font-weight:800;color:var(--mint);">'+(S.shareCt||0)+'</div><div style="font-size:10px;font-weight:800;color:var(--text3);text-transform:uppercase;">Shares</div></div></div><div class="section-label">Account</div><button class="btn btn-danger btn-full" onclick="if(confirm(\'Sign out?\'))signOut()">Sign Out</button>';
}

// ═══════════ FLASHCARDS ═══════════
var fcDeckIdx=null,fcCardIdx=0,fcFlipped=false,newDeckColor=DECK_COLORS[0];
function initFC(){switchFcTab('decks',document.querySelector('.fc-tab'));renderFCDecks();renderFCCreate();renderFCAI();}
function switchFcTab(tab,el){document.querySelectorAll('.fc-tab').forEach(function(t){t.classList.remove('active');});if(el)el.classList.add('active');document.querySelectorAll('.fc-section').forEach(function(s){s.classList.remove('active');});var sec=document.getElementById('fc-'+tab);if(sec)sec.classList.add('active');}
function renderFCDecks(){var el=document.getElementById('fc-decks');if(!S.decks||S.decks.length===0){el.innerHTML='<div class="empty-state"><span class="empty-icon">🃏</span><h3>No decks yet!</h3><p>Go to Create or AI Gen to get started.</p></div>';return;}el.innerHTML=S.decks.map(function(d,i){return'<div class="deck-card" onclick="SFX.tap();openDeck('+i+')"><div class="deck-dot" style="background:'+d.color+';"></div><div class="deck-info"><h4>'+esc(d.name)+'</h4><p>'+(d.subject||'General')+' · '+d.cards.length+' cards</p></div><div class="deck-count">'+d.cards.length+'</div><button onclick="event.stopPropagation();deleteDeck('+i+')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:16px;">×</button></div>';}).join('');}
function renderFCCreate(){document.getElementById('fc-create').innerHTML='<div class="create-deck-form"><h4>New Deck</h4><div class="form-group"><label class="form-label">Deck Name</label><input class="form-input" id="new-deck-name" placeholder="e.g. Chapter 3"></div><div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="new-deck-subj" placeholder="e.g. Biology"></div><div class="form-group"><label class="form-label">Color</label><div class="color-picker">'+DECK_COLORS.map(function(c){return'<div class="color-swatch '+(c===newDeckColor?'sel':'')+'" style="background:'+c+';" onclick="newDeckColor=\''+c+'\';document.querySelectorAll(\'.color-swatch\').forEach(function(s){s.classList.remove(\'sel\');});this.classList.add(\'sel\');SFX.pop();"></div>';}).join('')+'</div></div><button class="btn btn-primary btn-full" onclick="createDeck()">Create Deck</button></div>';}
function createDeck(){var name=document.getElementById('new-deck-name').value.trim();if(!name){showToast('Please name your deck');SFX.error();return;}if(!S.decks)S.decks=[];S.decks.push({name:name,subject:document.getElementById('new-deck-subj').value.trim(),color:newDeckColor,cards:[]});save();if(S.decks.length>=5)unlock('five_decks');renderFCDecks();renderFCCreate();showToast('Deck created! +10 XP');addXP(10);switchFcTab('decks',document.querySelector('.fc-tab'));SFX.correct();}
function deleteDeck(i){if(!confirm('Delete this deck?'))return;S.decks.splice(i,1);save();renderFCDecks();showToast('Deck deleted');SFX.erase();}
function openDeck(i){fcDeckIdx=i;fcCardIdx=0;fcFlipped=false;renderFCStudy();switchFcTab('study',null);}
function renderFCStudy(){var deck=S.decks[fcDeckIdx];var el=document.getElementById('fc-study');var card=deck.cards[fcCardIdx];el.innerHTML='<div style="display:flex;align-items:center;margin-bottom:12px;"><button class="btn btn-ghost btn-sm" onclick="SFX.tap();switchFcTab(\'decks\',document.querySelector(\'.fc-tab\'))">← Back</button><span style="font-size:14px;font-weight:800;flex:1;text-align:center;">'+esc(deck.name)+'</span><span class="pill">'+deck.cards.length+' cards</span></div>'+(deck.cards.length===0?'<div class="empty-state"><span class="empty-icon">🃏</span><h3>No cards yet!</h3><p>Add cards below to get started.</p></div>':'<div class="fc-scene" onclick="flipCard()"><div class="fc-inner" id="fc-inner"><div class="fc-face"><div class="fc-face-label">Front</div><div class="fc-face-text">'+esc(card.front)+'</div><div class="fc-face-hint">Tap to flip</div></div><div class="fc-face fc-back-face"><div class="fc-face-label">Back</div><div class="fc-face-text">'+esc(card.back)+'</div></div></div></div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><button class="btn btn-ghost btn-sm" onclick="SFX.tap();prevCard()" '+(fcCardIdx===0?'disabled style="opacity:0.3"':'')+'>← Prev</button><span style="font-size:13px;font-weight:800;color:var(--text3);">'+(fcCardIdx+1)+' / '+deck.cards.length+'</span><button class="btn btn-ghost btn-sm" onclick="SFX.tap();nextCard()" '+(fcCardIdx>=deck.cards.length-1?'disabled style="opacity:0.3"':'')+'>Next →</button></div><div class="fc-rate-btns"><div class="fc-rate fc-again" onclick="rateCard(0)">Again</div><div class="fc-rate fc-hard" onclick="rateCard(1)">Hard</div><div class="fc-rate fc-good" onclick="rateCard(2)">Good</div></div>')+'<div style="display:flex;gap:8px;margin-bottom:12px;"><button class="btn btn-mint btn-sm" style="flex:1;" onclick="SFX.tap();shareCurrentDeck()">📤 Share Deck</button></div><div class="section-label" style="margin-top:16px;">Add Card to Deck</div><div class="create-deck-form"><div class="form-group"><label class="form-label">Front (Question/Term)</label><input class="form-input" id="add-card-front" placeholder="e.g. What is mitosis?"></div><div class="form-group"><label class="form-label">Back (Answer/Definition)</label><textarea class="form-input" id="add-card-back" rows="3" placeholder="e.g. Cell division producing two identical daughter cells"></textarea></div><button class="btn btn-mint btn-full" onclick="addCardToDeck()">Add Card</button></div>';el.classList.add('active');}
function flipCard(){fcFlipped=!fcFlipped;var inner=document.getElementById('fc-inner');if(inner)inner.classList.toggle('flipped',fcFlipped);SFX.flip();unlock('first_fc');}
function prevCard(){if(fcCardIdx>0){fcCardIdx--;fcFlipped=false;renderFCStudy();}}
function nextCard(){var deck=S.decks[fcDeckIdx];if(fcCardIdx<deck.cards.length-1){fcCardIdx++;fcFlipped=false;renderFCStudy();}}
function rateCard(rating){var deck=S.decks[fcDeckIdx];if(!deck||!deck.cards[fcCardIdx])return;deck.cards[fcCardIdx].rating=rating;save();SFX.select();if(rating===2){addXP(5);showToast('Nice! +5 XP');}if(fcCardIdx<deck.cards.length-1){fcCardIdx++;fcFlipped=false;renderFCStudy();}else{showToast('Deck complete! +20 XP');addXP(20);SFX.success();}}
function addCardToDeck(){var f=document.getElementById('add-card-front').value.trim();var b=document.getElementById('add-card-back').value.trim();if(!f||!b){showToast('Please fill in both front and back');SFX.error();return;}S.decks[fcDeckIdx].cards.push({front:f,back:b,rating:-1,created:Date.now()});save();renderFCStudy();showToast('Card added! +5 XP');addXP(5);SFX.correct();}
function shareCurrentDeck(){
  if(!S.decks||!S.decks[fcDeckIdx])return;
  var deck=S.decks[fcDeckIdx];
  document.getElementById('share-title').value=deck.name;
  document.getElementById('share-desc').value=(deck.subject||'')+ ' - '+deck.cards.length+' flashcards';
  document.getElementById('share-content').value=deck.cards.map(function(c){return c.front+'|'+c.back;}).join('\n');
  document.getElementById('share-tags').value=(deck.subject||'').toLowerCase();
  shareType='flashcards';
  document.querySelectorAll('.share-type').forEach(function(t){t.classList.remove('sel');});
  document.querySelector('.share-type').classList.add('sel');
  document.getElementById('share-modal').classList.add('show');
}

// ═══════════ AI FLASHCARD GENERATION ═══════════
function renderFCAI(){document.getElementById('fc-ai').innerHTML='<div class="ai-gen-box"><h4>🤖 AI Flashcard Generator</h4><p>Upload a document or paste text to automatically generate flashcards from your study material.</p><div class="upload-area" id="fc-upload-area" onclick="document.getElementById(\'fc-file-input\').click()" ondragover="event.preventDefault();this.classList.add(\'drag\')" ondragleave="this.classList.remove(\'drag\')" ondrop="event.preventDefault();this.classList.remove(\'drag\');handleFCFile(event.dataTransfer.files[0])"><span class="upload-icon">📤</span><div class="upload-text">Tap to upload or drag a file</div><div class="upload-hint">Supports PDF, TXT, and images (OCR)</div><input type="file" id="fc-file-input" accept=".pdf,.txt,.png,.jpg,.jpeg,.webp" style="display:none" onchange="handleFCFile(this.files[0])"></div><div id="fc-upload-status"></div><div class="form-group"><label class="form-label">Or Paste Text</label><textarea class="form-input" id="fc-ai-text" rows="5" placeholder="Paste your notes, textbook content, or any study material here..."></textarea></div><div class="form-group"><label class="form-label">Number of Cards</label><select class="form-input" id="fc-ai-count"><option value="5">5 cards</option><option value="10" selected>10 cards</option><option value="15">15 cards</option><option value="20">20 cards</option></select></div><div class="form-group"><label class="form-label">Deck Name</label><input class="form-input" id="fc-ai-deck" placeholder="e.g. Chapter 5 Review"></div><button class="btn btn-primary btn-full" onclick="generateAICards()">✨ Generate Flashcards</button></div>';}

function handleFCFile(file){if(!file)return;var status=document.getElementById('fc-upload-status');status.innerHTML='<div style="padding:12px 16px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px;background:var(--blue-soft);color:var(--blue);border:1px solid rgba(91,156,245,0.3);"><span class="spinner"></span> Processing '+esc(file.name)+'...</div>';var ext=file.name.split('.').pop().toLowerCase();if(ext==='txt'){var reader=new FileReader();reader.onload=function(e){document.getElementById('fc-ai-text').value=e.target.result;status.innerHTML='<div style="padding:12px 16px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px;background:var(--green-soft);color:var(--green);border:1px solid rgba(67,217,173,0.3);">✅ Text loaded: '+esc(file.name)+'</div>';SFX.correct();};reader.readAsText(file);}else if(ext==='pdf'){extractPDFText(file,function(text){document.getElementById('fc-ai-text').value=text;status.innerHTML='<div style="padding:12px 16px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px;background:var(--green-soft);color:var(--green);border:1px solid rgba(67,217,173,0.3);">✅ PDF extracted: '+esc(file.name)+'</div>';SFX.correct();},function(err){status.innerHTML='<div style="padding:12px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;background:var(--red-soft);color:var(--red);border:1px solid rgba(240,96,96,0.3);">❌ '+err+'</div>';SFX.error();});}else if(['png','jpg','jpeg','webp'].indexOf(ext)>=0){extractImageText(file,function(text){document.getElementById('fc-ai-text').value=text;status.innerHTML='<div style="padding:12px 16px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;background:var(--green-soft);color:var(--green);border:1px solid rgba(67,217,173,0.3);">✅ OCR complete: '+esc(file.name)+'</div>';SFX.correct();},function(err){status.innerHTML='<div style="padding:12px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;background:var(--red-soft);color:var(--red);border:1px solid rgba(240,96,96,0.3);">❌ '+err+'</div>';SFX.error();});}else{status.innerHTML='<div style="padding:12px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;background:var(--red-soft);color:var(--red);border:1px solid rgba(240,96,96,0.3);">❌ Unsupported file type</div>';SFX.error();}}

function extractPDFText(file,cb,errCb){try{var reader=new FileReader();reader.onload=function(e){var arr=new Uint8Array(e.target.result);pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';pdfjsLib.getDocument({data:arr}).promise.then(function(pdf){var text='';var pages=pdf.numPages;var loaded=0;for(var i=1;i<=pages;i++){pdf.getPage(i).then(function(page){return page.getTextContent();}).then(function(content){text+=content.items.map(function(it){return it.str;}).join(' ')+'\n';loaded++;if(loaded===pages)cb(text.trim());});}}).catch(function(err){errCb('Could not read PDF');});};reader.readAsArrayBuffer(file);}catch(e){errCb('PDF processing failed');}}

function extractImageText(file,cb,errCb){try{Tesseract.recognize(file,'eng',{logger:function(){}}).then(function(r){cb(r.data.text);}).catch(function(e){errCb('OCR failed');});}catch(e){errCb('OCR not available');}}

function generateAICards(){var text=document.getElementById('fc-ai-text').value.trim();if(!text||text.length<30){showToast('Please provide more text (at least 30 characters)');SFX.error();return;}var count=parseInt(document.getElementById('fc-ai-count').value);var deckName=document.getElementById('fc-ai-deck').value.trim()||'AI Generated Deck';var sentences=text.replace(/([.!?])\s+/g,'$1|||').split('|||').filter(function(s){return s.trim().length>15;});var cards=[];var keyPhrases=extractKeyPhrases(text);for(var i=0;i<Math.min(count,Math.max(sentences.length,keyPhrases.length));i++){if(i<keyPhrases.length){cards.push({front:'What is '+keyPhrases[i].term+'?',back:keyPhrases[i].context,rating:-1,created:Date.now()});}else if(i<sentences.length){var s=sentences[i%sentences.length].trim();if(s.length>20){var words=s.split(/\s+/);var blankIdx=Math.floor(words.length*0.3)+Math.floor(Math.random()*(words.length*0.4));var answer=words[blankIdx]||words[0];var q=words.map(function(w,j){return j===blankIdx?'_____':w;}).join(' ');cards.push({front:'Fill in the blank: '+q,back:'Answer: '+answer+'\n\nFull: '+s,rating:-1,created:Date.now()});}}}if(cards.length===0){showToast('Could not generate cards. Try more content.');SFX.error();return;}if(!S.decks)S.decks=[];S.decks.push({name:deckName,subject:'AI Generated',color:DECK_COLORS[S.decks.length%DECK_COLORS.length],cards:cards});save();showToast(cards.length+' cards generated! +'+cards.length*5+' XP');addXP(cards.length*5);SFX.success();burst(window.innerWidth/2,window.innerHeight/2);renderFCDecks();switchFcTab('decks',document.querySelector('.fc-tab'));}

function extractKeyPhrases(text){var phrases=[];var patterns=[/(?:^|\. )([A-Z][^.]*?)\s+(?:is|are|was|were|refers to|means|describes|involves)\s+([^.]+\.)/gm,/(?:^|\. )([A-Z][^.]*?)\s*[-:]\s*([^.]+\.)/gm,/(?:The|A|An)\s+(\w[\w\s]{2,30}?)\s+(?:is|are|was|were)\s+(?:a|an|the)?\s*([^.]+\.)/gim];patterns.forEach(function(pat){var m;while((m=pat.exec(text))!==null&&phrases.length<25){var term=m[1].trim().replace(/^(The|A|An)\s+/i,'');if(term.length>2&&term.length<60)phrases.push({term:term,context:m[0].trim()});}});var seen={};return phrases.filter(function(p){var k=p.term.toLowerCase();if(seen[k])return false;seen[k]=true;return true;});}

// ═══════════ BLURTING ═══════════
var blurtPhase='setup',blurtTimer=null,blurtSecs=0,blurtText='';
function initBlurt(){blurtPhase='setup';renderBlurt();}
function renderBlurt(){var el=document.getElementById('blurt-body');if(blurtPhase==='setup'){el.innerHTML='<div style="text-align:center;padding:20px 0;"><span style="font-size:52px;">✍️</span><div style="font-family:\'Baloo 2\',sans-serif;font-size:22px;font-weight:800;margin:10px 0 4px;">Blurting Technique</div><div style="font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.6;">Study a topic, then write everything you remember without looking. Compare to find gaps.</div></div><div class="form-group"><label class="form-label">Topic</label><input class="form-input" id="blurt-topic" placeholder="e.g. Cell division"></div><div class="form-group"><label class="form-label">Timer (minutes)</label><select class="form-input" id="blurt-time"><option value="3">3 min</option><option value="5" selected>5 min</option><option value="10">10 min</option></select></div><button class="btn btn-primary btn-full" onclick="SFX.tap();startBlurt()">Start Blurting</button>';}else if(blurtPhase==='writing'){el.innerHTML='<div class="phase-badge" style="background:var(--pink-soft);color:var(--pink);">✍️ Blurt Phase - Write everything you remember</div><div class="blurt-timer-big" id="blurt-clock">'+formatTime(blurtSecs)+'</div><textarea class="form-input" id="blurt-text" rows="10" placeholder="Start writing everything you remember..." style="font-size:14px;line-height:1.8;"></textarea><button class="btn btn-mint btn-full" style="margin-top:12px;" onclick="SFX.tap();finishBlurt()">Finish & Compare</button>';}else if(blurtPhase==='compare'){el.innerHTML='<div class="phase-badge" style="background:var(--green-soft);color:var(--green);">✅ Compare Phase</div><div class="compare-grid"><div class="compare-box"><h5>Your Blurt</h5><div>'+esc(blurtText)+'</div></div><div class="compare-box"><h5>Notes (paste to compare)</h5><textarea class="form-input" id="blurt-notes" rows="5" placeholder="Paste your actual notes here..." style="min-height:80px;font-size:11px;border:none;padding:0;background:transparent;box-shadow:none;"></textarea></div></div><div style="text-align:center;padding:8px 0 16px;"><div style="display:flex;gap:8px;justify-content:center;"><button class="btn btn-mint" onclick="SFX.correct();finishBlurtSession()">Complete +30 XP</button><button class="btn btn-secondary" onclick="SFX.tap();shareBlurt()">📤 Share</button></div></div>';}}
function startBlurt(){var topic=document.getElementById('blurt-topic').value.trim();if(!topic){showToast('Enter a topic first');SFX.error();return;}blurtSecs=parseInt(document.getElementById('blurt-time').value)*60;blurtPhase='writing';renderBlurt();blurtTimer=setInterval(function(){blurtSecs--;var cl=document.getElementById('blurt-clock');if(cl)cl.textContent=formatTime(blurtSecs);if(blurtSecs<=0){clearInterval(blurtTimer);SFX.timer();finishBlurt();}},1000);}
function finishBlurt(){if(blurtTimer){clearInterval(blurtTimer);blurtTimer=null;}blurtText=(document.getElementById('blurt-text')?document.getElementById('blurt-text').value:'');blurtPhase='compare';renderBlurt();}
function finishBlurtSession(){addXP(30);S.blurtCt=(S.blurtCt||0)+1;save();unlock('first_blurt');if(S.blurtCt>=10)unlock('blurt_10');showToast('Blurt session done! +30 XP');SFX.success();burst(window.innerWidth/2,window.innerHeight/3);blurtPhase='setup';renderBlurt();}
function shareBlurt(){
  document.getElementById('share-title').value='Blurting: '+(document.getElementById('blurt-topic')?document.getElementById('blurt-topic').value:'My Notes');
  document.getElementById('share-desc').value='Brain dump session - blurting technique';
  document.getElementById('share-content').value=blurtText;
  document.getElementById('share-tags').value='blurting,notes';
  shareType='notes';showShareModal();
}

// ═══════════ QUESTION METHOD (CORNELL) ═══════════
function initCornell(){document.getElementById('cornell-body').innerHTML='<div style="text-align:center;padding:16px 0;"><span style="font-size:48px;">❓</span><div style="font-family:\'Baloo 2\',sans-serif;font-size:22px;font-weight:800;margin:8px 0 4px;">Question Method</div><div style="font-size:13px;color:var(--text2);margin-bottom:20px;">Create questions in one column, answers in another.</div></div><div class="cornell-grid"><div><div class="cornell-lbl">Questions / Cues</div><textarea class="form-input" id="cornell-q" rows="12" placeholder="Write questions here..." style="font-size:13px;"></textarea></div><div><div class="cornell-lbl">Notes / Answers</div><textarea class="form-input" id="cornell-a" rows="12" placeholder="Write answers here..." style="font-size:13px;"></textarea></div></div><div class="form-group"><div class="cornell-lbl">Summary</div><textarea class="form-input" id="cornell-s" rows="3" placeholder="Write a brief summary..."></textarea></div><div style="display:flex;gap:8px;"><button class="btn btn-mint" style="flex:1;" onclick="SFX.correct();saveCornell()">Save +25 XP</button><button class="btn btn-secondary" onclick="SFX.tap();shareCornell()">📤 Share</button></div>';}
function saveCornell(){addXP(25);S.mins=(S.mins||0)+15;save();showToast('Cornell notes saved! +25 XP');SFX.success();burst(window.innerWidth/2,window.innerHeight/3);}
function shareCornell(){
  var q=document.getElementById('cornell-q')?document.getElementById('cornell-q').value:'';
  var a=document.getElementById('cornell-a')?document.getElementById('cornell-a').value:'';
  document.getElementById('share-title').value='Cornell Notes';
  document.getElementById('share-desc').value='Question method study notes';
  document.getElementById('share-content').value='QUESTIONS:\n'+q+'\n\nANSWERS:\n'+a;
  document.getElementById('share-tags').value='cornell,questions,notes';
  shareType='notes';showShareModal();
}

// ═══════════ FEYNMAN TECHNIQUE ═══════════
var feynStep=0;
function initFeynman(){feynStep=0;renderFeynman();}
function renderFeynman(){var steps=['Choose Topic','Explain Simply','Find Gaps','Refine'];document.getElementById('feynman-body').innerHTML='<div class="feynman-steps">'+steps.map(function(s,i){return'<div class="feynman-step '+(i===feynStep?'active':'')+'" onclick="feynStep='+i+';renderFeynman();SFX.tap();">'+s+'</div>';}).join('')+'</div><div style="padding:16px;">'+getFeynmanContent()+'</div>';}
function getFeynmanContent(){if(feynStep===0)return'<div style="text-align:center;padding:20px 0;"><span style="font-size:48px;">🧑‍🏫</span><div style="font-family:\'Baloo 2\',sans-serif;font-size:20px;font-weight:800;margin:8px 0;">Pick Your Topic</div></div><div class="form-group"><label class="form-label">Topic</label><input class="form-input" id="feyn-topic" placeholder="e.g. Photosynthesis"></div><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=1;renderFeynman();">Next: Explain It</button>';if(feynStep===1)return'<div class="phase-badge" style="background:var(--orange-soft);color:var(--orange);">🧑‍🏫 Explain like teaching a child</div><textarea class="form-input" id="feyn-explain" rows="8" placeholder="Explain the topic in the simplest possible words..."></textarea><button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="SFX.tap();feynStep=2;renderFeynman();">Next: Find Gaps</button>';if(feynStep===2)return'<div class="phase-badge" style="background:var(--red-soft);color:var(--red);">🔍 Where did you struggle?</div><textarea class="form-input" id="feyn-gaps" rows="6" placeholder="List areas where your explanation felt weak..."></textarea><button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="SFX.tap();feynStep=3;renderFeynman();">Next: Refine</button>';if(feynStep===3)return'<div class="phase-badge" style="background:var(--green-soft);color:var(--green);">✨ Refine your explanation</div><textarea class="form-input" id="feyn-refined" rows="8" placeholder="Write your refined, clear explanation..."></textarea><div style="display:flex;gap:8px;margin-top:12px;"><button class="btn btn-mint" style="flex:1;" onclick="SFX.correct();finishFeynman();">Complete +35 XP</button><button class="btn btn-secondary" onclick="SFX.tap();shareFeynman()">📤 Share</button></div>';return'';}
function finishFeynman(){addXP(35);S.feynmanCt=(S.feynmanCt||0)+1;save();if(S.feynmanCt>=5)unlock('feynman_5');showToast('Feynman session done! +35 XP');SFX.success();burst(window.innerWidth/2,window.innerHeight/3);feynStep=0;renderFeynman();}
function shareFeynman(){
  var explanation=document.getElementById('feyn-refined')?document.getElementById('feyn-refined').value:'';
  var topic=document.getElementById('feyn-topic')?document.getElementById('feyn-topic').value:'';
  document.getElementById('share-title').value='Feynman: '+topic;
  document.getElementById('share-desc').value='Simple explanation using the Feynman technique';
  document.getElementById('share-content').value=explanation;
  document.getElementById('share-tags').value='feynman,explanation';
  shareType='notes';showShareModal();
}

// ═══════════ READ, RECITE, REVIEW ═══════════
var rrrPhase='read';
function initRRR(){rrrPhase='read';renderRRR();}
function renderRRR(){document.getElementById('rrr-body').innerHTML='<div class="rrr-btns"><div class="rrr-btn '+(rrrPhase==='read'?'active':'')+'" onclick="rrrPhase=\'read\';renderRRR();SFX.tap();">📖 Read</div><div class="rrr-btn '+(rrrPhase==='recite'?'active':'')+'" onclick="rrrPhase=\'recite\';renderRRR();SFX.tap();">🗣 Recite</div><div class="rrr-btn '+(rrrPhase==='review'?'active':'')+'" onclick="rrrPhase=\'review\';renderRRR();SFX.tap();">✅ Review</div></div>'+getRRRContent();}
function getRRRContent(){if(rrrPhase==='read')return'<div style="text-align:center;margin-bottom:16px;"><span style="font-size:42px;">📖</span><div style="font-size:13px;color:var(--text2);margin-top:8px;">Read through your material carefully.</div></div><div class="form-group"><label class="form-label">Your reading material</label><textarea class="form-input" id="rrr-read" rows="10" placeholder="Paste the text you need to study..."></textarea></div><button class="btn btn-primary btn-full" onclick="SFX.tap();rrrPhase=\'recite\';renderRRR();">Done Reading → Recite</button>';if(rrrPhase==='recite')return'<div style="text-align:center;margin-bottom:16px;"><span style="font-size:42px;">🗣</span><div style="font-size:13px;color:var(--text2);margin-top:8px;">Close your notes and write everything you remember!</div></div><textarea class="form-input" id="rrr-recite" rows="10" placeholder="Write everything you remember..."></textarea><button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="SFX.tap();rrrPhase=\'review\';renderRRR();">Done → Review</button>';if(rrrPhase==='review')return'<div style="text-align:center;margin-bottom:16px;"><span style="font-size:42px;">✅</span><div style="font-size:13px;color:var(--text2);margin-top:8px;">Compare what you wrote with the original. Note gaps!</div></div><div class="form-group"><label class="form-label">Review Notes</label><textarea class="form-input" id="rrr-review" rows="6" placeholder="Write what you missed..."></textarea></div><div style="display:flex;gap:8px;"><button class="btn btn-mint" style="flex:1;" onclick="SFX.correct();finishRRR();">Complete +25 XP</button><button class="btn btn-secondary" onclick="SFX.tap();shareRRR()">📤 Share</button></div>';return'';}
function finishRRR(){addXP(25);S.mins=(S.mins||0)+20;save();showToast('RRR session done! +25 XP');SFX.success();burst(window.innerWidth/2,window.innerHeight/3);rrrPhase='read';renderRRR();}
function shareRRR(){
  document.getElementById('share-title').value='RRR Study Notes';
  document.getElementById('share-desc').value='Read, Recite, Review session notes';
  document.getElementById('share-content').value=document.getElementById('rrr-review')?document.getElementById('rrr-review').value:'';
  document.getElementById('share-tags').value='rrr,review,notes';
  shareType='notes';showShareModal();
}

// ═══════════ WHITEBOARD ═══════════
var wbCtx=null,wbDrawing=false,wbColor='#7c5ce0',wbSize=3,wbTool='pen',wbLast={x:0,y:0};
var WB_COLORS=['#7c5ce0','#e87bb0','#f5c542','#43d9ad','#5b9cf5','#f09348','#2a1f5e','#ffffff'];
var WB_SIZES=[2,4,8];
function initWB(){var c=document.getElementById('wbCanvas');var w=c.parentElement;c.width=w.clientWidth;c.height=w.clientHeight;wbCtx=c.getContext('2d');wbCtx.lineCap='round';wbCtx.lineJoin='round';wbCtx.fillStyle=currentTheme==='dark'?'#1a1235':'#f5f0ff';wbCtx.fillRect(0,0,c.width,c.height);renderWBToolbar();c.addEventListener('pointerdown',wbDown);c.addEventListener('pointermove',wbMove);c.addEventListener('pointerup',wbUp);c.addEventListener('pointerleave',wbUp);}
function renderWBToolbar(){document.getElementById('wb-toolbar').innerHTML='<div class="wb-colors">'+WB_COLORS.map(function(col){return'<div class="wb-color '+(col===wbColor?'sel':'')+'" style="background:'+col+';'+(col==='#ffffff'?'border:1px solid var(--border);':'')+'" onclick="wbColor=\''+col+'\';renderWBToolbar();SFX.pop();"></div>';}).join('')+'</div><div class="wb-sizes">'+WB_SIZES.map(function(sz){return'<div class="wb-sz '+(sz===wbSize?'sel':'')+'" onclick="wbSize='+sz+';renderWBToolbar();SFX.pop();">'+sz+'</div>';}).join('')+'</div><div class="wb-tools"><div class="wb-tool '+(wbTool==='pen'?'sel':'')+'" onclick="wbTool=\'pen\';renderWBToolbar();SFX.pop();">✏️</div><div class="wb-tool '+(wbTool==='eraser'?'sel':'')+'" onclick="wbTool=\'eraser\';renderWBToolbar();SFX.pop();">🧹</div></div>';}
function wbDown(e){wbDrawing=true;var r=e.target.getBoundingClientRect();wbLast={x:e.clientX-r.left,y:e.clientY-r.top};}
function wbMove(e){if(!wbDrawing||!wbCtx)return;var r=e.target.getBoundingClientRect();var x=e.clientX-r.left,y=e.clientY-r.top;wbCtx.beginPath();wbCtx.moveTo(wbLast.x,wbLast.y);wbCtx.lineTo(x,y);if(wbTool==='eraser'){wbCtx.strokeStyle=currentTheme==='dark'?'#1a1235':'#f5f0ff';wbCtx.lineWidth=wbSize*6;}else{wbCtx.strokeStyle=wbColor;wbCtx.lineWidth=wbSize;}wbCtx.stroke();wbLast={x:x,y:y};}
function wbUp(){wbDrawing=false;}
function wbClear(){if(!wbCtx)return;var c=document.getElementById('wbCanvas');wbCtx.fillStyle=currentTheme==='dark'?'#1a1235':'#f5f0ff';wbCtx.fillRect(0,0,c.width,c.height);SFX.erase();}
function wbSave(){addXP(20);S.mins=(S.mins||0)+15;save();unlock('first_wb');showToast('Brain dump saved! +20 XP');SFX.success();}

// ═══════════ DIAGRAM ═══════════
var diagNodes=[],diagEdges=[],diagDragging=null,diagOffset={x:0,y:0},diagSelNodes=[],diagNodeColor=DECK_COLORS[0];
function initDiag(){diagNodes=[];diagEdges=[];diagSelNodes=[];renderDiagToolbar();renderDiagNodes();drawDiagEdges();var wrap=document.getElementById('diag-wrap');wrap.onclick=function(e){if(e.target===wrap||e.target.id==='diagCanvas'){var r=wrap.getBoundingClientRect();addDiagNode('Node '+(diagNodes.length+1),e.clientX-r.left-40,e.clientY-r.top-16);}};var c=document.getElementById('diagCanvas');c.width=wrap.clientWidth;c.height=wrap.clientHeight;}
function renderDiagToolbar(){document.getElementById('diag-toolbar').innerHTML='<input class="diag-add-input" id="diag-text" placeholder="Node text..." maxlength="60"><button class="btn btn-sm btn-primary" onclick="SFX.tap();addDiagNodeBtn()">+ Add</button>'+DECK_COLORS.slice(0,6).map(function(c){return'<div class="diag-color '+(c===diagNodeColor?'sel':'')+'" style="background:'+c+';" onclick="diagNodeColor=\''+c+'\';renderDiagToolbar();SFX.pop();"></div>';}).join('');}
function addDiagNodeBtn(){var txt=document.getElementById('diag-text').value.trim()||'Node '+(diagNodes.length+1);addDiagNode(txt,80+Math.random()*150,60+Math.random()*200);document.getElementById('diag-text').value='';}
function addDiagNode(txt,x,y){diagNodes.push({text:txt,x:x,y:y,color:diagNodeColor,id:Date.now()});renderDiagNodes();SFX.pop();}
function renderDiagNodes(){var el=document.getElementById('diag-nodes');el.innerHTML=diagNodes.map(function(n,i){var isSel=diagSelNodes.indexOf(i)>=0;var isRoot=i===0;return'<div class="diag-node '+(isRoot?'root':'')+'" style="left:'+n.x+'px;top:'+n.y+'px;background:'+n.color+'22;border-color:'+n.color+';color:'+n.color+';'+(isSel?'box-shadow:0 0 0 3px '+n.color+'55;':'')+'" data-idx="'+i+'" onpointerdown="diagStartDrag(event,'+i+')" onclick="diagSelectNode('+i+')">'+esc(n.text)+'<div class="diag-node-del" onclick="event.stopPropagation();diagDelNode('+i+')">×</div></div>';}).join('');}
function diagStartDrag(e,idx){diagDragging=idx;var r=e.target.closest('.diag-node').getBoundingClientRect();diagOffset={x:e.clientX-r.left,y:e.clientY-r.top};function move(ev){if(diagDragging===null)return;var wr=document.getElementById('diag-wrap').getBoundingClientRect();diagNodes[diagDragging].x=ev.clientX-wr.left-diagOffset.x;diagNodes[diagDragging].y=ev.clientY-wr.top-diagOffset.y;renderDiagNodes();drawDiagEdges();}function up(){diagDragging=null;document.removeEventListener('pointermove',move);document.removeEventListener('pointerup',up);}document.addEventListener('pointermove',move);document.addEventListener('pointerup',up);e.preventDefault();}
function diagSelectNode(idx){if(diagSelNodes.indexOf(idx)===-1)diagSelNodes.push(idx);else diagSelNodes=diagSelNodes.filter(function(i){return i!==idx;});renderDiagNodes();}
function diagConnect(){if(diagSelNodes.length<2){showToast('Select 2 nodes to connect');return;}for(var i=0;i<diagSelNodes.length-1;i++){var a=diagSelNodes[i],b=diagSelNodes[i+1];var exists=diagEdges.some(function(e){return(e[0]===a&&e[1]===b)||(e[0]===b&&e[1]===a);});if(!exists)diagEdges.push([a,b]);}diagSelNodes=[];renderDiagNodes();drawDiagEdges();SFX.correct();}
function drawDiagEdges(){var c=document.getElementById('diagCanvas');var ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);diagEdges.forEach(function(e){var a=diagNodes[e[0]],b=diagNodes[e[1]];if(!a||!b)return;ctx.beginPath();ctx.moveTo(a.x+40,a.y+16);ctx.lineTo(b.x+40,b.y+16);ctx.strokeStyle=a.color||'#7c5ce0';ctx.lineWidth=2;ctx.setLineDash([6,4]);ctx.stroke();ctx.setLineDash([]);});}
function diagDelNode(idx){diagNodes.splice(idx,1);diagEdges=diagEdges.filter(function(e){return e[0]!==idx&&e[1]!==idx;}).map(function(e){return[e[0]>idx?e[0]-1:e[0],e[1]>idx?e[1]-1:e[1]];});diagSelNodes=[];renderDiagNodes();drawDiagEdges();SFX.erase();}
function diagClear(){diagNodes=[];diagEdges=[];diagSelNodes=[];renderDiagNodes();drawDiagEdges();SFX.erase();}
function diagSave(){addXP(25);S.diagCt=(S.diagCt||0)+1;save();if(S.diagCt>=5)unlock('diagram_5');showToast('Diagram saved! +25 XP');SFX.success();}

// ═══════════ SCHEDULE ═══════════
function renderSched(){var days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];var now=new Date();var today=now.getDay();var startOfWeek=new Date(now);startOfWeek.setDate(now.getDate()-today);document.getElementById('sched-week').innerHTML=days.map(function(d,i){var date=new Date(startOfWeek);date.setDate(startOfWeek.getDate()+i);var dateStr=date.toISOString().split('T')[0];var hasSess=(S.sessions||[]).some(function(s){return s.date===dateStr;});var isRest=(S.restDays||[]).indexOf(dateStr)>=0;var isToday=i===today;return'<div class="sched-day '+(hasSess?'has':'')+' '+(isRest?'rest':'')+' '+(isToday?'today':'')+'"><div class="sched-dlbl">'+d+'</div><div class="sched-dnum">'+date.getDate()+'</div></div>';}).join('');}
function renderSessList(){var el=document.getElementById('sess-list');if(!S.sessions||S.sessions.length===0){el.innerHTML='<div style="text-align:center;padding:30px 0;color:var(--text3);"><div style="font-size:36px;margin-bottom:8px;">📅</div><div style="font-size:13px;">No sessions yet. Tap + Add!</div></div>';return;}el.innerHTML=S.sessions.slice().sort(function(a,b){return b.created-a.created;}).map(function(s,i){var t=TECHNIQUES.find(function(x){return x.id===s.technique;});return'<div class="sess-item"><div class="sess-dot" style="background:'+(t?t.cval:'var(--purple)')+';"></div><div class="sess-info"><h4>'+(t?t.icon:'📚')+' '+esc(s.subject)+'</h4><p>'+s.duration+' min · '+(t?t.name:s.technique)+'</p></div><div class="sess-time">'+s.time+'</div><button onclick="event.stopPropagation();deleteSession('+i+')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:14px;margin-left:6px;">×</button></div>';}).join('');}
function showAddSessionModal(){document.getElementById('session-modal').classList.add('show');}
function hideAddSessionModal(){document.getElementById('session-modal').classList.remove('show');}
function confirmAddSession(){var subj=document.getElementById('modal-subject').value.trim();if(!subj){showToast('Please enter a subject');SFX.error();return;}var tech=document.getElementById('modal-technique').value;var dur=parseInt(document.getElementById('modal-duration').value)||30;var time=tpH+':'+(tpM<10?'0':'')+tpM+' '+tpAMPM;var today=new Date().toISOString().split('T')[0];if(!S.sessions)S.sessions=[];S.sessions.push({subject:subj,technique:tech,duration:dur,time:time,date:today,created:Date.now()});save();unlock('first_sched');hideAddSessionModal();renderSched();renderSessList();showToast('Session added!');SFX.correct();addXP(10);checkStreak();}
function deleteSession(i){S.sessions.splice(i,1);save();renderSessList();renderSched();showToast('Session removed');SFX.erase();}
function toggleRest(){var today=new Date().toISOString().split('T')[0];if(!S.restDays)S.restDays=[];var idx=S.restDays.indexOf(today);if(idx>=0){S.restDays.splice(idx,1);showToast('Rest day removed');}else{S.restDays.push(today);showToast('Rest day added! Recovery is important 🧘');}save();renderSched();}

// ═══════════ TIMER ═══════════
var timerInt=null;
function toggleTimer(){if(!timerOn){timerOn=true;document.getElementById('timer-btn').textContent='Pause';timerInt=setInterval(tickTimer,1000);document.getElementById('timer-ring').classList.add(timerPhase==='focus'?'focus-mode':'break-mode');}else{timerOn=false;document.getElementById('timer-btn').textContent='Resume';clearInterval(timerInt);document.getElementById('timer-ring').classList.remove('focus-mode','break-mode');}}
function resetTimer(){timerOn=false;clearInterval(timerInt);timerPhase='focus';timerSecs=25*60;document.getElementById('timer-ring').textContent=formatTime(timerSecs);document.getElementById('timer-ring').classList.remove('focus-mode','break-mode');document.getElementById('timer-phase').textContent='Focus Session';document.getElementById('timer-btn').textContent='Start';}
function tickTimer(){timerSecs--;document.getElementById('timer-ring').textContent=formatTime(timerSecs);if(timerSecs<=0){clearInterval(timerInt);timerOn=false;SFX.timer();if(timerPhase==='focus'){addXP(25);S.mins=(S.mins||0)+25;save();unlock('first_timer');if((S.mins||0)>=600)unlock('hours_10');if((S.mins||0)>=3000)unlock('hours_50');showToast('Focus done! +25 XP. Take a break!');timerPhase='break';timerSecs=5*60;document.getElementById('timer-phase').textContent='Break Time ☕';document.getElementById('timer-ring').classList.remove('focus-mode');document.getElementById('timer-ring').classList.add('break-mode');}else{showToast('Break over! Ready for another focus session?');timerPhase='focus';timerSecs=25*60;document.getElementById('timer-phase').textContent='Focus Session';document.getElementById('timer-ring').classList.remove('break-mode');}document.getElementById('timer-ring').textContent=formatTime(timerSecs);document.getElementById('timer-btn').textContent='Start';}}
function formatTime(s){var m=Math.floor(s/60);var sec=s%60;return(m<10?'0':'')+m+':'+(sec<10?'0':'')+sec;}

// ═══════════ TIME PICKER ═══════════
function showTimePicker(){document.getElementById('time-modal').classList.add('show');document.getElementById('tp-hour').textContent=(tpH<10?'0':'')+tpH;document.getElementById('tp-min').textContent=(tpM<10?'0':'')+tpM;updateAMPMBtns();renderTimePresets();}
function hideTimePicker(){document.getElementById('time-modal').classList.remove('show');}
function spinTime(unit,dir){SFX.pop();if(unit==='h'){tpH+=dir;if(tpH>12)tpH=1;if(tpH<1)tpH=12;document.getElementById('tp-hour').textContent=(tpH<10?'0':'')+tpH;}else{tpM+=dir*5;if(tpM>=60)tpM=0;if(tpM<0)tpM=55;document.getElementById('tp-min').textContent=(tpM<10?'0':'')+tpM;}}
function setAMPM(v){tpAMPM=v;updateAMPMBtns();SFX.pop();}
function updateAMPMBtns(){document.getElementById('tp-pm-am').classList.toggle('active',tpAMPM==='AM');document.getElementById('tp-pm-pm').classList.toggle('active',tpAMPM==='PM');}
function renderTimePresets(){var presets=[{l:'6:00 AM',h:6,m:0,p:'AM'},{l:'8:00 AM',h:8,m:0,p:'AM'},{l:'10:00 AM',h:10,m:0,p:'AM'},{l:'2:00 PM',h:2,m:0,p:'PM'},{l:'4:00 PM',h:4,m:0,p:'PM'},{l:'6:00 PM',h:6,m:0,p:'PM'},{l:'8:00 PM',h:8,m:0,p:'PM'}];document.getElementById('time-presets').innerHTML=presets.map(function(p){return'<div class="time-preset" onclick="tpH='+p.h+';tpM='+p.m+';tpAMPM=\''+p.p+'\';showTimePicker();SFX.select();">'+p.l+'</div>';}).join('');}
function confirmTimePick(){var str=tpH+':'+(tpM<10?'0':'')+tpM+' '+tpAMPM;document.getElementById('modal-time-display').textContent=str+' - Tap to change';hideTimePicker();SFX.correct();}

// ═══════════ ACHIEVEMENTS ═══════════
function renderAch(){var grid=document.getElementById('ach-grid');grid.innerHTML=ACHIEVEMENTS_DEF.map(function(a){var unlocked=(S.ach||[]).indexOf(a.key)>=0;return'<div class="ach-card '+(unlocked?'unlocked':'locked')+'"><span class="ach-icon">'+(unlocked?a.icon:'🔒')+'</span><div class="ach-name">'+a.name+'</div><div class="ach-desc">'+a.desc+'</div><div class="ach-rarity r-'+a.rarity+'">'+a.rarity+'</div></div>';}).join('');document.getElementById('ach-count').textContent=(S.ach||[]).length+'/'+ACHIEVEMENTS_DEF.length;}
function unlock(key){if(!S.ach)S.ach=[];if(S.ach.indexOf(key)>=0)return;S.ach.push(key);save();var a=ACHIEVEMENTS_DEF.find(function(x){return x.key===key;});if(!a)return;document.getElementById('ap-icon').textContent=a.icon;document.getElementById('ap-name').textContent=a.name;var popup=document.getElementById('ach-popup');popup.classList.add('show');SFX.unlock();burst(window.innerWidth/2,60,['#f5c542','#f09348','#e87bb0','#43d9ad'],16);setTimeout(function(){popup.classList.remove('show');},3500);if(S.ach.length>=ACHIEVEMENTS_DEF.length-1)unlock('all_ach');}

// ═══════════ XP & STREAK ═══════════
function addXP(n){S.xp=(S.xp||0)+n;save();checkStreak();}
function checkStreak(){var today=new Date().toISOString().split('T')[0];if(S.lastStudy===today)return;var yest=new Date();yest.setDate(yest.getDate()-1);var yestStr=yest.toISOString().split('T')[0];if(S.lastStudy===yestStr)S.streak=(S.streak||0)+1;else if(S.lastStudy!==today)S.streak=1;S.lastStudy=today;save();if(S.streak>=3)unlock('streak_3');if(S.streak>=7)unlock('streak_7');}

// ═══════════ TOAST ═══════════
var toastTimeout=null;
function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastTimeout);toastTimeout=setTimeout(function(){t.classList.remove('show');},2800);}

// ═══════════ CHECK URL FOR SHARED REVIEWER ═══════════
function checkURLParams(){
  var params=new URLSearchParams(window.location.search);
  var reviewerId=params.get('reviewer');
  if(reviewerId){
    setTimeout(function(){
      openReviewer(reviewerId);
    },500);
  }
}

// ═══════════ BOOT ═══════════
hideSplash();
setTimeout(checkURLParams, 4500);
</script>
</body>
</html>