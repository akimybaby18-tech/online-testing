<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>StudyBuddy</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root{--bg:#e8e0f0;--surface:rgba(255,255,255,0.75);--surface2:rgba(255,255,255,0.55);--surface3:rgba(255,255,255,0.35);--border:rgba(180,160,220,0.35);--border2:rgba(160,140,200,0.45);--glass:rgba(255,255,255,0.6);--glass2:rgba(255,255,255,0.4);--purple:#8b5cf6;--purple-l:#a78bfa;--purple-d:#6d28d9;--purple-g:rgba(139,92,246,0.18);--pink:#ec4899;--pink-l:#f472b6;--pink-soft:rgba(236,72,153,0.12);--yellow:#fbbf24;--yellow-l:#fcd34d;--yellow-soft:rgba(251,191,36,0.15);--green:#10b981;--green-l:#34d399;--green-soft:rgba(16,185,129,0.12);--blue:#3b82f6;--blue-l:#60a5fa;--blue-soft:rgba(59,130,246,0.12);--orange:#f97316;--orange-l:#fb923c;--orange-soft:rgba(249,115,22,0.12);--teal:#14b8a6;--teal-l:#2dd4bf;--teal-soft:rgba(20,184,166,0.12);--red:#ef4444;--red-soft:rgba(239,68,68,0.12);--text:#2d1b69;--text2:#6b5b95;--text3:#9b8ec4;--shadow:rgba(100,60,180,0.12);--shadow2:rgba(100,60,180,0.2);--r:20px;--r-sm:14px;--r-lg:28px;--r-xl:36px;--transition:0.35s cubic-bezier(0.4,0,0.2,1);--bounce:0.5s cubic-bezier(0.34,1.56,0.64,1);--smooth:cubic-bezier(0.22,1,0.36,1)}
[data-theme="dark"]{--bg:#0f0b1a;--surface:rgba(30,24,55,0.85);--surface2:rgba(40,32,70,0.75);--surface3:rgba(50,40,85,0.6);--border:rgba(100,80,160,0.3);--border2:rgba(120,100,180,0.35);--glass:rgba(30,24,55,0.7);--glass2:rgba(40,32,70,0.5);--text:#f0e8ff;--text2:#b0a0d0;--text3:#6a5a90;--shadow:rgba(0,0,0,0.3);--shadow2:rgba(0,0,0,0.4)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;overflow:hidden;user-select:none;transition:background var(--transition),color var(--transition)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
.app-bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.bg-orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:0.3;will-change:transform}
[data-theme="dark"] .bg-orb{opacity:0.15}
.bg-orb-1{width:300px;height:300px;background:#c084fc;top:-80px;right:-60px;animation:orbFloat 8s ease-in-out infinite}
.bg-orb-2{width:250px;height:250px;background:#818cf8;bottom:100px;left:-80px;animation:orbFloat 10s ease-in-out infinite reverse}
.bg-orb-3{width:200px;height:200px;background:#f0abfc;top:40%;left:50%;animation:orbFloat 12s ease-in-out infinite 2s}
.bg-orb-4{width:180px;height:180px;background:#67e8f9;bottom:200px;right:-40px;animation:orbFloat 9s ease-in-out infinite 1s}
@keyframes orbFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-30px) scale(1.1)}}
#splash{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
.splash-bg{position:absolute;inset:0;background:linear-gradient(160deg,#1a0533 0%,#2d1b69 20%,#6d28d9 45%,#8b5cf6 60%,#a855f7 75%,#c084fc 90%,#e9d5ff 100%);background-size:600% 600%;animation:splashGradient 6s ease infinite}
@keyframes splashGradient{0%{background-position:0% 50%}25%{background-position:50% 100%}50%{background-position:100% 50%}75%{background-position:50% 0%}100%{background-position:0% 50%}}
.splash-stars{position:absolute;inset:0;overflow:hidden}.splash-star{position:absolute;border-radius:50%;background:#fff;animation:starTwinkle ease-in-out infinite}
@keyframes starTwinkle{0%,100%{opacity:0.2;transform:scale(0.8)}50%{opacity:1;transform:scale(1.5)}}
.splash-particles{position:absolute;inset:0;overflow:hidden}.splash-particle{position:absolute;border-radius:50%;animation:splashParticleFloat linear infinite}
@keyframes splashParticleFloat{0%{transform:translateY(100vh) rotate(0deg) scale(0);opacity:0}15%{opacity:1;transform:translateY(80vh) rotate(90deg) scale(1)}85%{opacity:0.8;transform:translateY(10vh) rotate(630deg) scale(0.6)}100%{transform:translateY(-10vh) rotate(720deg) scale(0);opacity:0}}
.splash-aurora{position:absolute;inset:0;overflow:hidden}
.aurora-band{position:absolute;width:200%;height:40%;left:-50%;border-radius:50%;filter:blur(60px);mix-blend-mode:screen;animation:auroraDrift linear infinite}
.aurora-band-1{top:10%;background:radial-gradient(ellipse,rgba(139,92,246,0.3),transparent 70%);animation-duration:8s}
.aurora-band-2{top:30%;background:radial-gradient(ellipse,rgba(236,72,153,0.2),transparent 70%);animation-duration:12s;animation-delay:-3s}
.aurora-band-3{top:50%;background:radial-gradient(ellipse,rgba(96,165,250,0.2),transparent 70%);animation-duration:10s;animation-delay:-6s}
@keyframes auroraDrift{0%{transform:translateX(-30%) rotate(-5deg)}50%{transform:translateX(30%) rotate(5deg)}100%{transform:translateX(-30%) rotate(-5deg)}}
.splash-rings{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
.splash-ring{position:absolute;border-radius:50%;border:1px solid rgba(255,255,255,0.08);animation:ringPulse 4s ease-out infinite}
.splash-ring:nth-child(1){width:120px;height:120px}.splash-ring:nth-child(2){width:200px;height:200px;animation-delay:0.6s}.splash-ring:nth-child(3){width:280px;height:280px;animation-delay:1.2s}.splash-ring:nth-child(4){width:360px;height:360px;animation-delay:1.8s}.splash-ring:nth-child(5){width:440px;height:440px;animation-delay:2.4s}
@keyframes ringPulse{0%{transform:scale(0.5);opacity:0.5;border-color:rgba(255,255,255,0.15)}100%{transform:scale(2.5);opacity:0;border-color:transparent}}
.splash-logo-wrap{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;opacity:0;transform:scale(0.2) translateY(40px);animation:splashLogoEntry 1.2s cubic-bezier(0.34,1.56,0.64,1) 0.8s forwards}
@keyframes splashLogoEntry{0%{opacity:0;transform:scale(0.2) translateY(40px) rotate(-15deg)}50%{opacity:1;transform:scale(1.1) translateY(-8px) rotate(3deg)}70%{transform:scale(0.95) translateY(2px) rotate(-1deg)}100%{opacity:1;transform:scale(1) translateY(0) rotate(0)}}
.logo-mark{position:relative;width:120px;height:120px;margin-bottom:20px}
.logo-book{width:80px;height:65px;position:absolute;bottom:18px;left:50%;transform:translateX(-50%);border-radius:6px 16px 16px 6px;background:linear-gradient(135deg,#8b5cf6,#a855f7);box-shadow:0 8px 30px rgba(139,92,246,0.5);animation:bookGlow 2s ease-in-out infinite alternate}
@keyframes bookGlow{0%{box-shadow:0 8px 30px rgba(139,92,246,0.4)}100%{box-shadow:0 12px 40px rgba(139,92,246,0.7),0 0 60px rgba(139,92,246,0.2)}}
.logo-book::before{content:'';position:absolute;left:0;top:0;bottom:0;width:10px;border-radius:6px 0 0 6px;background:linear-gradient(180deg,#6d28d9,#5b21b6)}
.logo-book::after{content:'';position:absolute;right:8px;top:8px;bottom:8px;left:18px;border-radius:3px;background:rgba(255,255,255,0.2);border-top:2px solid rgba(255,255,255,0.3);border-bottom:2px solid rgba(255,255,255,0.3)}
.logo-sparkle{position:absolute;opacity:0}
.splash-logo-wrap .logo-sparkle{animation:sparkleEntry 0.5s ease forwards,sparkleFloat 2s ease-in-out 2s infinite}
.logo-sparkle-1{top:0;right:10px;font-size:20px;animation-delay:1.5s,2s}.logo-sparkle-2{top:8px;left:5px;font-size:14px;animation-delay:1.7s,2s}.logo-sparkle-3{top:2px;right:35px;font-size:16px;animation-delay:1.9s,2s}
@keyframes sparkleEntry{0%{opacity:0;transform:scale(0) rotate(-180deg)}100%{opacity:1;transform:scale(1) rotate(0deg)}}
@keyframes sparkleFloat{0%,100%{transform:translateY(0) scale(1);opacity:0.8}50%{transform:translateY(-6px) scale(1.2);opacity:1}}
.logo-brain{position:absolute;top:5px;left:50%;transform:translateX(-50%);font-size:36px;opacity:0;animation:brainEntry 0.6s cubic-bezier(0.34,1.56,0.64,1) 1.1s forwards,brainBounce 2s ease-in-out 2.1s infinite}
@keyframes brainEntry{0%{opacity:0;transform:translateX(-50%) translateY(-20px) scale(0.5)}100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
@keyframes brainBounce{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-5px)}}
.logo-ring-outer{position:absolute;inset:-8px;border-radius:50%;border:2px solid transparent;border-top-color:rgba(251,191,36,0.5);border-right-color:rgba(236,72,153,0.4);opacity:0;animation:logoRingEntry 0.5s ease 1.2s forwards,logoRingSpin 4s linear 1.7s infinite}
.logo-ring-inner{position:absolute;inset:-3px;border-radius:50%;border:1.5px solid transparent;border-bottom-color:rgba(96,165,250,0.4);border-left-color:rgba(16,185,129,0.3);opacity:0;animation:logoRingEntry 0.5s ease 1.4s forwards,logoRingSpinRev 3s linear 1.9s infinite}
@keyframes logoRingEntry{0%{opacity:0;transform:scale(0.5)}100%{opacity:1;transform:scale(1)}}
@keyframes logoRingSpin{to{transform:rotate(360deg)}}@keyframes logoRingSpinRev{to{transform:rotate(-360deg)}}
.splash-title{font-family:'Baloo 2',sans-serif;font-size:40px;font-weight:800;color:#fff;margin-bottom:6px;letter-spacing:-0.02em;text-shadow:0 4px 30px rgba(139,92,246,0.5),0 0 60px rgba(236,72,153,0.3);opacity:0;animation:titleGlowIn 0.8s var(--smooth) 1.4s forwards}
@keyframes titleGlowIn{0%{opacity:0;transform:translateY(25px) scale(0.9);filter:blur(10px)}100%{opacity:1;transform:translateY(0) scale(1);filter:blur(0)}}
.splash-tagline{font-size:14px;color:rgba(255,255,255,0.75);text-align:center;line-height:1.6;max-width:260px;opacity:0;animation:titleGlowIn 0.7s var(--smooth) 1.6s forwards}
.splash-loader{margin-top:40px;width:180px;height:5px;border-radius:5px;background:rgba(255,255,255,0.1);overflow:hidden;opacity:0;animation:titleGlowIn 0.5s var(--smooth) 1.8s forwards;position:relative}
.splash-loader-fill{height:100%;width:0%;border-radius:5px;background:linear-gradient(90deg,#fbbf24,#f472b6,#a78bfa,#60a5fa,#34d399);background-size:300% 100%;animation:loaderFill 2.5s cubic-bezier(0.4,0,0.2,1) 2s forwards,loaderShimmer 1.5s ease infinite}
@keyframes loaderFill{0%{width:0%}100%{width:100%}}@keyframes loaderShimmer{0%{background-position:300% 0}100%{background-position:-300% 0}}
.splash-loader-glow{position:absolute;top:-2px;bottom:-2px;width:40px;border-radius:5px;background:rgba(255,255,255,0.4);filter:blur(4px);animation:loaderGlow 2.5s ease 2s forwards;left:0}
@keyframes loaderGlow{0%{left:0%}100%{left:calc(100% - 40px)}}
.splash-version{position:absolute;bottom:40px;font-size:11px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:0.15em;text-transform:uppercase;opacity:0;animation:titleGlowIn 0.5s var(--smooth) 2.2s forwards}
#splash.exit{animation:splashExit 1s cubic-bezier(0.4,0,0.2,1) forwards}
#splash.exit .splash-logo-wrap{animation:splashLogoExit 0.6s var(--smooth) forwards}
@keyframes splashExit{0%{opacity:1}100%{opacity:0;pointer-events:none}}
@keyframes splashLogoExit{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(1.5);filter:blur(20px)}}
.particle{position:fixed;border-radius:50%;pointer-events:none;z-index:99998;will-change:transform,opacity;animation:particleFly 1s ease-out forwards}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
.screen{display:none;flex-direction:column;flex:1;overflow:hidden;position:relative;z-index:1;will-change:transform,opacity}.screen.active{display:flex}
.screen.entering{animation:screenEnter 0.5s var(--smooth) forwards}.screen.exiting{animation:screenExit 0.35s var(--smooth) forwards;pointer-events:none}
@keyframes screenEnter{0%{opacity:0;transform:translateY(24px) scale(0.97)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes screenExit{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-16px) scale(0.98)}}
.screen.entering-left{animation:enterLeft 0.5s var(--smooth) forwards}.screen.entering-right{animation:enterRight 0.5s var(--smooth) forwards}
.screen.exiting-left{animation:exitLeft 0.35s var(--smooth) forwards;pointer-events:none}.screen.exiting-right{animation:exitRight 0.35s var(--smooth) forwards;pointer-events:none}
@keyframes enterLeft{0%{opacity:0;transform:translateX(50px) scale(0.98)}100%{opacity:1;transform:translateX(0) scale(1)}}
@keyframes enterRight{0%{opacity:0;transform:translateX(-50px) scale(0.98)}100%{opacity:1;transform:translateX(0) scale(1)}}
@keyframes exitLeft{0%{opacity:1;transform:translateX(0)}100%{opacity:0;transform:translateX(-30px) scale(0.98)}}
@keyframes exitRight{0%{opacity:1;transform:translateX(0)}100%{opacity:0;transform:translateX(30px) scale(0.98)}}
.screen.entering-up{animation:enterUp 0.5s var(--smooth) forwards}.screen.exiting-down{animation:exitDown 0.35s var(--smooth) forwards;pointer-events:none}
@keyframes enterUp{0%{opacity:0;transform:translateY(60px) scale(0.96)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes exitDown{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(40px) scale(0.97)}}
#app{height:100dvh;display:flex;flex-direction:column;max-width:480px;margin:0 auto;position:relative}
.scroll-body{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 12px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(20px) saturate(1.8);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;transition:background var(--transition)}
.topbar-logo-wrap{display:flex;align-items:center;gap:8px}
.topbar-logo-icon{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 8px rgba(139,92,246,0.3)}
.topbar-logo{font-family:'Baloo 2',sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--purple),var(--pink));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.topbar-title{font-size:17px;font-weight:800;color:var(--text)}
.back-btn{width:38px;height:38px;border-radius:var(--r-sm);background:var(--surface);border:1.5px solid var(--border);color:var(--text2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.25s var(--smooth);flex-shrink:0;box-shadow:0 2px 8px var(--shadow)}
.back-btn:hover{background:var(--surface2);color:var(--text);transform:scale(1.05)}.back-btn:active{transform:scale(0.95)}
.bottom-nav{display:flex;border-top:1px solid var(--border);flex-shrink:0;padding:6px 8px max(10px,env(safe-area-inset-bottom));background:var(--glass);backdrop-filter:blur(20px) saturate(1.8);transition:background var(--transition)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;cursor:pointer;transition:all 0.4s var(--smooth);border-radius:var(--r);margin:2px 3px;position:relative}
.nav-icon{font-size:22px;transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1)}
.nav-label{font-size:10px;font-weight:800;letter-spacing:0.03em;color:var(--text3);transition:all 0.35s var(--smooth)}
.nav-item.active{background:var(--purple-g)}.nav-item.active .nav-icon{transform:scale(1.2) translateY(-2px)}.nav-item.active .nav-label{color:var(--purple);font-weight:900}
.nav-item.active::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:20px;height:3px;border-radius:3px;background:linear-gradient(90deg,var(--purple),var(--pink));animation:navDotPop 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards}
@keyframes navDotPop{0%{width:0;opacity:0}100%{width:20px;opacity:1}}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border-radius:var(--r);font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;border:none;transition:all 0.3s var(--smooth);white-space:nowrap;will-change:transform}
.btn-primary{background:linear-gradient(135deg,var(--purple),#a855f7,var(--pink));color:#fff;box-shadow:0 6px 24px rgba(139,92,246,0.35)}
.btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 36px rgba(139,92,246,0.45)}.btn-primary:active{transform:translateY(1px) scale(0.98)}
.btn-secondary{background:var(--surface);border:1.5px solid var(--border2);color:var(--text);font-weight:700;box-shadow:0 2px 10px var(--shadow);backdrop-filter:blur(10px)}
.btn-secondary:hover{background:var(--surface2);transform:translateY(-2px)}.btn-secondary:active{transform:translateY(0) scale(0.98)}
.btn-ghost{background:transparent;color:var(--text2);padding:10px 16px}.btn-ghost:hover{color:var(--text);background:var(--surface3)}
.btn-danger{background:var(--red-soft);border:1.5px solid rgba(239,68,68,0.3);color:var(--red)}
.btn-full{width:100%}.btn-sm{padding:9px 16px;font-size:13px}.btn-xs{padding:6px 12px;font-size:11px}
.form-input{width:100%;padding:14px 18px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Nunito',sans-serif;font-size:15px;font-weight:600;outline:none;transition:all 0.3s var(--smooth);box-shadow:0 2px 8px var(--shadow);backdrop-filter:blur(10px)}
.form-input:focus{border-color:var(--purple);box-shadow:0 0 0 4px rgba(139,92,246,0.12)}.form-input::placeholder{color:var(--text3)}
textarea.form-input{resize:none;line-height:1.7}
select.form-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239b8ec4' stroke-width='3' stroke-linecap='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
.card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;backdrop-filter:blur(16px) saturate(1.5);box-shadow:0 4px 20px var(--shadow)}
.pill{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;background:var(--surface2);border:1px solid var(--border);color:var(--text2)}
.section-label{font-size:11px;font-weight:900;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:12px}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface);border:1.5px solid var(--border2);border-radius:var(--r);padding:14px 22px;font-size:14px;font-weight:700;z-index:9990;opacity:0;transition:all 0.45s var(--smooth);white-space:nowrap;pointer-events:none;max-width:90vw;text-align:center;box-shadow:0 8px 32px var(--shadow2);backdrop-filter:blur(20px);color:var(--text)}.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.ach-popup{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120px);background:var(--surface);border:2px solid var(--yellow);border-radius:var(--r-lg);padding:16px 22px;z-index:9991;opacity:0;transition:all 0.6s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;gap:14px;max-width:340px;box-shadow:0 8px 40px rgba(251,191,36,0.25);backdrop-filter:blur(20px)}.ach-popup.show{opacity:1;transform:translateX(-50%) translateY(0)}
.ach-pop-icon{font-size:36px}.ach-pop-text h4{font-size:10px;font-weight:900;color:var(--yellow);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:3px}.ach-pop-text p{font-size:14px;font-weight:800;color:var(--text)}
.theme-toggle{width:44px;height:24px;border-radius:12px;background:var(--surface2);border:1.5px solid var(--border);cursor:pointer;position:relative;transition:all 0.4s var(--smooth);flex-shrink:0}
.theme-toggle-knob{width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--yellow),var(--orange));position:absolute;top:2px;left:2px;transition:all 0.45s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;justify-content:center;font-size:10px}
[data-theme="dark"] .theme-toggle-knob{left:22px;background:linear-gradient(135deg,#6366f1,#8b5cf6)}
.modal-overlay{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:all 0.4s var(--smooth)}.modal-overlay.show{opacity:1;pointer-events:auto}
.modal-content{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-xl);padding:24px;width:calc(100% - 40px);max-width:400px;backdrop-filter:blur(20px);box-shadow:0 20px 60px var(--shadow2);transform:translateY(40px) scale(0.92);transition:all 0.5s cubic-bezier(0.34,1.56,0.64,1);max-height:90vh;overflow-y:auto;position:relative}
.modal-overlay.show .modal-content{transform:translateY(0) scale(1)}
.modal-title{font-family:'Baloo 2',sans-serif;font-size:22px;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:8px;color:var(--text)}
.modal-subtitle{font-size:12px;color:var(--text2);margin-bottom:18px}
.modal-close{position:absolute;top:16px;right:16px;width:30px;height:30px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--text3);transition:all 0.25s var(--smooth)}.modal-close:hover{background:var(--red-soft);color:var(--red)}
.time-picker-wrap{display:flex;align-items:center;justify-content:center;gap:6px;margin:16px 0}.time-col{display:flex;flex-direction:column;align-items:center;gap:4px}
.time-spin-btn{width:44px;height:34px;border-radius:var(--r-sm);background:var(--surface2);border:1.5px solid var(--border);color:var(--text2);font-size:18px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.25s var(--smooth)}
.time-spin-btn:hover{background:var(--purple-g);border-color:var(--purple);color:var(--purple)}.time-spin-btn:active{transform:scale(0.9)}
.time-display{width:56px;height:56px;border-radius:var(--r);background:var(--surface);border:2px solid var(--purple);display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;color:var(--purple)}
.time-sep{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;color:var(--text3);margin:0 2px;padding-top:20px}
.time-ampm{display:flex;flex-direction:column;gap:4px;margin-left:8px}
.ampm-btn{padding:6px 14px;border-radius:var(--r-sm);background:var(--surface2);border:1.5px solid var(--border);font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.3s var(--smooth)}.ampm-btn.active{background:var(--purple-g);border-color:var(--purple);color:var(--purple)}
.time-presets{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;justify-content:center}
.time-preset{padding:6px 14px;border-radius:20px;background:var(--surface2);border:1.5px solid var(--border);font-size:11px;font-weight:700;color:var(--text2);cursor:pointer;transition:all 0.25s var(--smooth)}.time-preset:hover{border-color:var(--purple);color:var(--purple);background:var(--purple-g)}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.setup-body{padding:24px 20px}.setup-h{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:700;margin-bottom:6px}.setup-sub{font-size:14px;color:var(--text2);margin-bottom:24px}
.form-group{margin-bottom:20px}.form-label{font-size:12px;font-weight:900;color:var(--text2);margin-bottom:8px;display:block;letter-spacing:0.06em;text-transform:uppercase}
.avatar-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.av-opt{aspect-ratio:1;background:var(--surface);border:2.5px solid var(--border);border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);position:relative;overflow:hidden}
.av-opt:active{transform:scale(0.95)}.av-opt.sel{border-color:var(--purple);background:var(--purple-g);transform:scale(1.1)}.av-opt.sel::after{content:'\2713';position:absolute;bottom:2px;right:4px;font-size:12px;color:var(--purple);font-weight:900}
.grade-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.grade-opt{padding:11px 6px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);text-align:center;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s var(--smooth);color:var(--text2)}.grade-opt:active{transform:scale(0.95)}.grade-opt.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple)}
.quiz-header{padding:14px 18px 12px;flex-shrink:0}.quiz-prog-bar{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin-bottom:8px}.quiz-prog-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--pink),var(--yellow));border-radius:5px;transition:width 0.6s var(--smooth)}
.quiz-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--text3);font-weight:700}.quiz-body{flex:1;overflow-y:auto;padding:20px}
.quiz-scenario{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.25);border-radius:var(--r-lg);padding:18px;margin-bottom:20px}.quiz-scenario .scenario-label{font-size:10px;font-weight:900;color:var(--purple);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px}
.quiz-qtext{font-family:'Baloo 2',sans-serif;font-size:20px;font-weight:700;line-height:1.35;margin-bottom:18px}.quiz-opts{display:flex;flex-direction:column;gap:9px}
.quiz-opt{padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:12px;font-size:13px;font-weight:700;color:var(--text2)}
.quiz-opt:hover{border-color:var(--border2);transform:translateX(4px)}.quiz-opt:active{transform:translateX(2px) scale(0.99)}.quiz-opt.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple);transform:translateX(6px)}
.quiz-dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--border2);flex-shrink:0;transition:all 0.3s var(--smooth);display:flex;align-items:center;justify-content:center;font-size:11px}.quiz-opt.sel .quiz-dot{border-color:var(--purple);background:var(--purple);color:#fff}
.quiz-footer{padding:10px 18px 14px;flex-shrink:0;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--glass);backdrop-filter:blur(16px)}
.results-hero{padding:28px 20px 0;text-align:center}.results-bigicon{font-size:64px;margin-bottom:12px;display:block;animation:pop 0.6s cubic-bezier(0.34,1.56,0.64,1) both}.results-h{font-family:'Baloo 2',sans-serif;font-size:30px;font-weight:800;margin-bottom:6px}.results-sub{font-size:13px;color:var(--text2);margin-bottom:20px}.results-body{padding:0 18px 20px}
.result-card{padding:16px;border-radius:var(--r);margin-bottom:10px;display:flex;align-items:center;gap:12px;border:2px solid;cursor:pointer;transition:all 0.3s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(10px)}.result-card:hover{transform:translateX(6px)}
.result-rank{font-family:'Baloo 2',sans-serif;font-size:30px;font-weight:800;flex-shrink:0;width:42px;text-align:center}.result-info h4{font-size:14px;font-weight:800;margin-bottom:3px}.result-info p{font-size:11px;opacity:0.7}
.result-pct-wrap{margin-left:auto;text-align:right;flex-shrink:0}.result-pct{font-family:'Baloo 2',sans-serif;font-size:26px;font-weight:800;line-height:1}.result-pct-label{font-size:9px;font-weight:700;opacity:0.6;text-transform:uppercase}
.result-bar-bg{position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(0,0,0,0.1)}.result-bar-fill{height:100%;border-radius:0 4px 0 0;transition:width 1.2s var(--smooth)}
@keyframes pop{from{transform:scale(0) rotate(-20deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
.home-scroll{padding:14px 14px 16px}.greeting{margin-bottom:16px}.greeting-hi{font-size:13px;color:var(--text2);font-weight:600}.greeting-name{font-family:'Baloo 2',sans-serif;font-size:26px;font-weight:800}
.xp-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 18px;margin-bottom:14px;display:flex;gap:14px;align-items:center;backdrop-filter:blur(16px);box-shadow:0 4px 20px var(--shadow)}
.xp-icon{font-size:34px}.xp-info{flex:1}.xp-lbl{font-size:12px;color:var(--text2);font-weight:700;margin-bottom:6px;display:flex;justify-content:space-between}
.xp-track{height:12px;background:var(--surface3);border-radius:6px;overflow:hidden}.xp-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--pink),var(--yellow));border-radius:6px;transition:width 1s var(--smooth)}
.streak-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:14px 16px;margin-bottom:14px;display:flex;gap:12px;align-items:center;backdrop-filter:blur(16px);box-shadow:0 4px 20px var(--shadow)}
.streak-days{display:flex;gap:5px;flex:1}.sday{flex:1;aspect-ratio:1;border-radius:10px;background:var(--surface2);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:9px;font-weight:800;color:var(--text3)}
.sday.done{background:var(--purple-g);color:var(--purple)}.sday.today{background:linear-gradient(135deg,var(--purple),var(--pink));color:#fff}.sday-dot{width:5px;height:5px;border-radius:50%;background:currentColor;opacity:0.7}
.streak-stat{text-align:center}.streak-num{font-family:'Baloo 2',sans-serif;font-size:34px;font-weight:800;color:var(--orange);line-height:1}.streak-lbl{font-size:9px;font-weight:800;color:var(--text3);text-transform:uppercase}
.tech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.tc{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 14px;cursor:pointer;transition:all 0.35s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow)}.tc:hover{transform:translateY(-5px) scale(1.02)}.tc:active{transform:translateY(-2px) scale(0.99)}
.tc-icon{font-size:32px;margin-bottom:8px;display:block}.tc-name{font-size:13px;font-weight:800;margin-bottom:3px}.tc-desc{font-size:11px;color:var(--text2);line-height:1.4}
.tc-badge{position:absolute;top:10px;right:10px;font-size:9px;font-weight:900;padding:3px 8px;border-radius:8px;text-transform:uppercase}
.tc-best{background:var(--yellow-soft);color:var(--orange);border:1px solid rgba(251,191,36,0.4)}.tc-match{background:var(--surface3);color:var(--text3);border:1px solid var(--border)}
.tip-card{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.2);border-radius:var(--r-lg);padding:16px 18px;margin-bottom:16px}.tip-card p{font-size:13px;color:var(--text2);line-height:1.7}
.tech-list-item{display:flex;align-items:center;gap:14px;padding:16px 18px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);cursor:pointer;transition:all 0.3s var(--smooth);margin-bottom:10px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow)}.tech-list-item:hover{border-color:var(--purple-l);transform:translateX(6px)}
.tli-icon{font-size:34px;flex-shrink:0}.tli-info{flex:1}.tli-name{font-size:15px;font-weight:800;margin-bottom:3px}.tli-desc{font-size:12px;color:var(--text2)}.tli-match{margin-top:6px;display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:800}
.fc-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px)}.fc-tab{flex:1;padding:12px 8px;text-align:center;font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.35s var(--smooth);border-bottom:3px solid transparent}.fc-tab.active{color:var(--purple);border-bottom-color:var(--purple)}
.fc-section{display:none;padding:16px;flex:1;overflow-y:auto}.fc-section.active{display:block;animation:sectionFade 0.4s var(--smooth) forwards}
@keyframes sectionFade{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
.deck-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:12px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow)}.deck-card:hover{border-color:var(--purple-l);transform:translateX(4px)}
.deck-dot{width:14px;height:14px;border-radius:6px;flex-shrink:0}.deck-info h4{font-size:15px;font-weight:800;margin-bottom:2px}.deck-info p{font-size:11px;color:var(--text2)}.deck-count{margin-left:auto;font-size:13px;font-weight:800;color:var(--text3)}
.create-deck-form{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;margin-bottom:14px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow)}.create-deck-form h4{font-size:14px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.color-picker{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}.color-swatch{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1)}.color-swatch.sel{border-color:#fff;transform:scale(1.25)}
.fc-scene{perspective:1000px;height:220px;cursor:pointer;margin-bottom:16px}.fc-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 0.7s var(--smooth)}.fc-inner.flipped{transform:rotateY(180deg)}
.fc-face{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;background:var(--surface);border:2px solid var(--border);border-radius:var(--r-lg);display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column;gap:8px;backdrop-filter:blur(16px);box-shadow:0 8px 32px var(--shadow)}
.fc-back-face{transform:rotateY(180deg);background:linear-gradient(135deg,var(--surface),var(--surface2))}
.fc-face-label{font-size:10px;font-weight:900;color:var(--text3);letter-spacing:0.12em;text-transform:uppercase}.fc-face-text{font-size:18px;font-weight:800;text-align:center;line-height:1.4}.fc-face-hint{font-size:11px;color:var(--text3);margin-top:4px}
.fc-rate-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.fc-rate{padding:12px 6px;border-radius:var(--r-sm);font-size:12px;font-weight:800;cursor:pointer;border:1.5px solid;transition:all 0.25s var(--smooth);text-align:center}
.fc-again{background:var(--red-soft);border-color:rgba(239,68,68,0.3);color:var(--red)}.fc-hard{background:var(--orange-soft);border-color:rgba(249,115,22,0.3);color:var(--orange)}.fc-good{background:var(--green-soft);border-color:rgba(16,185,129,0.3);color:var(--green)}
.fc-rate:hover{transform:translateY(-3px)}.fc-rate:active{transform:scale(0.97)}
.ai-gen-box{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.25);border-radius:var(--r-lg);padding:18px;margin-bottom:14px}.ai-gen-box h4{font-size:14px;font-weight:800;margin-bottom:4px;display:flex;align-items:center;gap:6px}.ai-gen-box p{font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.5}
.upload-area{border:2px dashed var(--border2);border-radius:var(--r);padding:22px;text-align:center;cursor:pointer;transition:all 0.3s var(--smooth);background:var(--surface);margin-bottom:10px}.upload-area:hover,.upload-area.drag{border-color:var(--purple);background:var(--purple-g)}
.upload-icon{font-size:36px;margin-bottom:8px;display:block}.upload-text{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:4px}.upload-hint{font-size:11px;color:var(--text3)}
.upload-status{padding:12px 16px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px}.upload-loading{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(59,130,246,0.3)}.upload-success{background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,0.3)}
.spinner{width:20px;height:20px;border:2.5px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block}@keyframes spin{to{transform:rotate(360deg)}}
.wb-topbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);flex-wrap:wrap}
.wb-colors{display:flex;gap:6px;align-items:center}.wb-color{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);flex-shrink:0}.wb-color.sel{border-color:#fff;transform:scale(1.3)}
.wb-sizes{display:flex;gap:4px}.wb-sz{width:32px;height:32px;border-radius:10px;background:var(--surface);border:1.5px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:11px;font-weight:800}.wb-sz.sel{border-color:var(--purple);color:var(--purple);background:var(--purple-g)}
.wb-tools{display:flex;gap:4px}.wb-tool{padding:7px 12px;border-radius:10px;background:var(--surface);border:1.5px solid var(--border);cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);transition:all 0.25s var(--smooth)}.wb-tool.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple)}
.wb-canvas-wrap{flex:1;position:relative;overflow:hidden}#wbCanvas{display:block;width:100%;height:100%;touch-action:none}
.diag-toolbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);overflow-x:auto}.diag-toolbar::-webkit-scrollbar{display:none}
.diag-color{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;flex-shrink:0;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1)}.diag-color.sel{border-color:#fff;transform:scale(1.3)}
.diag-add-input{flex:1;min-width:100px;padding:8px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;outline:none}.diag-add-input:focus{border-color:var(--purple)}
.diag-canvas-wrap{flex:1;position:relative;overflow:hidden;background:var(--surface3)}#diagCanvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}.diag-nodes-layer{position:absolute;inset:0}
.diag-node{position:absolute;padding:10px 16px;border-radius:var(--r-sm);font-size:13px;font-weight:800;cursor:move;border:2px solid;white-space:normal;text-align:center;touch-action:none;box-shadow:0 4px 16px var(--shadow);max-width:200px;word-break:break-word;backdrop-filter:blur(10px)}.diag-node.root{border-width:3px;font-size:14px}
.diag-node-del{position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity 0.2s}.diag-node:hover .diag-node-del{opacity:1}
.diag-bottom-bar{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px)}
.sched-week{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:16px}
.sched-day{aspect-ratio:0.9;border-radius:var(--r-sm);background:var(--surface);border:1.5px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px}
.sched-dlbl{font-size:8px;font-weight:900;color:var(--text3);text-transform:uppercase}.sched-dnum{font-size:13px;font-weight:800;color:var(--text2)}
.sched-day.has{border-color:var(--purple);background:var(--purple-g)}.sched-day.has .sched-dnum{color:var(--purple)}
.sched-day.rest{border-color:var(--teal);background:var(--teal-soft)}.sched-day.rest .sched-dnum{color:var(--teal)}
.sched-day.today{border-color:var(--orange);box-shadow:0 4px 16px rgba(249,115,22,0.2)}.sched-day.today .sched-dnum{color:var(--orange)}
.sess-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);margin-bottom:8px;backdrop-filter:blur(16px);box-shadow:0 2px 10px var(--shadow);transition:all 0.25s var(--smooth)}
.sess-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}.sess-info h4{font-size:14px;font-weight:800;margin-bottom:2px}.sess-info p{font-size:11px;color:var(--text2)}.sess-time{margin-left:auto;font-size:12px;font-weight:800;color:var(--text3);text-align:right}
.sess-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:14px;transition:all 0.2s}.sess-del:hover{color:var(--red)}
.timer-wrap{text-align:center;padding:20px 0}
.timer-ring{width:170px;height:170px;border-radius:50%;background:var(--surface);border:4px solid var(--border);margin:0 auto 14px;display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',sans-serif;font-size:42px;font-weight:800;color:var(--purple);box-shadow:0 8px 40px var(--shadow);transition:all 0.4s var(--smooth)}
.timer-ring.focus-mode{border-color:var(--purple);box-shadow:0 8px 48px rgba(139,92,246,0.3)}.timer-ring.break-mode{border-color:var(--green)}
.timer-phase{font-size:14px;color:var(--text2);font-weight:700;margin-bottom:14px}
.ach-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.ach-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 14px;text-align:center;transition:all 0.3s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow)}.ach-card.unlocked:hover{transform:translateY(-4px)}.ach-card.locked{opacity:0.35}
.ach-icon{font-size:36px;display:block;margin-bottom:8px}.ach-name{font-size:13px;font-weight:800;margin-bottom:4px;line-height:1.3}.ach-desc{font-size:10px;color:var(--text2);line-height:1.4;margin-bottom:8px}
.ach-rarity{font-size:9px;font-weight:900;padding:3px 10px;border-radius:12px;text-transform:uppercase;display:inline-block}
.r-common{background:var(--green-soft);color:var(--green)}.r-rare{background:var(--blue-soft);color:var(--blue)}.r-epic{background:rgba(167,139,250,0.15);color:#8b5cf6}.r-legendary{background:var(--yellow-soft);color:var(--orange)}
.ach-new{position:absolute;top:8px;right:8px;font-size:9px;font-weight:900;padding:2px 8px;border-radius:8px;background:var(--yellow);color:#000;text-transform:uppercase}
.tech-body{padding:14px;flex:1;overflow-y:auto}
.blurt-timer-big{font-family:'Baloo 2',sans-serif;font-size:52px;font-weight:800;color:var(--purple);text-align:center;margin:8px 0 12px}
.phase-badge{display:inline-flex;align-items:center;gap:6px;padding:7px 16px;border-radius:20px;font-size:12px;font-weight:800;margin-bottom:12px}
.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.compare-box{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:12px;font-size:12px;line-height:1.6;color:var(--text2);min-height:90px;word-break:break-word}.compare-box h5{font-size:10px;font-weight:900;color:var(--text3);margin-bottom:8px;text-transform:uppercase}
.feynman-steps{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px;background:var(--glass)}
.feynman-step{flex:1;padding:10px 6px;text-align:center;font-size:10px;font-weight:800;color:var(--text3);border-bottom:3px solid transparent;cursor:pointer;transition:all 0.35s var(--smooth);text-transform:uppercase}.feynman-step.active{color:var(--purple);border-bottom-color:var(--purple)}
.cornell-grid{display:grid;grid-template-columns:1fr 2fr;gap:10px;margin-bottom:10px}.cornell-lbl{font-size:10px;font-weight:900;color:var(--text3);text-transform:uppercase;margin-bottom:4px}
.rrr-btns{display:flex;gap:8px;margin-bottom:14px}.rrr-btn{flex:1;padding:12px 6px;border-radius:var(--r-sm);font-size:12px;font-weight:800;text-align:center;border:1.5px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text2);transition:all 0.3s var(--smooth)}.rrr-btn.active{background:var(--purple-g);border-color:var(--purple);color:var(--purple)}
.welcome-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:36px 24px;text-align:center}
.welcome-sub{font-size:15px;color:var(--text2);margin-bottom:28px;line-height:1.6;animation:fadeUp 0.7s var(--smooth) 0.1s both}
.welcome-features{display:flex;flex-direction:column;gap:10px;width:100%;margin-bottom:28px}
.wf{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);text-align:left;transition:all 0.3s var(--smooth);backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow)}.wf:hover{border-color:var(--purple-l);transform:translateX(4px)}
.wf-icon{font-size:28px;flex-shrink:0}.wf-text h4{font-size:14px;font-weight:800;margin-bottom:1px;color:var(--text)}.wf-text p{font-size:12px;color:var(--text2)}
#notif-banner{font-family:'Nunito',sans-serif}
.duration-adjuster{display:flex;align-items:center;justify-content:center;gap:12px;margin:12px 0}
.dur-btn{width:40px;height:40px;border-radius:50%;background:var(--surface);border:1.5px solid var(--border);color:var(--purple);font-size:20px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.25s var(--smooth)}.dur-btn:hover{background:var(--purple-g);border-color:var(--purple)}.dur-btn:active{transform:scale(0.9)}
.dur-display{font-family:'Baloo 2',sans-serif;font-size:32px;font-weight:800;color:var(--purple);min-width:80px;text-align:center}
.dur-label{font-size:11px;color:var(--text3);font-weight:700;text-align:center;margin-top:-4px}
.dur-presets{display:flex;gap:6px;justify-content:center;margin:8px 0 14px}
.dur-preset{padding:6px 14px;border-radius:20px;background:var(--surface2);border:1.5px solid var(--border);font-size:11px;font-weight:700;color:var(--text2);cursor:pointer;transition:all 0.25s var(--smooth)}.dur-preset:hover{border-color:var(--purple);color:var(--purple);background:var(--purple-g)}.dur-preset.active{border-color:var(--purple);color:var(--purple);background:var(--purple-g)}

/* ===== NEW STYLES FOR MCQ, T/F, AND SAVED REVIEWS ===== */
.test-q-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;margin-bottom:14px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow)}
.test-q-card .test-q-num{font-size:10px;font-weight:900;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px}
.test-q-card .test-q-text{font-family:'Baloo 2',sans-serif;font-size:17px;font-weight:700;line-height:1.4;margin-bottom:14px;color:var(--text)}
.test-opt{padding:12px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:10px;font-size:13px;font-weight:700;color:var(--text2);margin-bottom:8px}
.test-opt:hover{border-color:var(--border2);transform:translateX(3px)}
.test-opt.selected{border-color:var(--purple);background:var(--purple-g);color:var(--purple)}
.test-opt.correct{border-color:var(--green);background:var(--green-soft);color:var(--green)}
.test-opt.wrong{border-color:var(--red);background:var(--red-soft);color:var(--red)}
.test-opt .opt-letter{width:24px;height:24px;border-radius:50%;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;flex-shrink:0;transition:all 0.3s var(--smooth)}
.test-opt.selected .opt-letter{border-color:var(--purple);background:var(--purple);color:#fff}
.test-opt.correct .opt-letter{border-color:var(--green);background:var(--green);color:#fff}
.test-opt.wrong .opt-letter{border-color:var(--red);background:var(--red);color:#fff}
.tf-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
.tf-btn{padding:14px;border-radius:var(--r);font-size:15px;font-weight:800;cursor:pointer;border:2px solid var(--border);background:var(--surface);color:var(--text2);transition:all 0.3s var(--smooth);text-align:center}
.tf-btn:hover{transform:translateY(-2px)}
.tf-btn.selected{border-color:var(--purple);background:var(--purple-g);color:var(--purple)}
.tf-btn.correct{border-color:var(--green);background:var(--green-soft);color:var(--green)}
.tf-btn.wrong{border-color:var(--red);background:var(--red-soft);color:var(--red)}
.test-explanation{padding:10px 14px;border-radius:var(--r-sm);background:var(--blue-soft);border:1px solid rgba(59,130,246,0.3);font-size:12px;color:var(--blue);margin-top:8px;line-height:1.5;display:none}
.test-explanation.show{display:block;animation:sectionFade 0.3s var(--smooth)}
.test-score-card{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:2px solid rgba(139,92,246,0.3);border-radius:var(--r-xl);padding:28px;text-align:center;margin-bottom:16px}
.test-score-big{font-family:'Baloo 2',sans-serif;font-size:56px;font-weight:800;background:linear-gradient(135deg,var(--purple),var(--pink));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.test-score-label{font-size:13px;color:var(--text2);font-weight:700;margin-top:4px}
.test-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px)}
.test-tab{flex:1;padding:12px 8px;text-align:center;font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.35s var(--smooth);border-bottom:3px solid transparent}
.test-tab.active{color:var(--purple);border-bottom-color:var(--purple)}
.test-section{display:none;padding:16px;flex:1;overflow-y:auto}
.test-section.active{display:block;animation:sectionFade 0.4s var(--smooth) forwards}
.saved-review-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all 0.3s var(--smooth);backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow)}
.saved-review-card:hover{border-color:var(--purple-l);transform:translateX(4px)}
.saved-review-card .sr-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.saved-review-card .sr-icon{font-size:24px;flex-shrink:0}
.saved-review-card .sr-title{font-size:14px;font-weight:800;color:var(--text)}
.saved-review-card .sr-meta{font-size:11px;color:var(--text3);display:flex;gap:8px;flex-wrap:wrap}
.saved-review-card .sr-badge{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:800}
.saved-review-card .sr-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:14px;transition:all 0.2s;margin-left:auto;flex-shrink:0}
.saved-review-card .sr-del:hover{color:var(--red)}
.sr-detail-content{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px;margin-bottom:12px;font-size:13px;line-height:1.7;color:var(--text2);white-space:pre-wrap;word-break:break-word;max-height:300px;overflow-y:auto}
</style>
</head>
<body>
<div class="app-bg"><div class="bg-orb bg-orb-1"></div><div class="bg-orb bg-orb-2"></div><div class="bg-orb bg-orb-3"></div><div class="bg-orb bg-orb-4"></div></div>
<div id="splash"><div class="splash-bg"></div><div class="splash-aurora"><div class="aurora-band aurora-band-1"></div><div class="aurora-band aurora-band-2"></div><div class="aurora-band aurora-band-3"></div></div><div class="splash-stars" id="splash-stars"></div><div class="splash-particles" id="splash-particles"></div><div class="splash-rings"><div class="splash-ring"></div><div class="splash-ring"></div><div class="splash-ring"></div><div class="splash-ring"></div><div class="splash-ring"></div></div><div class="splash-logo-wrap"><div class="logo-mark"><div class="logo-ring-outer"></div><div class="logo-ring-inner"></div><div class="logo-brain"></div><div class="logo-book"></div><div class="logo-sparkle logo-sparkle-1"></div><div class="logo-sparkle logo-sparkle-2"></div><div class="logo-sparkle logo-sparkle-3"></div></div><div class="splash-title">StudyBuddy</div><div class="splash-tagline">Your personal study companion.<br>Learn smarter, not harder.</div></div><div class="splash-loader"><div class="splash-loader-fill"></div><div class="splash-loader-glow"></div></div><div class="splash-version">v2.0  Ready to learn</div></div>
<div id="app">
<div class="screen" id="screen-welcome"><div class="welcome-content"><div class="logo-mark" style="margin-bottom:10px;transform:scale(0.8);animation:fadeUp 0.5s ease both;"><div class="logo-ring-outer" style="animation:logoRingSpin 4s linear infinite;opacity:1;"></div><div class="logo-ring-inner" style="animation:logoRingSpinRev 3s linear infinite;opacity:1;"></div><div class="logo-brain" style="opacity:1;animation:brainBounce 2s ease-in-out infinite;"></div><div class="logo-book"></div><div class="logo-sparkle logo-sparkle-1" style="opacity:1;animation:sparkleFloat 2s ease-in-out infinite;"></div><div class="logo-sparkle logo-sparkle-2" style="opacity:1;animation:sparkleFloat 2s ease-in-out 0.5s infinite;"></div><div class="logo-sparkle logo-sparkle-3" style="opacity:1;animation:sparkleFloat 2s ease-in-out 1s infinite;"></div></div><div style="font-family:'Baloo 2',sans-serif;font-size:44px;font-weight:800;background:linear-gradient(135deg,var(--purple-d),var(--purple),var(--pink),var(--orange));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;animation:fadeUp 0.7s var(--smooth) both;">StudyBuddy</div><div class="welcome-sub">Your personal study companion.<br>Learn smarter, not harder.</div><div class="welcome-features" style="animation:fadeUp 0.7s var(--smooth) 0.2s both;"><div class="wf"><span class="wf-icon"></span><div class="wf-text"><h4>Scenario-Based Assessment</h4><p>Find your best study style</p></div></div><div class="wf"><span class="wf-icon"></span><div class="wf-text"><h4>7 Study Workrooms</h4><p>Flashcards, Feynman, diagrams & more</p></div></div><div class="wf"><span class="wf-icon"></span><div class="wf-text"><h4>Achievements & Streaks</h4><p>Earn rewards as you grow</p></div></div></div><div style="width:100%;animation:fadeUp 0.7s var(--smooth) 0.3s both;"><button class="btn btn-primary btn-full" onclick="SFX.tap();navigateTo('screen-setup')" style="font-size:16px;padding:16px;">Get Started</button><div style="margin-top:10px;"><button class="btn btn-ghost btn-full" onclick="SFX.tap();loadExisting()">I already have a profile</button></div></div></div></div>
<div class="screen" id="screen-setup"><div class="topbar"><div class="topbar-logo-wrap"><div class="topbar-logo-icon"></div><div class="topbar-logo">StudyBuddy</div></div><span style="font-size:12px;color:var(--text3);font-weight:700;">Step 1 of 2</span></div><div class="scroll-body"><div class="setup-body"><div class="setup-h">Create your profile</div><div class="setup-sub">Everything stays on your device.</div><div class="form-group"><label class="form-label">Your Name</label><input class="form-input" id="inp-name" type="text" placeholder="e.g. Maria Santos" maxlength="30"></div><div class="form-group"><label class="form-label">Pick an Avatar</label><div class="avatar-grid" id="av-grid"></div></div><div class="form-group"><label class="form-label">Grade Level</label><div class="grade-grid" id="gr-grid"></div></div><button class="btn btn-primary btn-full" onclick="SFX.tap();saveProfile()">Next: Take the Assessment</button></div></div></div>
<div class="screen" id="screen-quiz"><div class="quiz-header"><div style="display:flex;align-items:center;margin-bottom:10px;"><div class="topbar-logo-wrap"><div class="topbar-logo-icon"></div><div class="topbar-logo" style="font-size:16px;">StudyBuddy</div></div><span style="font-size:12px;color:var(--text3);font-weight:700;margin-left:auto;">Assessment</span></div><div class="quiz-prog-bar"><div class="quiz-prog-fill" id="q-prog" style="width:2%"></div></div><div class="quiz-meta"><span id="q-num">Q1 / 30</span><span id="q-hint" style="color:var(--purple);">Results at Q30</span></div></div><div class="quiz-body" id="q-body"></div><div class="quiz-footer"><button class="btn btn-secondary" onclick="SFX.tap();qPrev()" id="q-prev" style="width:80px;">Back</button><button class="btn btn-primary" onclick="SFX.tap();qNext()" id="q-next" style="flex:1;">Next</button></div></div>
<div class="screen" id="screen-results"><div class="scroll-body"><div class="results-hero"><span class="results-bigicon"></span><div class="results-h">Your Results Are In!</div><div class="results-sub" id="r-sub"></div></div><div class="results-body" id="r-body"></div><div style="padding:0 18px 24px;"><button class="btn btn-primary btn-full" onclick="SFX.success();goToHome()">Start Learning</button></div></div></div>
<div class="screen" id="screen-home"><div class="topbar"><div class="topbar-logo-wrap"><div class="topbar-logo-icon"></div><div class="topbar-logo">StudyBuddy</div></div><div style="display:flex;align-items:center;gap:10px;"><div class="theme-toggle" onclick="toggleTheme()"><div class="theme-toggle-knob" id="theme-knob"></div></div><span id="home-av" style="font-size:24px;"></span></div></div><div class="scroll-body home-scroll" id="home-body"><div class="greeting"><div class="greeting-hi" id="greeting-time">Welcome back,</div><div class="greeting-name" id="g-name">Learner!</div></div><div class="xp-card"><span class="xp-icon"></span><div class="xp-info"><div class="xp-lbl"><span>Level <span id="xp-lv">1</span></span><span><span id="xp-cur">0</span>/<span id="xp-nxt">200</span> XP</span></div><div class="xp-track"><div class="xp-fill" id="xp-bar" style="width:0%"></div></div></div></div><div class="streak-card"><div class="streak-days" id="streak-days"></div><div class="streak-stat"><div class="streak-num" id="streak-n">0</div><div class="streak-lbl">Streak</div></div></div><div class="section-label">Recommended Techniques</div><div class="tech-grid" id="home-tech-grid"></div><div class="section-label">Quick Actions</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;"><button class="btn btn-secondary" onclick="SFX.tap();switchNav('schedule')">Schedule</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav('achievements')">Awards</button></div><div class="section-label">Daily Tip</div><div class="tip-card" id="daily-tip"><p></p></div></div><div class="bottom-nav" id="home-nav"><div class="nav-item active" onclick="SFX.tap();switchNav('home')"><span class="nav-icon"></span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon"></span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon"></span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon"></span><span class="nav-label">Awards</span></div></div></div>
<div class="screen" id="screen-study"><div class="topbar"><div class="topbar-title">Study Tools</div></div><div class="scroll-body" style="padding:14px;" id="study-list-body"></div><div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon"></span><span class="nav-label">Home</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('study')"><span class="nav-icon"></span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon"></span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon"></span><span class="nav-label">Awards</span></div></div></div>
<div class="screen" id="screen-schedule"><div class="topbar"><div class="topbar-title">My Schedule</div><button class="btn btn-sm btn-primary" onclick="SFX.tap();showAddSessionModal()">+ Add</button></div><div class="scroll-body" style="padding:14px;" id="sched-body"><div class="section-label">This Week</div><div class="sched-week" id="sched-week"></div><div class="section-label" style="margin-top:14px;">Sessions</div><div id="sess-list"></div><div style="margin-top:10px;"><button class="btn btn-secondary btn-full" onclick="SFX.tap();toggleRest()">Toggle Rest Day Today</button></div><div class="section-label" style="margin-top:20px;">Pomodoro Timer</div><div class="timer-wrap"><div class="timer-ring" id="timer-ring">25:00</div><div class="timer-phase" id="timer-phase">Focus Session</div><div id="pomo-dur-adjuster"></div><div style="display:flex;gap:10px;justify-content:center;"><button class="btn btn-primary" onclick="SFX.tap();toggleTimer()" id="timer-btn">Start</button><button class="btn btn-secondary" onclick="SFX.tap();resetTimer()">Reset</button></div></div></div><div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon"></span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon"></span><span class="nav-label">Study</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon"></span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon"></span><span class="nav-label">Awards</span></div></div></div>
<div class="screen" id="screen-achievements"><div class="topbar"><div class="topbar-title">Achievements</div><span style="font-size:12px;color:var(--text2);font-weight:700;" id="ach-count">0/18</span></div><div class="scroll-body" style="padding:14px;"><div class="ach-grid" id="ach-grid"></div></div><div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon"></span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon"></span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon"></span><span class="nav-label">Schedule</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon"></span><span class="nav-label">Awards</span></div></div></div>
<div class="screen" id="screen-flashcards"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Flashcards</div></div><div class="fc-tabs"><div class="fc-tab active" onclick="switchFcTab('decks',this)">Decks</div><div class="fc-tab" onclick="switchFcTab('create',this)">Create</div><div class="fc-tab" onclick="switchFcTab('ai',this)">AI Gen</div></div><div class="fc-section active" id="fc-decks"></div><div class="fc-section" id="fc-create"></div><div class="fc-section" id="fc-ai"></div><div class="fc-section" id="fc-study"></div></div>
<div class="screen" id="screen-blurting"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Blurting</div></div><div class="scroll-body tech-body" id="blurt-body"></div></div>
<div class="screen" id="screen-question"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Question Method</div></div><div class="scroll-body tech-body" id="cornell-body"></div></div>
<div class="screen" id="screen-feynman"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Feynman Technique</div></div><div class="scroll-body tech-body" id="feynman-body"></div></div>
<div class="screen" id="screen-rrr"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Read, Recite, Review</div></div><div class="scroll-body tech-body" id="rrr-body"></div></div>
<div class="screen" id="screen-whiteboard"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Brain Dump</div></div><div class="wb-topbar" id="wb-toolbar"></div><div class="wb-canvas-wrap"><canvas id="wbCanvas"></canvas></div><div style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);"><button class="btn btn-secondary btn-sm" onclick="SFX.undo();wbUndo()"> Undo</button><button class="btn btn-secondary btn-sm" onclick="SFX.erase();wbClear()">Clear</button><button class="btn btn-primary btn-sm" style="flex:1;" onclick="SFX.tap();wbSave()">Save</button></div></div>
<div class="screen" id="screen-diagram"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Active Diagramming</div></div><div class="diag-toolbar" id="diag-toolbar"></div><div class="diag-canvas-wrap" id="diag-wrap"><canvas id="diagCanvas"></canvas><div class="diag-nodes-layer" id="diag-nodes"></div></div><div class="diag-bottom-bar"><button class="btn btn-danger btn-sm" onclick="SFX.tap();diagClear()">Clear</button><button class="btn btn-secondary btn-sm" onclick="SFX.tap();diagConnect()">Connect</button><button class="btn btn-primary btn-sm" style="flex:1;" onclick="SFX.tap();diagSave()">Save</button></div></div>

<!-- NEW: MCQ Test Screen -->
<div class="screen" id="screen-mcq"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Multiple Choice Test</div></div><div class="test-tabs"><div class="test-tab active" onclick="switchTestTab('mcq','generate',this)">Generate</div><div class="test-tab" onclick="switchTestTab('mcq','take',this)">Take Test</div><div class="test-tab" onclick="switchTestTab('mcq','results',this)">Results</div></div><div class="test-section active" id="mcq-generate"></div><div class="test-section" id="mcq-take"></div><div class="test-section" id="mcq-results"></div></div>

<!-- NEW: True/False Test Screen -->
<div class="screen" id="screen-tf"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">True or False Test</div></div><div class="test-tabs"><div class="test-tab active" onclick="switchTestTab('tf','generate',this)">Generate</div><div class="test-tab" onclick="switchTestTab('tf','take',this)">Take Test</div><div class="test-tab" onclick="switchTestTab('tf','results',this)">Results</div></div><div class="test-section active" id="tf-generate"></div><div class="test-section" id="tf-take"></div><div class="test-section" id="tf-results"></div></div>

<!-- NEW: Saved Reviews Screen -->
<div class="screen" id="screen-saved"><div class="topbar"><div class="back-btn" onclick="SFX.tap();switchNav('study')">&#8592;</div><div class="topbar-title">Saved Reviews</div><span style="font-size:12px;color:var(--text2);font-weight:700;" id="saved-count">0</span></div><div class="scroll-body" style="padding:14px;" id="saved-body"></div></div>

<!-- NEW: Saved Review Detail Screen -->
<div class="screen" id="screen-saved-detail"><div class="topbar"><div class="back-btn" onclick="SFX.tap();navigateTo('screen-saved','down')">&#8592;</div><div class="topbar-title" id="saved-detail-title">Review Detail</div></div><div class="scroll-body" style="padding:14px;" id="saved-detail-body"></div></div>

<div class="modal-overlay" id="session-modal"><div class="modal-content"><div class="modal-close" onclick="hideAddSessionModal()"></div><div class="modal-title"> New Study Session</div><div class="modal-subtitle">Plan your study session</div><div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="modal-subject" placeholder="e.g. Biology Chapter 5"></div><div class="form-group"><label class="form-label">Technique</label><select class="form-input" id="modal-technique"><option value="flashcards">Flashcards</option><option value="blurting">Blurting</option><option value="question">Question Method</option><option value="feynman">Feynman Technique</option><option value="rrr">Read, Recite, Review</option><option value="whiteboard">Brain Dump</option><option value="diagram">Active Diagramming</option><option value="mcq">Multiple Choice Test</option><option value="tf">True or False Test</option></select></div><div class="form-group"><label class="form-label">Duration (minutes)</label><input class="form-input" id="modal-duration" type="number" value="30" min="5" max="180"></div><div class="form-group"><label class="form-label">Date</label><input class="form-input" id="modal-date" type="date"></div><div class="form-group"><label class="form-label">Time</label><div style="text-align:center;cursor:pointer;padding:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);font-weight:800;color:var(--purple);" onclick="showTimePicker()" id="modal-time-display">2:00 PM - Tap to change</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;"><button class="btn btn-secondary" onclick="hideAddSessionModal()">Cancel</button><button class="btn btn-primary" onclick="SFX.correct();confirmAddSession()">Add Session</button></div></div></div>
<div class="modal-overlay" id="time-modal"><div class="modal-content"><div class="modal-close" onclick="hideTimePicker()"></div><div class="modal-title"> Set Time</div><div class="modal-subtitle">Pick when to study</div><div class="time-picker-wrap"><div class="time-col"><div class="time-spin-btn" onclick="spinTime('h',1)"></div><div class="time-display" id="tp-hour">02</div><div class="time-spin-btn" onclick="spinTime('h',-1)"></div></div><div class="time-sep">:</div><div class="time-col"><div class="time-spin-btn" onclick="spinTime('m',1)"></div><div class="time-display" id="tp-min">00</div><div class="time-spin-btn" onclick="spinTime('m',-1)"></div></div><div class="time-ampm"><div class="ampm-btn active" id="tp-pm-am" onclick="setAMPM('AM')">AM</div><div class="ampm-btn" id="tp-pm-pm" onclick="setAMPM('PM')">PM</div></div></div><div class="time-presets" id="time-presets"></div><button class="btn btn-primary btn-full" style="margin-top:16px;" onclick="confirmTimePick()">Confirm</button></div></div>
<div class="toast" id="toast"></div>
<div class="ach-popup" id="ach-popup"><span class="ach-pop-icon" id="ap-icon"></span><div class="ach-pop-text"><h4>Achievement Unlocked!</h4><p id="ap-name"></p></div></div>
</div>
<!-- Replace your entire <script> tag content with the following. 
     All original code is preserved exactly. Only additions and minimal modifications are marked with NEW/MODIFIED comments. -->

<script>
(function(){var pc=document.getElementById('splash-particles');for(var i=0;i<15;i++){var p=document.createElement('div');p.className='splash-particle';var sz=3+Math.random()*10;p.style.cssText='width:'+sz+'px;height:'+sz+'px;left:'+Math.random()*100+'%;background:rgba('+(200+Math.random()*55)+','+(150+Math.random()*105)+','+(200+Math.random()*55)+',0.25);animation-duration:'+(5+Math.random()*8)+'s;animation-delay:'+Math.random()*5+'s;';pc.appendChild(p)}var sc=document.getElementById('splash-stars');for(var i=0;i<40;i++){var s=document.createElement('div');s.className='splash-star';var sz=1+Math.random()*2.5;s.style.cssText='width:'+sz+'px;height:'+sz+'px;left:'+Math.random()*100+'%;top:'+Math.random()*100+'%;animation-duration:'+(1.5+Math.random()*3)+'s;animation-delay:'+Math.random()*3+'s;';sc.appendChild(s)}})();
var SFX=(function(){var ctx;function C(){if(!ctx)try{ctx=new(window.AudioContext||window.webkitAudioContext)}catch(e){}return ctx}function P(f,t,d,v){var c=C();if(!c)return;try{var o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type=t||'sine';o.frequency.value=f;g.gain.setValueAtTime(v||0.08,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+(d||0.1));o.start();o.stop(c.currentTime+(d||0.1)+0.05)}catch(e){}}function ch(a,t,d){a.forEach(function(x,i){setTimeout(function(){P(x,t,d,0.07)},i*55)})}return{tap:function(){P(520,'triangle',0.05,0.06)},select:function(){P(523,'sine',0.06,0.07);setTimeout(function(){P(659,'sine',0.06,0.05)},45)},correct:function(){ch([523,659,784],'sine',0.12)},success:function(){ch([523,659,784,1047],'sine',0.18)},flip:function(){P(660,'triangle',0.04,0.05);setTimeout(function(){P(880,'triangle',0.03,0.04)},35)},unlock:function(){P(784,'sine',0.1,0.09);setTimeout(function(){P(1047,'sine',0.12,0.1)},100);setTimeout(function(){P(1319,'sine',0.15,0.12)},200)},error:function(){P(200,'sawtooth',0.08,0.05);setTimeout(function(){P(180,'sawtooth',0.06,0.04)},60)},whoosh:function(){var c=C();if(!c)return;try{var o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='sine';o.frequency.setValueAtTime(700,c.currentTime);o.frequency.exponentialRampToValueAtTime(200,c.currentTime+0.18);g.gain.setValueAtTime(0.05,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.18);o.start();o.stop(c.currentTime+0.2)}catch(e){}},timer:function(){ch([880,1108,1320],'sine',0.18)},navigate:function(){P(440,'triangle',0.04,0.04);setTimeout(function(){P(554,'triangle',0.04,0.03)},30)},pop:function(){P(880,'sine',0.03,0.04)},erase:function(){P(300,'triangle',0.05,0.03)},undo:function(){P(400,'triangle',0.05,0.04);setTimeout(function(){P(350,'triangle',0.04,0.03)},35)},startup:function(){setTimeout(function(){P(392,'sine',0.1,0.05)},0);setTimeout(function(){P(440,'sine',0.1,0.05)},110);setTimeout(function(){P(523,'sine',0.1,0.06)},220);setTimeout(function(){P(659,'sine',0.12,0.07)},350);setTimeout(function(){P(784,'sine',0.15,0.08)},480);setTimeout(function(){ch([784,988,1175],'sine',0.2)},620)},alarm:function(){try{var c2=new(window.AudioContext||window.webkitAudioContext)();function pn(f,s,d){var o=c2.createOscillator(),g=c2.createGain();o.connect(g);g.connect(c2.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(0.12,c2.currentTime+s);g.gain.exponentialRampToValueAtTime(0.001,c2.currentTime+s+d);o.start(c2.currentTime+s);o.stop(c2.currentTime+s+d+0.05)}pn(880,0,0.15);pn(1100,0.18,0.15);pn(880,0.36,0.15);pn(1100,0.54,0.15);pn(1320,0.72,0.25)}catch(e){}},notifSound:function(){try{var c2=new(window.AudioContext||window.webkitAudioContext)();function pn(f,s,d){var o=c2.createOscillator(),g=c2.createGain();o.connect(g);g.connect(c2.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.1,c2.currentTime+s);g.gain.exponentialRampToValueAtTime(0.001,c2.currentTime+s+d);o.start(c2.currentTime+s);o.stop(c2.currentTime+s+d+0.05)}pn(660,0,0.12);pn(880,0.14,0.12);pn(1047,0.3,0.18)}catch(e){}}}})();
function burst(x,y,c,n){c=c||['#8b5cf6','#ec4899','#fbbf24','#10b981'];n=n||12;for(var i=0;i<n;i++){var p=document.createElement('div');p.className='particle';var a=(i/n)*360,d=40+Math.random()*70;p.style.cssText='left:'+x+'px;top:'+y+'px;width:'+(4+Math.random()*8)+'px;height:'+(4+Math.random()*8)+'px;background:'+c[i%c.length]+';--tx:'+Math.cos(a*Math.PI/180)*d+'px;--ty:'+Math.sin(a*Math.PI/180)*d+'px;animation-duration:'+(0.6+Math.random()*0.4)+'s;';document.body.appendChild(p);setTimeout(function(el){try{el.remove()}catch(e){}}.bind(null,p),1200)}}
var currentTheme=localStorage.getItem('sb-theme')||'light';
function applyTheme(){document.documentElement.setAttribute('data-theme',currentTheme);var k=document.getElementById('theme-knob');if(k)k.textContent=currentTheme==='dark'?'':''}
function toggleTheme(){currentTheme=currentTheme==='light'?'dark':'light';localStorage.setItem('sb-theme',currentTheme);applyTheme();SFX.select()}
applyTheme();
var AVATARS=['','','','','','','','','',''],GRADES=['Grade 7','Grade 8','Grade 9','Grade 10','Grade 11','Grade 12','College'],DECK_COLORS=['#8b5cf6','#ec4899','#fbbf24','#10b981','#3b82f6','#f97316','#14b8a6','#ef4444'];

var TECHNIQUES=[{id:'flashcards',name:'Flashcards',icon:'',cval:'#3b82f6',soft:'var(--blue-soft)',screen:'screen-flashcards',desc:'Spaced repetition for rapid recall'},{id:'blurting',name:'Blurting',icon:'',cval:'#ec4899',soft:'var(--pink-soft)',screen:'screen-blurting',desc:'Active recall through free writing'},{id:'question',name:'Question Method',icon:'',cval:'#10b981',soft:'var(--green-soft)',screen:'screen-question',desc:'Cornell note-taking and self-quiz'},{id:'feynman',name:'Feynman Technique',icon:'',cval:'#f97316',soft:'var(--orange-soft)',screen:'screen-feynman',desc:'Learn by teaching simply'},{id:'rrr',name:'Read, Recite, Review',icon:'',cval:'#14b8a6',soft:'var(--teal-soft)',screen:'screen-rrr',desc:'Structured reading cycle'},{id:'whiteboard',name:'Brain Dump',icon:'',cval:'#fbbf24',soft:'var(--yellow-soft)',screen:'screen-whiteboard',desc:'Free-form canvas drawing'},{id:'diagram',name:'Active Diagramming',icon:'',cval:'#8b5cf6',soft:'rgba(139,92,246,0.12)',screen:'screen-diagram',desc:'Mind maps and visual thinking'}];

var TEST_METHODS=[{id:'mcq',name:'Multiple Choice',icon:'',cval:'#6366f1',soft:'rgba(99,102,241,0.12)',screen:'screen-mcq',desc:'Auto-generated MCQ tests'},{id:'tf',name:'True or False',icon:'',cval:'#059669',soft:'rgba(5,150,105,0.12)',screen:'screen-tf',desc:'Auto-generated T/F quizzes'}];

var ALL_METHODS=TECHNIQUES.concat(TEST_METHODS);

function getTechMap(){var tm={};ALL_METHODS.forEach(function(t){tm[t.id]=t});return tm}

var QUESTIONS=[
{scenario:"You have a long exam in Science tomorrow and you haven't reviewed all the topics yet.",q:"What's the first thing you do?",opts:[
{label:"Go through all my notes carefully section by section, then try to recall the key points",w:{rrr:5,question:2}},
{label:"Grab a blank pad paper and write down everything I already remember about the topics",w:{blurting:5,whiteboard:2}},
{label:"Pull out important terms and pair them with their meanings for quick drilling",w:{flashcards:5,question:2}},
{label:"Talk myself through each topic out loud like I'm explaining it to my seatmate",w:{feynman:5,blurting:2}},
{label:"Lay out all the topics on paper and draw arrows showing how they're related",w:{diagram:5,whiteboard:3}}
]},
{scenario:"You're riding a jeepney to school and have about 20 minutes before the bell rings.",q:"How do you use that time to review?",opts:[
{label:"Flip through a set of Q&A pairs I prepared on my phone",w:{flashcards:5}},
{label:"Close my eyes and mentally walk through everything I studied last night",w:{blurting:4,feynman:3}},
{label:"Scribble key ideas on the back of a receipt or any paper I have",w:{blurting:5,whiteboard:2}},
{label:"Reread the highlighted parts of my notebook",w:{rrr:5}},
{label:"Think about what questions Sir or Ma'am might ask and rehearse answers in my head",w:{question:5,flashcards:2}}
]},
{scenario:"Your barkada study group chat says everyone's busy tonight. You're on your own.",q:"What do you do for your solo review?",opts:[
{label:"Read through each section of my notes, cover them, and try to recite what I read",w:{rrr:5,blurting:2}},
{label:"Pretend my groupmate is sitting beside me and explain the lesson out loud",w:{feynman:5}},
{label:"Get a big piece of paper and sketch how all the topics connect with colored pens",w:{diagram:5,whiteboard:3}},
{label:"Write everything I can remember on scratch paper, then check my notes for gaps",w:{blurting:5}},
{label:"Make up practice questions that could appear on the test and try answering them",w:{question:5,flashcards:3}}
]},
{scenario:"You got 25 out of 50 on your Math practice quiz. The real exam is in 5 days.",q:"How do you plan your comeback?",opts:[
{label:"Look at every wrong answer and figure out the simplest way to explain why it's wrong",w:{feynman:5,question:2}},
{label:"Reread the chapters on my weak topics more slowly and check my understanding after each part",w:{rrr:5}},
{label:"List all the formulas and concepts I got wrong and drill them until they stick",w:{flashcards:4,blurting:3}},
{label:"Create a chart showing which topics I know well vs. which ones I don't, then focus on the gaps",w:{diagram:5}},
{label:"Close my book and try to solve the same problems from memory to see where I get stuck",w:{blurting:5,whiteboard:2}}
]},
{scenario:"Your teacher in Filipino class assigned a 3-page reading about Noli Me Tangere for homework.",q:"After reading it once, what's your next step?",opts:[
{label:"Put the reading down and try to write a summary in my own simple words",w:{feynman:5,blurting:3}},
{label:"Read it again more carefully, then close the book and recite the important details",w:{rrr:5}},
{label:"Draw a timeline or map of the events and characters mentioned",w:{diagram:5,whiteboard:3}},
{label:"Pick out the key names, terms, and events and make quick review pairs",w:{flashcards:5}},
{label:"Write three questions that the reading answers, then try to answer them without looking",w:{question:5,rrr:2}}
]},
{scenario:"You need to memorize 30 vocabulary words in English for a quiz on Friday.",q:"What approach works best for you?",opts:[
{label:"Pair each word with its definition and go through them repeatedly in short bursts",w:{flashcards:5}},
{label:"Group the words by theme and arrange them in a visual layout with connections",w:{diagram:5,whiteboard:3}},
{label:"Read through the word list several times, cover it, then try reciting them back",w:{rrr:5}},
{label:"Write down as many words and definitions as I can from memory, check, and repeat",w:{blurting:5}},
{label:"Use each word in a simple sentence and explain it like I'm teaching a Grade 4 student",w:{feynman:4,question:3}}
]},
{scenario:"You're reviewing for your AP (Araling Panlipunan) exam about Philippine history.",q:"How do you refresh your memory on events and dates?",opts:[
{label:"Write down every historical event, date, and person I can remember without looking at notes",w:{blurting:5}},
{label:"Reread the chapter summaries then close the book and try to recall the details",w:{rrr:5}},
{label:"Create a storyline connecting events, people, and dates in a visual timeline",w:{diagram:5,whiteboard:3}},
{label:"Come up with potential essay questions and outline my answers",w:{question:5,feynman:2}},
{label:"Go through key terms and dates, testing myself back and forth quickly",w:{flashcards:5,question:2}}
]},
{scenario:"Your classmate sends you a message: 'Pare/Mare, di ko gets yung lesson kanina. Help naman.'",q:"How do you help them understand?",opts:[
{label:"Type a simplified explanation using everyday examples they can relate to",w:{feynman:5}},
{label:"Send them a photo of a quick sketch or diagram I drew to explain it visually",w:{diagram:4,whiteboard:4}},
{label:"Send them a series of simple questions that guide them to figure it out step by step",w:{question:5,flashcards:2}},
{label:"Tell them to reread the specific section slowly and try to summarize it back to me",w:{rrr:4,blurting:3}},
{label:"Ask them to write what they DO understand first, then we fill in what's missing",w:{blurting:5,feynman:2}}
]},
{scenario:"It's brownout at your house and you can't use your phone or laptop to study.",q:"What do you do with just a notebook and pen?",opts:[
{label:"Write down everything I remember about tomorrow's topics on blank pages",w:{blurting:5}},
{label:"Draw concept maps and diagrams connecting the main ideas using different colored pens",w:{diagram:5,whiteboard:4}},
{label:"Write questions on one side of the page and answers on the other, then test myself",w:{question:4,flashcards:4}},
{label:"Reread my handwritten notes by candlelight, section by section",w:{rrr:5}},
{label:"Write a simple explanation of each topic as if I'm writing a tutorial for someone",w:{feynman:5,blurting:2}}
]},
{scenario:"You're preparing for the quarterly exam and you have 5 subjects to review in 3 days.",q:"How do you organize your review schedule?",opts:[
{label:"Assign specific time blocks per subject and go through the material systematically for each",w:{rrr:5}},
{label:"Create a master visual overview connecting all subjects to see the big picture first",w:{diagram:5,whiteboard:2}},
{label:"Start each subject by writing everything I know, then focus on what I missed",w:{blurting:5,feynman:2}},
{label:"Build a set of key terms and definitions for each subject to drill throughout the day",w:{flashcards:5}},
{label:"Prepare practice questions for each subject and quiz myself at the end of each session",w:{question:5}}
]},
{scenario:"You keep reading the same page of your TLE textbook but nothing is sinking in.",q:"What do you switch to?",opts:[
{label:"Close the book and write everything I understood from that page without looking",w:{blurting:5}},
{label:"Grab scratch paper and sketch what I just read as a simple diagram",w:{diagram:4,whiteboard:3}},
{label:"Try to explain the paragraph to myself out loud in the simplest way possible",w:{feynman:5}},
{label:"Turn the key points into quick pairs and test myself back and forth",w:{flashcards:4,question:2}},
{label:"Read it out loud slowly, pause after each paragraph, and try to recite what I just read",w:{rrr:5}}
]},
{scenario:"After a full review session, you want to check if you actually learned the material.",q:"How do you test yourself?",opts:[
{label:"Go through my prepared Q&A pairs and see how many I get right",w:{flashcards:5}},
{label:"Take a blank paper and write everything I know about the topic from memory",w:{blurting:5,whiteboard:2}},
{label:"Answer the practice questions I made earlier from my notes",w:{question:5}},
{label:"Try to teach the whole topic to my younger sibling or an imaginary student",w:{feynman:5}},
{label:"Redraw my visual overview from memory and see if I can recreate it",w:{diagram:5}}
]},
{scenario:"Your MAPEH teacher asks the class to study a complex process like how the respiratory system works.",q:"What helps you understand it best?",opts:[
{label:"Draw the steps with arrows showing the flow from inhaling to exhaling",w:{diagram:5,whiteboard:3}},
{label:"Break each step down and explain it using simple comparisons, like comparing lungs to balloons",w:{feynman:5}},
{label:"Read the textbook section, then close it and try to recite the process from start to finish",w:{rrr:5}},
{label:"Create pairs matching each step with what happens during that step",w:{flashcards:5}},
{label:"Write out the entire process from memory and then check what I missed",w:{blurting:5}}
]},
{scenario:"You and your groupmates are working on a project about climate change for ESP class.",q:"What role do you naturally take in the group?",opts:[
{label:"I make sure everyone understands the topic by breaking it down simply",w:{feynman:5}},
{label:"I create the visual presentation  charts, infographics, and layouts",w:{diagram:5,whiteboard:3}},
{label:"I prepare review questions to make sure the group is ready for the defense",w:{question:5,flashcards:3}},
{label:"I compile and organize all the research material for everyone to read",w:{rrr:4,blurting:2}},
{label:"I do the brainstorming on the whiteboard or Manila paper, writing ideas freely",w:{whiteboard:5,blurting:2}}
]},
{scenario:"You found a really helpful YouTube video about your Math lesson but you can't rewatch it later.",q:"How do you make sure you remember what you learned?",opts:[
{label:"Immediately write down the key concepts and pair them for quick review later",w:{flashcards:5}},
{label:"After watching, write everything I remember from the video on paper",w:{blurting:5,rrr:2}},
{label:"Sketch the steps and examples from the video as a visual reference",w:{diagram:5}},
{label:"Write questions based on what the video taught and answer them myself",w:{question:5}},
{label:"Try to re-explain the video's content in my own words as simply as possible",w:{feynman:5}}
]},
{scenario:"You're studying the water cycle for Science and it has multiple connected stages.",q:"How do you make sense of all the connections?",opts:[
{label:"Draw the cycle with arrows, labels, and colors showing each stage's relationship",w:{diagram:5,whiteboard:3}},
{label:"Go through each stage and explain it using real-life examples I see around me",w:{feynman:5}},
{label:"Read the textbook explanation carefully, then close it and recite each stage in order",w:{rrr:5}},
{label:"Create quick pairs for each stage  name on one side, description on the other",w:{flashcards:5}},
{label:"Write the entire cycle from memory on a blank sheet and check what I missed",w:{blurting:5}}
]},
{scenario:"Your teacher announced a surprise recitation tomorrow on yesterday's lesson.",q:"You have tonight to prepare. What's your strategy?",opts:[
{label:"Read through yesterday's notes, cover them, and practice reciting answers out loud",w:{rrr:5}},
{label:"Guess what questions Sir/Ma'am might ask and prepare my answers",w:{question:5,flashcards:2}},
{label:"Write everything I remember from yesterday's class, then review what I forgot",w:{blurting:5}},
{label:"Explain each concept to myself simply until I'm confident I can answer any question",w:{feynman:5}},
{label:"Organize the lesson's main points visually so I can picture them during recitation",w:{diagram:4,whiteboard:3}}
]},
{scenario:"You're having a hard time understanding a complicated topic in Values Education.",q:"What's your go-to approach when something is really confusing?",opts:[
{label:"Try to explain the concept as if I'm talking to a Grade 3 student using simple words",w:{feynman:5}},
{label:"Write everything I DO understand first, then figure out exactly where I'm confused",w:{blurting:5}},
{label:"Reread the material more slowly, taking it paragraph by paragraph",w:{rrr:5,question:2}},
{label:"Create a visual map of the topic showing cause and effect relationships",w:{diagram:5,whiteboard:3}},
{label:"Break the confusing topic into smaller pieces and create Q&A pairs for each piece",w:{flashcards:5,question:2}}
]},
{scenario:"You need to study for both English and Filipino exams happening on the same day.",q:"How do you split your study time?",opts:[
{label:"Alternate between subjects  read a section of English, recite it, then switch to Filipino",w:{rrr:5}},
{label:"Build a quick review set for each subject with key terms to drill throughout the day",w:{flashcards:5}},
{label:"For each subject, write everything I know from memory first to find my weak spots",w:{blurting:5,feynman:2}},
{label:"Create a side-by-side visual comparison of both subjects' main topics",w:{diagram:5,whiteboard:2}},
{label:"Prepare practice questions for both subjects and alternate quizzing myself",w:{question:5}}
]},
{scenario:"You're at a family reunion and your tita asks what you've been learning in school lately.",q:"How do you explain your lessons to her?",opts:[
{label:"Use simple everyday examples she'd understand, like comparing photosynthesis to cooking rice",w:{feynman:5}},
{label:"Grab a napkin and draw a quick diagram to show her visually",w:{diagram:4,whiteboard:4}},
{label:"Ask her questions first to see what she knows, then build on that",w:{question:5,feynman:2}},
{label:"Summarize the lesson point by point in order, like reading from my notes",w:{rrr:4,blurting:2}},
{label:"Tell her everything I can remember off the top of my head",w:{blurting:5}}
]},
{scenario:"Your Math teacher introduces a new formula and you need to memorize how to use it.",q:"What's your approach to learning the formula?",opts:[
{label:"Practice solving different problems using the formula over and over",w:{flashcards:4,rrr:3}},
{label:"Write a simple explanation of what the formula does and when to use it in plain words",w:{feynman:5}},
{label:"Create a visual chart showing when and where each part of the formula applies",w:{diagram:5}},
{label:"Write the formula from memory repeatedly until I can do it without looking",w:{blurting:5}},
{label:"Create practice problems about the formula and challenge myself to solve them",w:{question:5,flashcards:2}}
]},
{scenario:"You're reviewing the parts of a cell for your Biology class and there are so many to remember.",q:"How do you keep track of all the parts and their functions?",opts:[
{label:"Draw and label a cell diagram with colors for each organelle",w:{diagram:5,whiteboard:3}},
{label:"Pair each organelle with its function and drill through them in quick rounds",w:{flashcards:5}},
{label:"Explain each part using real-world comparisons, like 'mitochondria is like a power plant'",w:{feynman:5}},
{label:"Write all the organelles and functions I remember, then check what I missed",w:{blurting:5}},
{label:"Read the textbook section about each part, then try to recite their functions from memory",w:{rrr:5}}
]},
{scenario:"You're preparing for a class reporting/presentation in front of your section.",q:"How do you get ready?",opts:[
{label:"Create a visual layout or poster as my guide during the presentation",w:{diagram:5,whiteboard:3}},
{label:"Practice explaining the topic out loud simply, as if my audience knows nothing",w:{feynman:5}},
{label:"Prepare key points and rehearse them as quick recall prompts",w:{flashcards:4}},
{label:"Write my entire talk from memory first to see what I know confidently",w:{blurting:5}},
{label:"Read my notes multiple times until I feel confident about the material",w:{rrr:5}}
]},
{scenario:"You keep forgetting the difference between two similar concepts in Science, like mitosis and meiosis.",q:"How do you finally make it stick?",opts:[
{label:"Create a side-by-side comparison showing the differences visually",w:{diagram:5,whiteboard:2}},
{label:"Explain both concepts to myself simply and focus on what makes each one different",w:{feynman:5}},
{label:"Write both terms and their differences from memory several times",w:{blurting:5}},
{label:"Make quick pairs: one side has the concept, the other has what's unique about it",w:{flashcards:5}},
{label:"Read the textbook definition of each one slowly, then close it and recite the differences",w:{rrr:5}}
]},
{scenario:"It's Saturday and you want to get ahead on next week's lessons.",q:"How do you pre-study material you haven't been taught yet?",opts:[
{label:"Read the next chapter's overview first, then try to recall what I just read",w:{rrr:5}},
{label:"Start building a visual overview of the new topics as I learn them",w:{diagram:5}},
{label:"Write down what little I know already and try to connect it to the new material",w:{feynman:4,blurting:3}},
{label:"Create Q&A pairs for every new term or concept I encounter",w:{flashcards:5}},
{label:"Write questions that the new chapter seems to answer and use them to guide my reading",w:{question:5}}
]},
{scenario:"You're reviewing for a quiz that's mostly multiple choice questions.",q:"How do you prepare for that specific format?",opts:[
{label:"Create pairs that mimic the question-and-answer format and drill through them",w:{flashcards:5}},
{label:"Write practice questions with several possible answers and test myself",w:{question:5}},
{label:"Write everything I know about each topic to make sure I have broad coverage",w:{blurting:5}},
{label:"For each topic, explain to myself why wrong answers would be wrong",w:{feynman:5}},
{label:"Review all notes by reading through them carefully and checking understanding",w:{rrr:5}}
]},
{scenario:"You're doing a group study session via video call with your classmates.",q:"What role do you naturally fall into?",opts:[
{label:"I'm the one who shares my screen and sketches diagrams for everyone",w:{diagram:5,whiteboard:4}},
{label:"I explain things in the simplest way when someone is confused",w:{feynman:5}},
{label:"I quiz the group with questions to keep everyone on their toes",w:{question:5,flashcards:3}},
{label:"I suggest everyone write what they know first, then we compare answers",w:{blurting:5}},
{label:"I organize the review by going through the material systematically with everyone",w:{rrr:5}}
]},
{scenario:"Your teacher says: 'The exam will test deep understanding, not just memorization.'",q:"How does this change your study approach?",opts:[
{label:"Focus on being able to explain the 'why' behind every concept in simple terms",w:{feynman:5}},
{label:"Build concept maps showing cause-and-effect and how ideas connect to each other",w:{diagram:5}},
{label:"Write out my understanding of each topic from memory to find where it's shallow",w:{blurting:5}},
{label:"Create deep-thinking questions like 'Why does this happen?' and answer them",w:{question:5}},
{label:"Read the material from different sources to get a fuller understanding",w:{rrr:4,flashcards:2}}
]},
{scenario:"You only have 30 minutes before your exam starts and you're in the classroom waiting.",q:"What's your last-minute review strategy?",opts:[
{label:"Quickly go through my prepared Q&A review set one more time",w:{flashcards:5}},
{label:"Do a final brain dump  write everything I can remember on scratch paper",w:{blurting:5}},
{label:"Glance at my visual overview or concept map for a quick mental picture",w:{diagram:5}},
{label:"Explain the hardest concepts to myself one more time to make sure I've got them",w:{feynman:5}},
{label:"Quickly skim through my summary notes one last time",w:{rrr:5}}
]},
{scenario:"Your younger sibling asks you to help them study for their own exam.",q:"How do you help them learn the material?",opts:[
{label:"Break down each topic into the simplest possible explanation with examples from their daily life",w:{feynman:5}},
{label:"Draw colorful charts and pictures together to make the material visual and fun",w:{diagram:5,whiteboard:3}},
{label:"Create a fun quiz game where I ask questions and they try to answer",w:{question:5,flashcards:3}},
{label:"Have them read short sections, then ask them to tell me what they just read",w:{rrr:5}},
{label:"Ask them to write everything they know first so we can see what to focus on",w:{blurting:5,feynman:2}}
]}
];

var TIPS=["Spaced repetition is 2-3x more effective than cramming.","The Feynman Technique reveals gaps instantly.","Rest days consolidate memory.","Short sessions beat long marathons.","Blurting shows exactly what you missed.","Color-coding diagrams improves recall by 50%.","Review flashcards right before you'd forget.","Reciting out loud engages more brain."];
var ACHIEVEMENTS_DEF=[{key:'first_profile',icon:'',name:'Identity Found',desc:'Created your profile',rarity:'common'},{key:'quiz_complete',icon:'',name:'Self-Aware Learner',desc:'Completed assessment',rarity:'common'},{key:'first_fc',icon:'',name:'First Flip',desc:'Reviewed first flashcard',rarity:'common'},{key:'first_blurt',icon:'',name:'Brain Unlocked',desc:'Completed Blurting session',rarity:'common'},{key:'first_sched',icon:'',name:'Planner Pro',desc:'Added first session',rarity:'common'},{key:'first_timer',icon:'',name:'Time Keeper',desc:'Completed Pomodoro',rarity:'common'},{key:'first_wb',icon:'',name:'Canvas Pioneer',desc:'Saved first Brain Dump',rarity:'common'},{key:'streak_3',icon:'',name:'On Fire',desc:'3-day streak',rarity:'rare'},{key:'streak_7',icon:'',name:'Unstoppable',desc:'7-day streak',rarity:'rare'},{key:'five_decks',icon:'',name:'Deck Builder',desc:'Created 5 decks',rarity:'rare'},{key:'feynman_5',icon:'',name:'Little Professor',desc:'5 Feynman sessions',rarity:'rare'},{key:'diagram_5',icon:'',name:'Map Maker',desc:'5 diagrams saved',rarity:'rare'},{key:'all_techniques',icon:'',name:'Technique Explorer',desc:'Used all 7 techniques',rarity:'epic'},{key:'hours_10',icon:'',name:'10-Hour Club',desc:'10+ hours studied',rarity:'epic'},{key:'study_balance',icon:'',name:'Balance Master',desc:'3+ rest days',rarity:'epic'},{key:'blurt_10',icon:'',name:'Blurt Champion',desc:'10 Blurting sessions',rarity:'epic'},{key:'all_ach',icon:'',name:'StudyBuddy Legend',desc:'All achievements',rarity:'legendary'},{key:'hours_50',icon:'',name:'Century Scholar',desc:'50+ hours studied',rarity:'legendary'}];
var S={profile:null,quizAnswers:{},scores:{},topTech:null,xp:0,ach:[],sessions:[],restDays:[],streak:0,lastStudy:null,decks:[],techUsed:{},mins:0,feynmanCt:0,diagCt:0,blurtCt:0,savedReviews:[],mcqTests:[],tfTests:[]};
var curScreen='',prevScreen='',quizQ=0,isTransitioning=false;
var timerInt=null,timerSecs=25*60,timerOn=false,timerPhase='focus',pomoCt=0;
var tpH=2,tpM=0,tpAMPM='PM';
var reviewDuration=25,blurtReviewDur=120;
var NAV_ORDER={home:0,study:1,schedule:2,achievements:3};
var NAV_SCREENS={home:'screen-home',study:'screen-study',schedule:'screen-schedule',achievements:'screen-achievements'};
function save(){try{localStorage.setItem('sb7',JSON.stringify(S))}catch(e){}}
function load(){try{var d=localStorage.getItem('sb7');if(d){var p=JSON.parse(d);Object.keys(p).forEach(function(k){S[k]=p[k]});if(!S.savedReviews)S.savedReviews=[];if(!S.mcqTests)S.mcqTests=[];if(!S.tfTests)S.tfTests=[];return true}}catch(e){}return false}
function esc(t){return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')}
function navigateTo(id,anim){if(isTransitioning||id===curScreen)return;isTransitioning=true;anim=anim||'default';var oldEl=curScreen?document.getElementById(curScreen):null;var newEl=document.getElementById(id);if(!newEl){isTransitioning=false;return}var ec='exiting',nc='entering';if(anim==='left'){ec='exiting-left';nc='entering-left'}else if(anim==='right'){ec='exiting-right';nc='entering-right'}else if(anim==='up'){ec='exiting';nc='entering-up'}else if(anim==='down'){ec='exiting-down';nc='entering'}if(oldEl&&oldEl!==newEl){oldEl.classList.add(ec);var oR=oldEl,eR=ec;setTimeout(function(){oR.classList.remove('active',eR,'entering','entering-left','entering-right','entering-up','exiting','exiting-left','exiting-right','exiting-down')},400)}setTimeout(function(){newEl.classList.add('active',nc);var nR=nc;setTimeout(function(){newEl.classList.remove(nR);isTransitioning=false},550)},oldEl&&oldEl!==newEl?120:0);prevScreen=curScreen;curScreen=id;SFX.navigate()}
function goBack(){navigateTo(prevScreen||'screen-study','down')}
function switchNav(tab){var scr=NAV_SCREENS[tab];if(!scr||scr===curScreen)return;var cur='home';Object.keys(NAV_SCREENS).forEach(function(k){if(NAV_SCREENS[k]===curScreen)cur=k});SFX.whoosh();navigateTo(scr,NAV_ORDER[tab]>NAV_ORDER[cur]?'left':'right');if(tab==='achievements')renderAch();if(tab==='schedule'){renderSched();renderSessList();renderPomoDurAdjuster()}if(tab==='study')renderStudyList();if(tab==='home')renderHome();setTimeout(function(){document.querySelectorAll('.bottom-nav').forEach(function(nav){nav.querySelectorAll('.nav-item').forEach(function(n,i){n.classList.toggle('active',['home','study','schedule','achievements'][i]===tab)})})},50)}
function openTech(id){if(!S.techUsed)S.techUsed={};S.techUsed[id]=(S.techUsed[id]||0)+1;save();if(Object.keys(S.techUsed).length>=7)unlock('all_techniques');var t=TECHNIQUES.find(function(x){return x.id===id});if(!t)return;switch(id){case'flashcards':initFC();break;case'blurting':initBlurt();break;case'question':initCornell();break;case'feynman':initFeynman();break;case'rrr':initRRR();break;case'whiteboard':navigateTo(t.screen,'up');setTimeout(initWB,300);return;case'diagram':navigateTo(t.screen,'up');setTimeout(initDiag,300);return}navigateTo(t.screen,'up')}
function openTestMethod(id){var t=TEST_METHODS.find(function(x){return x.id===id});if(!t)return;if(id==='mcq')initMCQ();else if(id==='tf')initTF();navigateTo(t.screen,'up')}
function hideSplash(){setTimeout(function(){SFX.startup()},1800);setTimeout(function(){var sp=document.getElementById('splash');sp.classList.add('exit');burst(window.innerWidth/2,window.innerHeight/2,null,20);setTimeout(function(){sp.style.display='none'},1000);if(load()&&S.profile&&S.scores&&Object.keys(S.scores).length>0){renderHome();navigateTo('screen-home')}else{initSetup();navigateTo('screen-welcome')}},4200)}
var selectedAvatarIdx=0,selGr='';
function initSetup(){var ag=document.getElementById('av-grid');ag.innerHTML=AVATARS.map(function(a,i){return'<div class="av-opt '+(i===0?'sel':'')+'" data-idx="'+i+'">'+a+'</div>'}).join('');ag.onclick=function(e){var o=e.target.closest('.av-opt');if(!o)return;selectedAvatarIdx=+o.dataset.idx;ag.querySelectorAll('.av-opt').forEach(function(el,j){el.classList.toggle('sel',j===selectedAvatarIdx)});SFX.select()};var gg=document.getElementById('gr-grid');gg.innerHTML=GRADES.map(function(g){return'<div class="grade-opt" data-g="'+g+'">'+g+'</div>'}).join('');gg.onclick=function(e){var o=e.target.closest('.grade-opt');if(!o)return;selGr=o.dataset.g;gg.querySelectorAll('.grade-opt').forEach(function(el){el.classList.remove('sel')});o.classList.add('sel');SFX.select()}}
function saveProfile(){var n=document.getElementById('inp-name').value.trim();if(!n){showToast('Please enter your name');SFX.error();return}if(!selGr){showToast('Pick your grade level');SFX.error();return}S.profile={name:n,avatar:AVATARS[selectedAvatarIdx],grade:selGr};save();unlock('first_profile');startQuiz()}
function loadExisting(){if(load()&&S.profile){renderHome();navigateTo('screen-home')}else{showToast('No saved profile');SFX.error()}}
function startQuiz(){S.quizAnswers={};quizQ=0;navigateTo('screen-quiz');renderQ()}
function renderQ(){var q=QUESTIONS[quizQ];document.getElementById('q-prog').style.width=((quizQ+1)/QUESTIONS.length*100)+'%';document.getElementById('q-num').textContent='Q'+(quizQ+1)+' / '+QUESTIONS.length;document.getElementById('q-hint').textContent='Results at Q'+QUESTIONS.length;var sel=S.quizAnswers[quizQ];document.getElementById('q-body').innerHTML='<div class="quiz-scenario"><div class="scenario-label">Scenario</div><div style="font-size:15px;font-weight:700;color:var(--text);line-height:1.5;">'+q.scenario+'</div></div><div class="quiz-qtext">'+q.q+'</div><div class="quiz-opts">'+q.opts.map(function(o,i){return'<div class="quiz-opt '+(sel===i?'sel':'')+'" onclick="pickQ('+i+',this)"><div class="quiz-dot">'+(sel===i?'':'')+'</div><span>'+String.fromCharCode(65+i)+'. '+o.label+'</span></div>'}).join('')+'</div>';document.getElementById('q-prev').style.opacity=quizQ===0?'0.35':'1';document.getElementById('q-next').textContent=quizQ===QUESTIONS.length-1?'See My Results':'Next'}
function pickQ(v,el){S.quizAnswers[quizQ]=v;document.querySelectorAll('.quiz-opt').forEach(function(o){o.classList.remove('sel');o.querySelector('.quiz-dot').textContent=''});el.classList.add('sel');el.querySelector('.quiz-dot').textContent='';SFX.select()}
function qNext(){if(S.quizAnswers[quizQ]===undefined){showToast('Select an answer');SFX.error();return}if(quizQ<QUESTIONS.length-1){quizQ++;renderQ()}else computeResults()}
function qPrev(){if(quizQ>0){quizQ--;renderQ()}}
function computeResults(){var sc={};TECHNIQUES.forEach(function(t){sc[t.id]=0});QUESTIONS.forEach(function(q,i){var ai=S.quizAnswers[i];if(ai===undefined)return;var o=q.opts[ai];if(o&&o.w)Object.keys(o.w).forEach(function(id){if(sc[id]!==undefined)sc[id]+=o.w[id]})});var max=Math.max.apply(null,Object.values(sc).concat([1]));var norm={};Object.keys(sc).forEach(function(k){norm[k]=Math.round(sc[k]/max*100)});S.scores=norm;S.topTech=Object.keys(norm).sort(function(a,b){return norm[b]-norm[a]})[0];save();unlock('quiz_complete');renderResults();navigateTo('screen-results');SFX.success();setTimeout(function(){burst(window.innerWidth/2,window.innerHeight/2)},300)}
function renderResults(){var sorted=Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a]});var tm={};TECHNIQUES.forEach(function(t){tm[t.id]=t});var medals=['','',''];document.getElementById('r-sub').textContent='Hi '+S.profile.name+'! Here are your results:';document.getElementById('r-body').innerHTML=sorted.map(function(id,i){var t=tm[id],pct=S.scores[id];if(!t)return'';return'<div class="result-card" style="background:'+t.soft+';border-color:'+t.cval+'40;color:'+t.cval+';" onclick="openTech(\''+id+'\')"><div class="result-rank">'+(medals[i]||'#'+(i+1))+'</div><div class="result-info"><h4>'+t.icon+' '+t.name+'</h4><p>'+t.desc+'</p></div><div class="result-pct-wrap"><div class="result-pct">'+pct+'%</div><div class="result-pct-label">match</div></div><div class="result-bar-bg"><div class="result-bar-fill" style="background:'+t.cval+';width:0%;" data-w="'+pct+'"></div></div></div>'}).join('');setTimeout(function(){document.querySelectorAll('.result-bar-fill').forEach(function(b){b.style.width=b.dataset.w+'%'})},200)}
function goToHome(){renderHome();navigateTo('screen-home')}
function renderHome(){if(!S.profile)return;document.getElementById('g-name').textContent=S.profile.name+' '+S.profile.avatar;document.getElementById('home-av').textContent=S.profile.avatar;var h=new Date().getHours();document.getElementById('greeting-time').textContent=(h<12?'Good morning,':h<17?'Good afternoon,':'Good evening,');var lv=Math.floor(S.xp/200)+1,xi=S.xp%200;document.getElementById('xp-lv').textContent=lv;document.getElementById('xp-cur').textContent=xi;document.getElementById('xp-nxt').textContent=200;document.getElementById('xp-bar').style.width=(xi/200*100)+'%';renderStreakDays();var sorted=S.scores?Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a]}):[];document.getElementById('home-tech-grid').innerHTML=TECHNIQUES.map(function(t){var rank=sorted.indexOf(t.id)+1,pct=S.scores[t.id]||0;return'<div class="tc" onclick="SFX.tap();openTech(\''+t.id+'\')"><div style="position:absolute;top:0;left:0;right:0;height:4px;border-radius:var(--r-lg) var(--r-lg) 0 0;background:'+t.cval+';"></div>'+(rank===1?'<div class="tc-badge tc-best">Best</div>':(rank<=3?'<div class="tc-badge tc-match">#'+rank+'</div>':''))+'<span class="tc-icon">'+t.icon+'</span><div class="tc-name">'+t.name+'</div><div class="tc-desc">'+t.desc+'</div>'+(pct?'<div style="margin-top:8px;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;"><div style="height:100%;width:'+pct+'%;background:'+t.cval+';border-radius:3px;transition:width 1s;"></div></div>':'')+'</div>'}).join('')+'</div><div class="section-label" style="margin-top:16px;">Test Yourself</div><div class="tech-grid">'+TEST_METHODS.map(function(t){return'<div class="tc" onclick="SFX.tap();openTestMethod(\''+t.id+'\')"><div style="position:absolute;top:0;left:0;right:0;height:4px;border-radius:var(--r-lg) var(--r-lg) 0 0;background:'+t.cval+';"></div><span class="tc-icon">'+t.icon+'</span><div class="tc-name">'+t.name+'</div><div class="tc-desc">'+t.desc+'</div></div>'}).join('')+'</div>';document.querySelector('#daily-tip p').textContent=TIPS[new Date().getDate()%TIPS.length];applyTheme()}
function renderStreakDays(){var days=['Su','Mo','Tu','We','Th','Fr','Sa'],today=new Date().getDay();document.getElementById('streak-days').innerHTML=days.map(function(d,i){var isT=i===today,isD=(S.sessions||[]).some(function(s){var sd=new Date(s.date);return sd.getDay()===i&&(Date.now()-sd)<7*864e5});return'<div class="sday '+(isT?'today':'')+' '+(isD?'done':'')+'"><span>'+d+'</span>'+(isD||isT?'<div class="sday-dot"></div>':'')+'</div>'}).join('');document.getElementById('streak-n').textContent=S.streak||0}
function renderStudyList(){var sorted=S.scores?Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a]}):[];var savedCount=(S.savedReviews||[]).length;document.getElementById('study-list-body').innerHTML='<div class="section-label">Study Techniques</div>'+TECHNIQUES.map(function(t){var rank=sorted.indexOf(t.id)+1,pct=S.scores[t.id]||0;return'<div class="tech-list-item" onclick="SFX.tap();openTech(\''+t.id+'\')"><span class="tli-icon">'+t.icon+'</span><div class="tli-info"><div class="tli-name">'+t.name+'</div><div class="tli-desc">'+t.desc+'</div>'+(pct?'<div class="tli-match" style="background:'+t.soft+';color:'+t.cval+';">'+(rank===1?'Best':'#'+rank)+' '+pct+'%</div>':'')+'</div><span style="color:var(--text3);font-size:20px;"></span></div>'}).join('')+'<div class="section-label" style="margin-top:20px;">Test Yourself</div>'+TEST_METHODS.map(function(t){return'<div class="tech-list-item" onclick="SFX.tap();openTestMethod(\''+t.id+'\')"><span class="tli-icon">'+t.icon+'</span><div class="tli-info"><div class="tli-name">'+t.name+'</div><div class="tli-desc">'+t.desc+'</div><div class="tli-match" style="background:'+t.soft+';color:'+t.cval+';">Test</div></div><span style="color:var(--text3);font-size:20px;"></span></div>'}).join('')+'<div class="section-label" style="margin-top:20px;">My Reviews</div><div class="tech-list-item" onclick="SFX.tap();openSavedReviews()"><span class="tli-icon"></span><div class="tli-info"><div class="tli-name">Saved Reviews</div><div class="tli-desc">All your saved study sessions</div><div class="tli-match" style="background:var(--purple-g);color:var(--purple);">'+savedCount+' saved</div></div><span style="color:var(--text3);font-size:20px;"></span></div>'}
var fcDeckIdx=null,fcCardIdx=0,fcFlipped=false,newDeckColor=DECK_COLORS[0];
function initFC(){switchFcTab('decks',document.querySelector('.fc-tab'));renderFCDecks();renderFCCreate();renderFCAI()}
function switchFcTab(tab,el){document.querySelectorAll('.fc-tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.fc-section').forEach(function(s){s.classList.remove('active')});var sec=document.getElementById('fc-'+tab);if(sec)sec.classList.add('active');if(el)el.classList.add('active');else{var tabs=document.querySelectorAll('.fc-tab'),idx=['decks','create','ai','study'].indexOf(tab);if(idx>=0&&idx<3&&tabs[idx])tabs[idx].classList.add('active')}}
function renderFCDecks(){var el=document.getElementById('fc-decks');if(!S.decks||!S.decks.length){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:16px;font-weight:800;margin-bottom:6px;color:var(--text);">No decks yet!</div><div style="font-size:13px;">Create or use AI Gen.</div></div>';return}el.innerHTML=S.decks.map(function(d,i){return'<div class="deck-card" onclick="SFX.tap();openDeck('+i+')"><div class="deck-dot" style="background:'+d.color+';"></div><div class="deck-info"><h4>'+esc(d.name)+'</h4><p>'+(d.subject||'General')+'  '+d.cards.length+' cards</p></div><div class="deck-count">'+d.cards.length+'</div><button onclick="event.stopPropagation();deleteDeck('+i+')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:14px;"></button></div>'}).join('')}
function renderFCCreate(){document.getElementById('fc-create').innerHTML='<div class="create-deck-form"><h4> New Deck</h4><div class="form-group"><label class="form-label">Deck Name</label><input class="form-input" id="new-deck-name" placeholder="e.g. Chapter 3"></div><div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="new-deck-subj" placeholder="e.g. Biology"></div><div class="form-group"><label class="form-label">Color</label><div class="color-picker">'+DECK_COLORS.map(function(c){return'<div class="color-swatch '+(c===newDeckColor?'sel':'')+'" style="background:'+c+';" onclick="newDeckColor=\''+c+'\';document.querySelectorAll(\'.color-swatch\').forEach(function(s){s.classList.remove(\'sel\')});this.classList.add(\'sel\');SFX.pop()"></div>'}).join('')+'</div></div><button class="btn btn-primary btn-full" onclick="createDeck()">Create Deck</button></div>'}
function createDeck(){var n=document.getElementById('new-deck-name').value.trim(),s=document.getElementById('new-deck-subj').value.trim();if(!n){showToast('Name your deck');SFX.error();return}if(!S.decks)S.decks=[];S.decks.push({name:n,subject:s,color:newDeckColor,cards:[]});save();if(S.decks.length>=5)unlock('five_decks');renderFCDecks();renderFCCreate();showToast('Deck created! +10 XP');addXP(10);switchFcTab('decks',null);SFX.correct()}
function deleteDeck(i){if(!confirm('Delete?'))return;S.decks.splice(i,1);save();renderFCDecks();SFX.erase()}
function openDeck(i){fcDeckIdx=i;fcCardIdx=0;fcFlipped=false;renderFCStudy();switchFcTab('study',null)}
function renderFCStudy(){var deck=S.decks[fcDeckIdx];if(!deck)return;var el=document.getElementById('fc-study'),card=deck.cards.length?deck.cards[fcCardIdx]:null;el.innerHTML='<div style="display:flex;align-items:center;margin-bottom:12px;"><button class="btn btn-ghost btn-sm" onclick="SFX.tap();switchFcTab(\'decks\',document.querySelector(\'.fc-tab\'))"> Back</button><span style="font-size:14px;font-weight:800;flex:1;text-align:center;">'+esc(deck.name)+'</span><span class="pill">'+deck.cards.length+'</span></div>'+(deck.cards.length?'<div class="fc-scene" onclick="flipCard()"><div class="fc-inner '+(fcFlipped?'flipped':'')+'" id="fc-inner"><div class="fc-face" style="border-color:'+deck.color+'40;"><div class="fc-face-label">QUESTION</div><div class="fc-face-text">'+esc(card.front)+'</div><div class="fc-face-hint">Tap to flip</div></div><div class="fc-face fc-back-face" style="border-color:'+deck.color+'60;"><div class="fc-face-label">ANSWER</div><div class="fc-face-text">'+esc(card.back)+'</div></div></div></div><div class="fc-rate-btns"><div class="fc-rate fc-again" onclick="rateCard(\'again\')">Again</div><div class="fc-rate fc-hard" onclick="rateCard(\'hard\')">Hard</div><div class="fc-rate fc-good" onclick="rateCard(\'good\')">Easy</div></div><div style="text-align:center;font-size:12px;font-weight:700;color:var(--text3);margin-bottom:10px;">Card '+(fcCardIdx+1)+'/'+deck.cards.length+'</div><div style="text-align:center;margin-bottom:16px;"><button class="btn btn-secondary btn-sm" onclick="SFX.tap();saveFCSession()"> Save Session</button></div>':'<div style="text-align:center;padding:40px 0;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:15px;font-weight:800;color:var(--text);">No cards yet!</div></div>')+'<div class="create-deck-form"><h4> Add Card</h4><textarea class="form-input" id="fc-front" placeholder="Question" style="margin-bottom:8px;min-height:70px;"></textarea><textarea class="form-input" id="fc-back" placeholder="Answer" style="margin-bottom:10px;min-height:70px;"></textarea><button class="btn btn-primary btn-full" onclick="addCard()">Add Card</button></div>'}
function saveFCSession(){var deck=S.decks[fcDeckIdx];if(!deck||!deck.cards.length)return;var content='Deck: '+deck.name+'\nSubject: '+(deck.subject||'General')+'\nTotal Cards: '+deck.cards.length+'\nReviewed up to card: '+(fcCardIdx+1)+'\n\nCards:\n'+deck.cards.map(function(c,i){return(i+1)+'. Q: '+c.front+'\n   A: '+c.back}).join('\n');saveReviewItem('flashcards','Flashcards: '+deck.name,content);addXP(5)}
function flipCard(){fcFlipped=!fcFlipped;var el=document.getElementById('fc-inner');if(el){el.classList.toggle('flipped',fcFlipped);SFX.flip()}}
function rateCard(r){var d=S.decks[fcDeckIdx];if(!d||!d.cards.length)return;fcFlipped=false;if(r!=='again')fcCardIdx=(fcCardIdx+1)%d.cards.length;addXP(r==='good'?10:5);unlock('first_fc');r==='good'?SFX.correct():SFX.tap();renderFCStudy()}
function addCard(){var f=document.getElementById('fc-front').value.trim(),b=document.getElementById('fc-back').value.trim();if(!f||!b){showToast('Fill both sides');SFX.error();return}S.decks[fcDeckIdx].cards.push({front:f,back:b});save();showToast('Card added!');SFX.correct();renderFCStudy()}
function renderFCAI(){document.getElementById('fc-ai').innerHTML='<div class="ai-gen-box"><h4> Smart Generator</h4><p>Upload or paste text to create flashcards.</p><div class="upload-area" onclick="document.getElementById(\'file-input\').click()" ondragover="event.preventDefault();this.classList.add(\'drag\')" ondragleave="this.classList.remove(\'drag\')" ondrop="event.preventDefault();this.classList.remove(\'drag\');if(event.dataTransfer.files[0])handleFile(event.dataTransfer.files[0])"><input type="file" id="file-input" accept="image/*,.pdf,.txt" style="display:none" onchange="handleFile(this.files[0])"><span class="upload-icon"></span><div class="upload-text">Tap to upload</div><div class="upload-hint">Images, PDF, Text</div></div><div id="upload-status-area"></div><textarea class="form-input" id="ai-text-input" placeholder="Paste notes here..." style="min-height:120px;margin:10px 0;"></textarea><input class="form-input" id="ai-deck-name" placeholder="Deck name" style="margin-bottom:10px;"><button class="btn btn-primary btn-full" onclick="generateCards()"> Generate</button></div><div id="ai-preview"></div>'}
async function handleFile(file){if(!file)return;var sa=document.getElementById('upload-status-area');if(file.type==='text/plain'){var r=new FileReader();r.onload=function(e){document.getElementById('ai-text-input').value=e.target.result;sa.innerHTML='<div class="upload-status upload-success"> Loaded</div>';SFX.correct()};r.readAsText(file)}else if(file.type.startsWith('image/')){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> OCR...</div>';try{var res=await Tesseract.recognize(file,'eng+fil');var txt=res.data.text.trim();if(txt.length>10){document.getElementById('ai-text-input').value=txt;sa.innerHTML='<div class="upload-status upload-success"> Extracted</div>';SFX.success()}else{sa.innerHTML='<div class="upload-status" style="background:var(--yellow-soft);color:var(--orange);border:1px solid rgba(249,115,22,0.3);">Low text</div>';SFX.error()}}catch(e){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">Failed</div>';SFX.error()}}else if(file.type==='application/pdf'){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> PDF...</div>';try{pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';var pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;var all='';for(var i=1;i<=Math.min(pdf.numPages,20);i++){var pg=await pdf.getPage(i);var ct=await pg.getTextContent();all+=ct.items.map(function(x){return x.str}).join(' ')+'\n'}if(all.trim().length>20){document.getElementById('ai-text-input').value=all.trim();sa.innerHTML='<div class="upload-status upload-success"> PDF loaded</div>';SFX.success()}else{sa.innerHTML='<div class="upload-status" style="background:var(--yellow-soft);color:var(--orange);">Little text</div>';SFX.error()}}catch(e){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">Failed</div>';SFX.error()}}else{showToast('Unsupported');SFX.error()}}
function generateCards(){var text=document.getElementById('ai-text-input').value.trim(),dn=document.getElementById('ai-deck-name').value.trim();if(!text||text.length<15){showToast('Add more text');SFX.error();return}if(!dn){showToast('Name deck');SFX.error();return}var cards=smartGenCards(text);if(!cards.length){showToast('Could not extract');SFX.error();return}cards=organizeCards(cards);var color=DECK_COLORS[Math.floor(Math.random()*DECK_COLORS.length)];if(!S.decks)S.decks=[];S.decks.push({name:dn,subject:'AI Generated',color:color,cards:cards});save();addXP(20);SFX.success();if(S.decks.length>=5)unlock('five_decks');burst(window.innerWidth/2,300);document.getElementById('ai-preview').innerHTML='<div style="background:var(--green-soft);border:1.5px solid rgba(16,185,129,0.3);border-radius:var(--r-lg);padding:18px;text-align:center;"><div style="font-size:36px;margin-bottom:8px;"></div><div style="font-size:16px;font-weight:800;">'+cards.length+' cards!</div><button class="btn btn-primary" style="margin-top:10px;" onclick="SFX.tap();openDeck('+(S.decks.length-1)+');switchFcTab(\'study\',null)">Study Now</button></div>'}
function smartGenCards(text){var cards=[],lines=text.split('\n').map(function(l){return l.trim()}).filter(function(l){return l.length>3}),isFil=detectFil(text);lines.forEach(function(ln){var m=ln.match(/^([A-Za-z\u00C0-\u024F][^:;\u2013\u2014\n]{1,60}?)\s*[:;\u2013\u2014]\s*(.{8,300})$$/);if(m&&!hasSim(cards,m[1].trim()))cards.push({front:isFil?'Ano ang '+m[1].trim()+'?':'What is '+m[1].trim()+'?',back:cap(m[2].trim()),_t:topic(m[1])})});lines.forEach(function(ln){var m=ln.match(/^\d+[\.\)]\s*([^:;\u2013\u2014]{2,50})\s*[:;\u2013\u2014]\s*(.{8,300})$$/);if(m&&!hasSim(cards,m[1].trim()))cards.push({front:(isFil?'Ipaliwanag: ':'Define: ')+m[1].trim(),back:cap(m[2].trim()),_t:topic(m[1])})});for(var i=0;i<lines.length-1;i++){if(lines[i].endsWith('?')&&lines[i].length>8&&lines[i+1].length>5&&!lines[i+1].endsWith('?')&&!hasSim(cards,lines[i])){cards.push({front:lines[i],back:cap(lines[i+1]),_t:topic(lines[i])});i++}}var sents=text.replace(/([.!;])\s+/g,'\$1|').split('|').map(function(s){return s.trim()}).filter(function(s){return s.length>20&&s.length<350&&!s.endsWith('?')});sents.forEach(function(s){if(cards.length>=35)return;var m=s.match(/^(The\s+|An?\s+)?([A-Z][a-zA-Z\s\-]{1,40}?)\s+(is|are|was|were|refers to|means)\s+(.{8,250})$$/i);if(m&&!hasSim(cards,m[2].trim()))cards.push({front:'What '+m[3].toLowerCase()+' '+m[2].trim()+'?',back:cap(m[2].trim()+' '+m[3].toLowerCase()+' '+m[4].trim()),_t:topic(m[2])})});if(cards.length<8)sents.slice(0,15).forEach(function(s){if(cards.length>=35)return;var w=s.split(/\s+/);if(w.length<5)return;var cands=[];for(var j=2;j<w.length-1;j++){var ww=w[j].replace(/[.,;!?'"]/g,'');if(ww.length>4&&ww[0]===ww[0].toLowerCase()&&!/^(the|and|but|for|with|from|that|this|have|been|will|also|then|than|when|each|only)$$/i.test(ww))cands.push({i:j,w:ww})}if(cands.length){var p=cands[Math.floor(Math.random()*cands.length)];if(!hasSim(cards,p.w))cards.push({front:'Fill in: '+w.map(function(x,k){return k===p.i?'_____':x}).join(' '),back:p.w,_t:'vocabulary'})}});var seen={};return cards.filter(function(c){var k=(c.front+c.back).slice(0,80).toLowerCase();if(seen[k])return false;seen[k]=true;return true}).slice(0,35)}
function detectFil(t){var w=['ang','ng','sa','mga','ay','nang','para','ito','siya','dahil','kung','ano'],ct=0;w.forEach(function(x){var m=t.toLowerCase().match(new RegExp('\\b'+x+'\\b','gi'));if(m)ct+=m.length});return ct>5}
function topic(s){return(s||'').toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(function(w){return w.length>3})[0]||'general'}
function hasSim(cards,t){var l=t.toLowerCase();return cards.some(function(c){return c.front.toLowerCase().indexOf(l)>=0})}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1)}
function organizeCards(cards){var g={};cards.forEach(function(c){var t=c._t||'general';if(!g[t])g[t]=[];g[t].push(c)});var r=[];Object.keys(g).sort().forEach(function(k){g[k].forEach(function(c){delete c._t;r.push(c)})});return r}
var blurtPhase='source',blurtSrc='',blurtTxt='',blurtTimerInt=null,blurtSecs=120;
function initBlurt(){blurtPhase='source';blurtSrc='';blurtTxt='';renderBlurt()}
function renderBlurt(){var el=document.getElementById('blurt-body');if(blurtPhase==='source'){el.innerHTML='<div class="phase-badge" style="background:var(--blue-soft);color:var(--blue);">Step 1: Enter Source</div><div style="font-size:13px;color:var(--text2);margin-bottom:10px;">Paste what you want to memorize.</div><textarea class="form-input" id="blurt-src" placeholder="Paste notes here..." style="min-height:200px;margin-bottom:12px;">'+blurtSrc+'</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();startBlurt()">Start Blurting</button>'}else if(blurtPhase==='blurt'){el.innerHTML='<div class="phase-badge" style="background:var(--pink-soft);color:var(--pink);">Step 2: Write From Memory</div>'+renderDurationAdjuster('blurt-timer',blurtReviewDur,30,600,30,[60,120,180,300])+'<div class="blurt-timer-big" id="bt-timer">'+Math.floor(blurtReviewDur/60)+':'+String(blurtReviewDur%60).padStart(2,'0')+'</div><textarea class="form-input" id="blurt-txt" placeholder="Write from memory..." style="min-height:210px;margin-bottom:12px;"></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-secondary" onclick="SFX.erase();document.getElementById(\'blurt-txt\').value=\'\'">Clear</button><button class="btn btn-primary" onclick="SFX.tap();endBlurt()">Done  Compare</button></div>';startBlurtTimer()}else{el.innerHTML='<div class="phase-badge" style="background:var(--green-soft);color:var(--green);">Step 3: Compare</div><div class="compare-grid"><div class="compare-box"><h5>Source</h5>'+esc(blurtSrc)+'</div><div class="compare-box"><h5>Your Recall</h5>'+(blurtTxt?esc(blurtTxt):'<span style="opacity:0.4;">Nothing</span>')+'</div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;"><button class="btn btn-primary" onclick="SFX.tap();initBlurt()">Again</button><button class="btn btn-secondary" onclick="SFX.tap();saveReviewItem(\'blurting\',\'Blurting Session\',\'Source:\\n\'+blurtSrc+\'\\n\\nRecall:\\n\'+blurtTxt)"> Save</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Done</button></div>'}}
function startBlurt(){blurtSrc=document.getElementById('blurt-src').value.trim();if(!blurtSrc){showToast('Add source');SFX.error();return}blurtTxt='';blurtPhase='blurt';blurtSecs=blurtReviewDur;renderBlurt()}
function startBlurtTimer(){clearInterval(blurtTimerInt);blurtTimerInt=setInterval(function(){blurtSecs--;var el=document.getElementById('bt-timer');if(el)el.textContent=Math.floor(blurtSecs/60)+':'+String(blurtSecs%60).padStart(2,'0');if(blurtSecs<=0){clearInterval(blurtTimerInt);endBlurt()}},1000)}
function endBlurt(){clearInterval(blurtTimerInt);var ta=document.getElementById('blurt-txt');if(ta)blurtTxt=ta.value.trim();blurtPhase='compare';S.blurtCt=(S.blurtCt||0)+1;addXP(15);logSession('blurting');unlock('first_blurt');if(S.blurtCt>=10)unlock('blurt_10');save();SFX.correct();renderBlurt()}
function initCornell(){document.getElementById('cornell-body').innerHTML='<div style="font-size:13px;color:var(--text2);margin-bottom:12px;"><strong>Cornell Notes:</strong> Questions left, notes right.</div><div class="cornell-grid"><div><div class="cornell-lbl">Questions</div><textarea class="form-input" id="cn-q" placeholder="What causes...?" style="min-height:200px;"></textarea></div><div><div class="cornell-lbl">Notes</div><textarea class="form-input" id="cn-n" placeholder="Detailed notes..." style="min-height:200px;"></textarea></div></div><div style="margin-top:10px;"><div class="cornell-lbl">Summary</div><textarea class="form-input" id="cn-s" placeholder="Key takeaways..." style="min-height:70px;"></textarea></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px;"><button class="btn btn-primary" onclick="SFX.tap();addXP(10);logSession(\'question\');SFX.correct();showToast(\'Saved! +10 XP\');saveCornellReview()"> Save</button><button class="btn btn-secondary" onclick="SFX.tap();cornellQuiz()">Quiz</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Done</button></div>'}
function saveCornellReview(){var q=document.getElementById('cn-q'),n=document.getElementById('cn-n'),s=document.getElementById('cn-s');var content='Questions:\n'+(q?q.value:'')+'\n\nNotes:\n'+(n?n.value:'')+'\n\nSummary:\n'+(s?s.value:'');saveReviewItem('question','Cornell Notes',content)}
function cornellQuiz(){var q=document.getElementById('cn-q');if(!q||!q.value.trim()){showToast('Fill questions');SFX.error();return}document.getElementById('cornell-body').innerHTML='<div class="phase-badge" style="background:var(--green-soft);color:var(--green);">Quiz Mode</div><div class="compare-box" style="margin-bottom:12px;">'+esc(q.value)+'</div><textarea class="form-input" placeholder="Write answers..." style="min-height:160px;margin-bottom:10px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();initCornell()">Back</button>'}
var feynStep=0;
function initFeynman(){feynStep=0;renderFeynman()}
function renderFeynman(){var steps=['Concept','Explain','Gaps','Simplify'];document.getElementById('feynman-body').innerHTML='<div class="feynman-steps">'+steps.map(function(s,i){return'<div class="feynman-step '+(i===feynStep?'active':'')+'" onclick="SFX.tap();feynStep='+i+';renderFeynman();">'+(i+1)+'. '+s+'</div>'}).join('')+'</div>'+['<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">What concept?</div><input class="form-input" id="feyn-concept" placeholder="Concept name" style="margin-bottom:10px;"><textarea class="form-input" id="feyn-know" placeholder="What you know..." style="min-height:180px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=1;renderFeynman()">Next</button>','<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Explain simply!</div><textarea class="form-input" id="feyn-explain" placeholder="So basically..." style="min-height:240px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=2;renderFeynman()">Next</button>','<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Where stuck?</div><textarea class="form-input" id="feyn-gaps" placeholder="I got confused..." style="min-height:200px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=3;renderFeynman()">Next</button>','<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Simplest version.</div><textarea class="form-input" id="feyn-simple" placeholder="Final..." style="min-height:200px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();saveFeynman()">Complete!</button>'][feynStep]}
function saveFeynman(){S.feynmanCt=(S.feynmanCt||0)+1;addXP(20);logSession('feynman');if(S.feynmanCt>=5)unlock('feynman_5');var concept=document.getElementById('feyn-concept'),explain=document.getElementById('feyn-explain'),gaps=document.getElementById('feyn-gaps'),simple=document.getElementById('feyn-simple');var content='Concept: '+(concept?concept.value:'')+'\n\nExplanation: '+(explain?explain.value:'')+'\n\nGaps: '+(gaps?gaps.value:'')+'\n\nSimplified: '+(simple?simple.value:'');saveReviewItem('feynman','Feynman: '+(concept?concept.value.substring(0,30):'Topic'),content);save();SFX.success();showToast('Done! +20 XP');feynStep=0;renderFeynman()}
var rrrPhase='read',_rS='',_rR='';
function initRRR(){rrrPhase='read';_rS='';_rR='';renderRRR()}
function renderRRR(){var el=document.getElementById('rrr-body');el.innerHTML='<div class="rrr-btns"><div class="rrr-btn '+(rrrPhase==='read'?'active':'')+'" onclick="SFX.tap();rrrPhase=\'read\';renderRRR()">Read</div><div class="rrr-btn '+(rrrPhase==='recite'?'active':'')+'" onclick="SFX.tap();rrrPhase=\'recite\';renderRRR()">Recite</div><div class="rrr-btn '+(rrrPhase==='review'?'active':'')+'" onclick="SFX.tap();rrrPhase=\'review\';renderRRR()">Review</div></div>'+{read:'<textarea class="form-input" id="rrr-src" placeholder="Paste material..." style="min-height:200px;margin-bottom:12px;">'+_rS+'</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();_rS=document.getElementById(\'rrr-src\').value;rrrPhase=\'recite\';renderRRR()">Recite </button>',recite:'<div class="compare-box" style="margin-bottom:10px;">Source hidden!</div><textarea class="form-input" id="rrr-rec" placeholder="From memory..." style="min-height:200px;margin-bottom:12px;">'+_rR+'</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();_rR=document.getElementById(\'rrr-rec\').value;rrrPhase=\'review\';renderRRR()">Review </button>',review:'<div class="compare-grid"><div class="compare-box"><h5>Original</h5>'+(_rS?esc(_rS):'(empty)')+'</div><div class="compare-box"><h5>Recall</h5>'+(_rR?esc(_rR):'(empty)')+'</div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;"><button class="btn btn-primary" onclick="SFX.tap();addXP(15);logSession(\'rrr\');save();SFX.success();showToast(\'Done! +15 XP\');saveReviewItem(\'rrr\',\'Read Recite Review\',\'Original:\\n\'+_rS+\'\\n\\nRecall:\\n\'+_rR);rrrPhase=\'read\';renderRRR()"> Done</button><button class="btn btn-secondary" onclick="SFX.tap();rrrPhase=\'read\';renderRRR()">Again</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Home</button></div>'}[rrrPhase]}
var wbCtx=null,wbDrawing=false,wbColor='#a78bfa',wbSize=4,wbTool='pen',wbBg='#f5f0ff',wbHistory=[];
function initWB(){wbBg=currentTheme==='dark'?'#16132a':'#f5f0ff';wbHistory=[];renderWBToolbar();var c=document.getElementById('wbCanvas'),w=c.parentElement;var nc=c.cloneNode(false);c.parentNode.replaceChild(nc,c);var cv=document.getElementById('wbCanvas');cv.width=w.clientWidth||380;cv.height=w.clientHeight||400;wbCtx=cv.getContext('2d');wbCtx.lineCap='round';wbCtx.lineJoin='round';wbCtx.fillStyle=wbBg;wbCtx.fillRect(0,0,cv.width,cv.height);wbSaveState();var lp=null;function gXY(e){var r=cv.getBoundingClientRect(),s=e.touches?e.touches[0]:e;return{x:(s.clientX-r.left)*(cv.width/r.width),y:(s.clientY-r.top)*(cv.height/r.height)}}function st(e){e.preventDefault();wbDrawing=true;lp=gXY(e)}function mv(e){e.preventDefault();if(!wbDrawing)return;var p=gXY(e);wbCtx.globalCompositeOperation='source-over';if(wbTool==='eraser'){wbCtx.strokeStyle=wbBg;wbCtx.lineWidth=wbSize*5}else{wbCtx.strokeStyle=wbColor;wbCtx.lineWidth=wbSize}wbCtx.beginPath();wbCtx.moveTo(lp.x,lp.y);wbCtx.lineTo(p.x,p.y);wbCtx.stroke();lp=p}function en(e){e.preventDefault();if(wbDrawing)wbSaveState();wbDrawing=false;lp=null}cv.addEventListener('mousedown',st);cv.addEventListener('mousemove',mv);cv.addEventListener('mouseup',en);cv.addEventListener('mouseleave',en);cv.addEventListener('touchstart',st,{passive:false});cv.addEventListener('touchmove',mv,{passive:false});cv.addEventListener('touchend',en,{passive:false})}
function wbSaveState(){var cv=document.getElementById('wbCanvas');if(cv&&wbCtx){wbHistory.push(cv.toDataURL());if(wbHistory.length>30)wbHistory.shift()}}
function wbUndo(){if(wbHistory.length<=1){showToast('Nothing to undo');return}wbHistory.pop();var last=wbHistory[wbHistory.length-1];if(last){var img=new Image();img.onload=function(){var cv=document.getElementById('wbCanvas');wbCtx.clearRect(0,0,cv.width,cv.height);wbCtx.drawImage(img,0,0)};img.src=last}SFX.undo()}
function renderWBToolbar(){var cls=['#a78bfa','#f472b6','#34d399','#fbbf24','#60a5fa','#fb923c','#ffffff','#ef4444'];document.getElementById('wb-toolbar').innerHTML='<div class="wb-colors">'+cls.map(function(c){return'<div class="wb-color '+(c===wbColor?'sel':'')+'" style="background:'+c+';" onclick="wbColor=\''+c+'\';wbTool=\'pen\';renderWBToolbar();SFX.pop()"></div>'}).join('')+'</div><div class="wb-sizes">'+[2,5,10,18].map(function(s,i){return'<div class="wb-sz '+(s===wbSize?'sel':'')+'" onclick="wbSize='+s+';document.querySelectorAll(\'.wb-sz\').forEach(function(e){e.classList.remove(\'sel\')});this.classList.add(\'sel\');SFX.pop();">'+['S','M','L','XL'][i]+'</div>'}).join('')+'</div><div class="wb-tools"><div class="wb-tool '+(wbTool==='pen'?'sel':'')+'" onclick="wbTool=\'pen\';renderWBToolbar();SFX.tap();">Pen</div><div class="wb-tool '+(wbTool==='eraser'?'sel':'')+'" onclick="wbTool=\'eraser\';renderWBToolbar();SFX.tap();">Erase</div></div>'}
function wbClear(){var c=document.getElementById('wbCanvas');if(wbCtx){wbCtx.fillStyle=wbBg;wbCtx.fillRect(0,0,c.width,c.height);wbSaveState()}showToast('Cleared');SFX.erase()}
function wbSave(){addXP(10);logSession('whiteboard');unlock('first_wb');saveReviewItem('whiteboard','Brain Dump Drawing','[Canvas drawing saved at '+new Date().toLocaleString()+']');save();SFX.success();showToast('Saved! +10 XP');goBack()}
var diagNodes=[],diagEdges=[],diagColor='#8b5cf6',diagConnectMode=false,diagConnectFrom=null;
function initDiag(){diagNodes=[];diagEdges=[];diagConnectMode=false;diagConnectFrom=null;renderDiagToolbar();renderDiagCanvas()}
function renderDiagToolbar(){var cls=['#8b5cf6','#ec4899','#10b981','#fbbf24','#3b82f6','#f97316','#14b8a6'];document.getElementById('diag-toolbar').innerHTML='<div style="display:flex;gap:5px;">'+cls.map(function(c){return'<div class="diag-color '+(c===diagColor?'sel':'')+'" style="background:'+c+';" onclick="diagColor=\''+c+'\';document.querySelectorAll(\'.diag-color\').forEach(function(e){e.classList.remove(\'sel\')});this.classList.add(\'sel\');SFX.pop()"></div>'}).join('')+'</div><input class="diag-add-input" id="diag-node-input" placeholder="Node label..." maxlength="40" onkeydown="if(event.key===\'Enter\'){event.preventDefault();addDiagNode()}"><button class="btn btn-primary btn-xs" onclick="SFX.tap();addDiagNode()">Add</button>'}
function renderDiagCanvas(){var wrap=document.getElementById('diag-wrap'),nEl=document.getElementById('diag-nodes'),cv=document.getElementById('diagCanvas');cv.width=wrap.clientWidth||380;cv.height=wrap.clientHeight||300;var ctx=cv.getContext('2d');ctx.clearRect(0,0,cv.width,cv.height);ctx.lineWidth=2;diagEdges.forEach(function(e){if(diagNodes[e[0]]&&diagNodes[e[1]]){var a=diagNodes[e[0]],b=diagNodes[e[1]];ctx.strokeStyle=a.color+'60';ctx.beginPath();ctx.moveTo(a.x+(a.w||60),a.y+(a.h||25));ctx.lineTo(b.x+(b.w||60),b.y+(b.h||25));ctx.stroke()}});if(!diagNodes.length){nEl.innerHTML='<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);gap:8px;pointer-events:none;"><span style="font-size:44px;"></span><span style="font-size:14px;font-weight:800;color:var(--text);">Add your first node</span></div>';return}nEl.innerHTML=diagNodes.map(function(n,i){return'<div class="diag-node '+(i===0?'root':'')+'" id="dn'+i+'" style="left:'+n.x+'px;top:'+n.y+'px;background:'+n.color+'18;border-color:'+n.color+';color:'+n.color+';" onmousedown="diagDrag(event,'+i+')" ontouchstart="diagDragT(event,'+i+')">'+esc(n.label)+'<div class="diag-node-del" onclick="event.stopPropagation();delDN('+i+')"></div></div>'}).join('');setTimeout(function(){diagNodes.forEach(function(n,i){var el=document.getElementById('dn'+i);if(el){n.w=el.offsetWidth/2;n.h=el.offsetHeight/2}})},30)}
function addDiagNode(){var inp=document.getElementById('diag-node-input'),label=(inp?inp.value:'').trim();if(!label){showToast('Type a label');SFX.error();return}var wrap=document.getElementById('diag-wrap'),W=wrap.clientWidth||380,H=wrap.clientHeight||300;var x=!diagNodes.length?W/2-60:20+Math.random()*(W-140);var y=!diagNodes.length?H/2-25:20+Math.random()*(H-80);if(diagNodes.length)diagEdges.push([0,diagNodes.length]);diagNodes.push({label:label,x:x,y:y,color:diagColor,w:60,h:25});if(inp)inp.value='';renderDiagCanvas();SFX.correct()}
function delDN(i){diagNodes.splice(i,1);diagEdges=diagEdges.filter(function(e){return e[0]!==i&&e[1]!==i}).map(function(e){return[e[0]>i?e[0]-1:e[0],e[1]>i?e[1]-1:e[1]]});renderDiagCanvas();SFX.erase()}
function diagDrag(e,i){if(diagConnectMode){finishConnect(i);return}e.preventDefault();var wrap=document.getElementById('diag-wrap'),r=wrap.getBoundingClientRect();var ox=e.clientX-r.left-diagNodes[i].x,oy=e.clientY-r.top-diagNodes[i].y;function mm(ev){diagNodes[i].x=Math.max(0,Math.min(ev.clientX-r.left-ox,r.width-40));diagNodes[i].y=Math.max(0,Math.min(ev.clientY-r.top-oy,r.height-30));var el=document.getElementById('dn'+i);if(el){el.style.left=diagNodes[i].x+'px';el.style.top=diagNodes[i].y+'px'}renderDiagCanvas()}function mu(){document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu)}document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu)}
function diagDragT(e,i){if(diagConnectMode){finishConnect(i);return}e.preventDefault();var wrap=document.getElementById('diag-wrap'),r=wrap.getBoundingClientRect(),t0=e.touches[0];var ox=t0.clientX-r.left-diagNodes[i].x,oy=t0.clientY-r.top-diagNodes[i].y;function tm(ev){ev.preventDefault();var t=ev.touches[0];diagNodes[i].x=Math.max(0,Math.min(t.clientX-r.left-ox,r.width-40));diagNodes[i].y=Math.max(0,Math.min(t.clientY-r.top-oy,r.height-30));var el=document.getElementById('dn'+i);if(el){el.style.left=diagNodes[i].x+'px';el.style.top=diagNodes[i].y+'px'}renderDiagCanvas()}function te(){document.removeEventListener('touchmove',tm);document.removeEventListener('touchend',te)}document.addEventListener('touchmove',tm,{passive:false});document.addEventListener('touchend',te)}
function finishConnect(i){if(diagConnectFrom===null){diagConnectFrom=i;showToast('Now tap target node')}else{if(diagConnectFrom!==i)diagEdges.push([diagConnectFrom,i]);diagConnectFrom=null;diagConnectMode=false;renderDiagCanvas();SFX.correct()}}
function diagConnect(){diagConnectMode=!diagConnectMode;diagConnectFrom=null;showToast(diagConnectMode?'Connect mode ON':'Connect mode OFF');SFX.tap()}
function diagClear(){diagNodes=[];diagEdges=[];renderDiagCanvas();SFX.erase()}
function diagSave(){S.diagCt=(S.diagCt||0)+1;addXP(15);logSession('diagram');if(S.diagCt>=5)unlock('diagram_5');var nodeLabels=diagNodes.map(function(n){return n.label}).join(', ');saveReviewItem('diagram','Diagram: '+(diagNodes.length?diagNodes[0].label:'Map'),'Nodes: '+nodeLabels+'\nConnections: '+diagEdges.length);save();SFX.success();showToast('Saved! +15 XP')}
function renderSched(){var today=new Date(),days=['Su','Mo','Tu','We','Th','Fr','Sa'];document.getElementById('sched-week').innerHTML=days.map(function(d,i){var dt=new Date(today);dt.setDate(today.getDate()-today.getDay()+i);var ds=dt.toDateString(),isT=i===today.getDay();var has=(S.sessions||[]).some(function(s){return new Date(s.scheduledDate||s.date).toDateString()===ds});var isR=(S.restDays||[]).indexOf(ds)>=0;return'<div class="sched-day '+(isT?'today':'')+' '+(has?'has':'')+' '+(isR?'rest':'')+'"><div class="sched-dlbl">'+d+'</div><div class="sched-dnum">'+dt.getDate()+'</div></div>'}).join('')}
function renderSessList(){var tm=getTechMap();var el=document.getElementById('sess-list');var rc=(S.sessions||[]).slice().reverse().slice(0,12);if(!rc.length){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--text3);font-size:14px;font-weight:700;">No sessions yet!</div>';return}el.innerHTML=rc.map(function(s,idx){var t=tm[s.technique];var realIdx=S.sessions.length-1-idx;var d=new Date(s.scheduledDate||s.date);var ds=d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});return'<div class="sess-item"><div class="sess-dot" style="background:'+(t?t.cval:'var(--purple)')+'"></div><div class="sess-info"><h4>'+(t?t.icon+' ':'')+(s.subject||'Study')+'</h4><p>'+ds+(s.time?' at '+s.time:'')+'</p></div><div class="sess-time">'+(s.duration||0)+'m</div><button class="sess-del" onclick="event.stopPropagation();delSess('+realIdx+')"></button></div>'}).join('')}
function delSess(i){if(i>=0&&i<S.sessions.length){S.sessions.splice(i,1);save();renderSched();renderSessList();showToast('Removed');SFX.erase()}}
function showAddSessionModal(){tpH=2;tpM=0;tpAMPM='PM';updateTimeDisplay();var di=document.getElementById('modal-date');if(di){var td=new Date();di.value=td.toISOString().split('T')[0];di.min=td.toISOString().split('T')[0]}document.getElementById('modal-subject').value='';document.getElementById('modal-duration').value='30';document.getElementById('session-modal').classList.add('show');SFX.whoosh()}
function hideAddSessionModal(){document.getElementById('session-modal').classList.remove('show')}
function confirmAddSession(){var subj=document.getElementById('modal-subject').value.trim(),tech=document.getElementById('modal-technique').value,dur=parseInt(document.getElementById('modal-duration').value)||30,dateVal=document.getElementById('modal-date').value;if(!subj){showToast('Enter a subject');SFX.error();return}if(!dateVal){showToast('Pick a date');SFX.error();return}var timeStr=tpH+':'+String(tpM).padStart(2,'0')+' '+tpAMPM;var h24=tpAMPM==='PM'?(tpH===12?12:tpH+12):(tpH===12?0:tpH);var schedDate=new Date(dateVal+'T'+String(h24).padStart(2,'0')+':'+String(tpM).padStart(2,'0')+':00');if(!S.sessions)S.sessions=[];S.sessions.push({technique:tech,subject:subj,date:new Date().toISOString(),scheduledDate:schedDate.toISOString(),duration:dur,time:timeStr});trackStreak();save();unlock('first_sched');hideAddSessionModal();renderSched();renderSessList();showToast('Session added! +5 XP');addXP(5);burst(window.innerWidth/2,window.innerHeight/2);SFX.correct();scheduleNotificationCheck()}
function updateTimeDisplay(){document.getElementById('modal-time-display').textContent=tpH+':'+String(tpM).padStart(2,'0')+' '+tpAMPM+'  Tap to change'}
function showTimePicker(){var presets=[{l:'6:00 AM',h:6,m:0,a:'AM'},{l:'8:00 AM',h:8,m:0,a:'AM'},{l:'10:00 AM',h:10,m:0,a:'AM'},{l:'12:00 PM',h:12,m:0,a:'PM'},{l:'2:00 PM',h:2,m:0,a:'PM'},{l:'4:00 PM',h:4,m:0,a:'PM'},{l:'6:00 PM',h:6,m:0,a:'PM'},{l:'8:00 PM',h:8,m:0,a:'PM'},{l:'10:00 PM',h:10,m:0,a:'PM'}];document.getElementById('time-presets').innerHTML=presets.map(function(p){return'<div class="time-preset" onclick="tpH='+p.h+';tpM='+p.m+';tpAMPM=\''+p.a+'\';updateTP();SFX.pop()">'+p.l+'</div>'}).join('');updateTP();document.getElementById('time-modal').classList.add('show');SFX.whoosh()}
function hideTimePicker(){document.getElementById('time-modal').classList.remove('show')}
function updateTP(){document.getElementById('tp-hour').textContent=String(tpH).padStart(2,'0');document.getElementById('tp-min').textContent=String(tpM).padStart(2,'0');document.getElementById('tp-pm-am').classList.toggle('active',tpAMPM==='AM');document.getElementById('tp-pm-pm').classList.toggle('active',tpAMPM==='PM')}
function spinTime(type,dir){SFX.pop();if(type==='h'){tpH+=dir;if(tpH>12)tpH=1;if(tpH<1)tpH=12}else{tpM+=dir*5;if(tpM>=60)tpM=0;if(tpM<0)tpM=55}updateTP()}
function setAMPM(v){tpAMPM=v;updateTP();SFX.select()}
function confirmTimePick(){updateTimeDisplay();hideTimePicker();SFX.correct()}
function toggleRest(){if(!S.restDays)S.restDays=[];var td=new Date().toDateString(),idx=S.restDays.indexOf(td);if(idx>=0){S.restDays.splice(idx,1);showToast('Rest day removed')}else{S.restDays.push(td);showToast('Rest day set!');if(S.restDays.length>=3)unlock('study_balance')}save();renderSched();SFX.select()}
function trackStreak(){var td=new Date().toDateString();if(S.lastStudy!==td){var y=new Date();y.setDate(y.getDate()-1);S.streak=S.lastStudy===y.toDateString()?(S.streak||0)+1:1;S.lastStudy=td;if(S.streak>=3)unlock('streak_3');if(S.streak>=7)unlock('streak_7')}}
function logSession(tech,subj,dur){if(!S.sessions)S.sessions=[];S.sessions.push({technique:tech,subject:subj||'',date:new Date().toISOString(),scheduledDate:new Date().toISOString(),duration:dur||25});trackStreak();S.mins=(S.mins||0)+(dur||25);if(S.mins>=600)unlock('hours_10');if(S.mins>=3000)unlock('hours_50');save()}
function toggleTimer(){if(timerOn){clearInterval(timerInt);timerOn=false;document.getElementById('timer-btn').textContent='Resume';renderPomoDurAdjuster()}else{timerOn=true;renderPomoDurAdjuster();document.getElementById('timer-btn').textContent='Pause';timerInt=setInterval(function(){timerSecs--;updateTimerDisplay();if(timerSecs<=0){clearInterval(timerInt);timerOn=false;pomoCt++;if(timerPhase==='focus'){logSession(S.topTech||'flashcards','Pomodoro',reviewDuration);addXP(25);unlock('first_timer');SFX.alarm();showNotification(' Focus complete!','Time for a break!');burst(window.innerWidth/2,300);timerPhase=pomoCt%4===0?'longbreak':'shortbreak';timerSecs=timerPhase==='longbreak'?900:300;renderPomoDurAdjuster()}else{timerPhase='focus';timerSecs=reviewDuration*60;renderPomoDurAdjuster();SFX.alarm();showNotification(' Break over!','Ready for focus?')}document.getElementById('timer-ring').className='timer-ring '+(timerPhase==='focus'?'focus-mode':'break-mode');document.getElementById('timer-phase').textContent=timerPhase==='focus'?'Focus Session':timerPhase==='shortbreak'?'Short Break':'Long Break';document.getElementById('timer-btn').textContent='Start';updateTimerDisplay()}},1000)}SFX.tap()}
function resetTimer(){clearInterval(timerInt);timerOn=false;timerPhase='focus';timerSecs=reviewDuration*60;document.getElementById('timer-btn').textContent='Start';document.getElementById('timer-phase').textContent='Focus Session';document.getElementById('timer-ring').className='timer-ring';updateTimerDisplay();renderPomoDurAdjuster();SFX.tap()}
function renderPomoDurAdjuster(){var el=document.getElementById('pomo-dur-adjuster');if(!el)return;if(timerOn){el.innerHTML='';return}el.innerHTML=renderDurationAdjuster('pomodoro',reviewDuration,5,120,5,[15,25,30,45,60])}
function updateTimerDisplay(){var m=Math.floor(timerSecs/60),s=timerSecs%60;var el=document.getElementById('timer-ring');if(el)el.textContent=m+':'+String(s).padStart(2,'0')}
var notifQueue=[],notifShowing=false,notifCheckInt=null,notifiedSessions={};
function showNotification(title,body){notifQueue.push({title:title,body:body});if(!notifShowing)processNotifQueue();if('Notification' in window&&Notification.permission==='granted'){try{new Notification(title,{body:body})}catch(e){}}}
function processNotifQueue(){if(!notifQueue.length){notifShowing=false;return}notifShowing=true;var n=notifQueue.shift();var el=document.getElementById('notif-banner');if(!el){el=document.createElement('div');el.id='notif-banner';el.style.cssText='position:fixed;top:0;left:50%;transform:translateX(-50%) translateY(-100%);z-index:9995;width:calc(100% - 24px);max-width:440px;background:var(--surface);border:2px solid var(--purple);border-radius:0 0 var(--r-lg) var(--r-lg);padding:16px 20px;backdrop-filter:blur(20px);box-shadow:0 12px 48px var(--shadow2);transition:transform 0.5s cubic-bezier(0.34,1.56,0.64,1),opacity 0.4s ease;opacity:0;cursor:pointer;font-family:Nunito,sans-serif;';el.onclick=function(){dismissNotif()};document.body.appendChild(el)}el.innerHTML='<div style="display:flex;align-items:center;gap:12px;"><div style="font-size:28px;flex-shrink:0;"></div><div style="flex:1;"><div style="font-size:13px;font-weight:900;color:var(--purple);margin-bottom:2px;">'+n.title+'</div><div style="font-size:12px;color:var(--text2);line-height:1.4;">'+n.body+'</div></div><div style="font-size:16px;color:var(--text3);flex-shrink:0;"></div></div>';SFX.notifSound();requestAnimationFrame(function(){el.style.transform='translateX(-50%) translateY(0)';el.style.opacity='1'});setTimeout(function(){dismissNotif()},6000)}
function dismissNotif(){var el=document.getElementById('notif-banner');if(el){el.style.transform='translateX(-50%) translateY(-100%)';el.style.opacity='0'}setTimeout(function(){notifShowing=false;processNotifQueue()},500)}
function scheduleNotificationCheck(){if(notifCheckInt)return;notifCheckInt=setInterval(checkUpcomingSessions,30000);checkUpcomingSessions()}
function checkUpcomingSessions(){if(!S.sessions||!S.sessions.length)return;var now=Date.now();S.sessions.forEach(function(s,i){if(!s.scheduledDate)return;var sd=new Date(s.scheduledDate).getTime();var diff=sd-now;var key='sess_'+i+'_'+s.scheduledDate;if(diff>0&&diff<=5*60*1000&&!notifiedSessions[key+'_5']){notifiedSessions[key+'_5']=true;showNotification(' Session in 5 minutes!','"'+(s.subject||'Study')+'" starts soon!')}if(diff>0&&diff<=60*1000&&!notifiedSessions[key+'_1']){notifiedSessions[key+'_1']=true;showNotification(' Starting now!','"'+(s.subject||'Study')+'" begins!')}if(diff<=0&&diff>-60*1000&&!notifiedSessions[key+'_now']){notifiedSessions[key+'_now']=true;showNotification(' Time to study!','"'+(s.subject||'Study')+'" session started!')}})}
document.addEventListener('click',function(){if('Notification' in window&&Notification.permission==='default'){Notification.requestPermission()}},{once:true});
function renderDurationAdjuster(id,current,min,max,step,presets){return'<div class="duration-adjuster"><div class="dur-btn" onclick="adjustDur(\''+id+'\',-'+step+','+min+','+max+')"></div><div><div class="dur-display" id="dur-val-'+id+'">'+current+'</div><div class="dur-label">minutes</div></div><div class="dur-btn" onclick="adjustDur(\''+id+'\','+step+','+min+','+max+')">+</div></div>'+(presets?'<div class="dur-presets">'+presets.map(function(p){return'<div class="dur-preset '+(p===current?'active':'')+'" onclick="setDur(\''+id+'\','+p+','+min+','+max+')">'+p+'m</div>'}).join('')+'</div>':'')}
function adjustDur(id,delta,min,max){SFX.pop();var el=document.getElementById('dur-val-'+id);if(!el)return;var v=parseInt(el.textContent)||25;v+=delta;if(v<min)v=min;if(v>max)v=max;el.textContent=v;updateDurPresets(id,v);applyDurChange(id,v)}
function setDur(id,val,min,max){SFX.select();var el=document.getElementById('dur-val-'+id);if(!el)return;if(val<min)val=min;if(val>max)val=max;el.textContent=val;updateDurPresets(id,val);applyDurChange(id,val)}
function updateDurPresets(id,val){var container=document.getElementById('dur-val-'+id);if(!container)return;var wrap=container.closest('.tech-body')||container.closest('.scroll-body')||document.body;wrap.querySelectorAll('.dur-preset').forEach(function(p){p.classList.toggle('active',parseInt(p.textContent)===val)})}
function applyDurChange(id,val){if(id==='pomodoro'){if(!timerOn){timerSecs=val*60;timerPhase='focus';updateTimerDisplay()}reviewDuration=val}else if(id==='blurt-timer'){blurtReviewDur=val;blurtSecs=val;var btEl=document.getElementById('bt-timer');if(btEl)btEl.textContent=Math.floor(val/60)+':'+String(val%60).padStart(2,'0')}}
function unlock(key){if(!S.ach)S.ach=[];if(S.ach.indexOf(key)>=0)return;S.ach.push(key);var def=ACHIEVEMENTS_DEF.find(function(a){return a.key===key});if(!def)return;var xm={common:10,rare:25,epic:50,legendary:100};addXP(xm[def.rarity]||10);var nonLeg=ACHIEVEMENTS_DEF.filter(function(a){return a.rarity!=='legendary'}).map(function(a){return a.key});if(nonLeg.every(function(k){return S.ach.indexOf(k)>=0}))setTimeout(function(){unlock('all_ach')},600);save();showAchPop(def.icon,def.name);SFX.unlock()}
function showAchPop(icon,name){document.getElementById('ap-icon').textContent=icon;document.getElementById('ap-name').textContent=name;var p=document.getElementById('ach-popup');p.classList.add('show');burst(window.innerWidth/2,60,['#fbbf24','#f97316','#8b5cf6'],12);setTimeout(function(){p.classList.remove('show')},3500)}
function renderAch(){if(!S.ach)S.ach=[];document.getElementById('ach-count').textContent=S.ach.length+'/'+ACHIEVEMENTS_DEF.length;document.getElementById('ach-grid').innerHTML=ACHIEVEMENTS_DEF.map(function(a){var u=S.ach.indexOf(a.key)>=0,isNew=u&&S.ach.slice(-3).indexOf(a.key)>=0;return'<div class="ach-card '+(u?'unlocked':'locked')+'">'+(isNew?'<div class="ach-new">NEW</div>':'')+'<span class="ach-icon">'+a.icon+'</span><div class="ach-name">'+a.name+'</div><div class="ach-desc">'+(u?a.desc:'???')+'</div><span class="ach-rarity r-'+a.rarity+'">'+a.rarity+'</span></div>'}).join('')}
function addXP(n){S.xp=(S.xp||0)+n;save()}
var _toastT=null;
function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(_toastT);_toastT=setTimeout(function(){t.classList.remove('show')},2800)}

function analyzeContentForQuestionCount(text){var sents=text.replace(/([.!;])\s+/g,'\$1|').split('|').filter(function(s){return s.trim().length>15});var lines=text.split('\n').filter(function(l){return l.trim().length>5});var factCount=0;sents.forEach(function(s){if(s.match(/(is|are|was|were|refers to|means|contains|includes|consists of|involves)\s+/i))factCount++});lines.forEach(function(ln){if(ln.match(/^[A-Za-z\u00C0-\u024F][^:;\u2013\u2014\n]{1,60}?\s*[:;\u2013\u2014]\s*.{8,}/))factCount++});var wordCount=text.split(/\s+/).length;var density=Math.max(factCount,Math.floor(wordCount/40));var count=Math.max(3,Math.min(25,density));if(count<=4)return{count:count,label:'Short content  '+count+' questions'};if(count<=8)return{count:count,label:'Medium content  '+count+' questions'};if(count<=15)return{count:count,label:'Rich content  '+count+' questions'};return{count:count,label:'Very detailed  '+count+' questions'}}

var mcqQuestions=[],mcqAnswers={},mcqSubmitted=false,mcqSourceText='';
function initMCQ(){mcqQuestions=[];mcqAnswers={};mcqSubmitted=false;mcqSourceText='';renderMCQGenerate();switchTestTab('mcq','generate',document.querySelector('#screen-mcq .test-tab'))}
function switchTestTab(type,tab,el){var screen=document.getElementById('screen-'+type);if(!screen)return;screen.querySelectorAll('.test-tab').forEach(function(t){t.classList.remove('active')});screen.querySelectorAll('.test-section').forEach(function(s){s.classList.remove('active')});var sec=document.getElementById(type+'-'+tab);if(sec)sec.classList.add('active');if(el)el.classList.add('active');else{var tabs=screen.querySelectorAll('.test-tab'),idx=['generate','take','results'].indexOf(tab);if(idx>=0&&tabs[idx])tabs[idx].classList.add('active')}}
function renderMCQGenerate(){document.getElementById('mcq-generate').innerHTML='<div class="ai-gen-box"><h4> Generate MCQ Test</h4><p>Upload PDF, photo, or paste text. The app will automatically decide the best number of questions based on your content.</p><div class="upload-area" onclick="document.getElementById(\'mcq-file-input\').click()" ondragover="event.preventDefault();this.classList.add(\'drag\')" ondragleave="this.classList.remove(\'drag\')" ondrop="event.preventDefault();this.classList.remove(\'drag\');if(event.dataTransfer.files[0])handleTestFile(event.dataTransfer.files[0],\'mcq\')"><input type="file" id="mcq-file-input" accept="image/*,.pdf,.txt" style="display:none" onchange="handleTestFile(this.files[0],\'mcq\')"><span class="upload-icon"></span><div class="upload-text">Tap to upload</div><div class="upload-hint">Images, PDF, Text</div></div><div id="mcq-upload-status"></div><textarea class="form-input" id="mcq-text-input" placeholder="Or paste your notes/content here..." style="min-height:120px;margin:10px 0;" oninput="updateMCQPreview()"></textarea><div id="mcq-smart-count" style="padding:8px 14px;border-radius:var(--r-sm);background:var(--purple-g);border:1px solid rgba(139,92,246,0.2);font-size:12px;font-weight:700;color:var(--purple);margin-bottom:10px;display:none;"><span id="mcq-smart-label"> Analyzing...</span></div><input class="form-input" id="mcq-test-name" placeholder="Test name (e.g. Biology Ch.3)" style="margin-bottom:12px;"><button class="btn btn-primary btn-full" onclick="generateMCQTest()"> Generate MCQ Test</button></div><div id="mcq-gen-preview"></div>'}
function updateMCQPreview(){var text=document.getElementById('mcq-text-input').value.trim();var el=document.getElementById('mcq-smart-count');if(text.length<30){el.style.display='none';return}el.style.display='block';var info=analyzeContentForQuestionCount(text);document.getElementById('mcq-smart-label').textContent=' '+info.label}
async function handleTestFile(file,type){if(!file)return;var sa=document.getElementById(type+'-upload-status');var textInput=document.getElementById(type+'-text-input');if(file.type==='text/plain'){var r=new FileReader();r.onload=function(e){textInput.value=e.target.result;sa.innerHTML='<div class="upload-status upload-success"> Text loaded</div>';SFX.correct();if(type==='mcq')updateMCQPreview();if(type==='tf')updateTFPreview()};r.readAsText(file)}else if(file.type.startsWith('image/')){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> Running OCR...</div>';try{var res=await Tesseract.recognize(file,'eng+fil');var txt=res.data.text.trim();if(txt.length>10){textInput.value=txt;sa.innerHTML='<div class="upload-status upload-success"> Text extracted from image</div>';SFX.success();if(type==='mcq')updateMCQPreview();if(type==='tf')updateTFPreview()}else{sa.innerHTML='<div class="upload-status" style="background:var(--yellow-soft);color:var(--orange);border:1px solid rgba(249,115,22,0.3);">Low text detected</div>';SFX.error()}}catch(e){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">OCR failed</div>';SFX.error()}}else if(file.type==='application/pdf'){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> Reading PDF...</div>';try{pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';var pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;var all='';for(var i=1;i<=Math.min(pdf.numPages,20);i++){var pg=await pdf.getPage(i);var ct=await pg.getTextContent();all+=ct.items.map(function(x){return x.str}).join(' ')+'\n'}if(all.trim().length>20){textInput.value=all.trim();sa.innerHTML='<div class="upload-status upload-success"> PDF text extracted</div>';SFX.success();if(type==='mcq')updateMCQPreview();if(type==='tf')updateTFPreview()}else{sa.innerHTML='<div class="upload-status" style="background:var(--yellow-soft);color:var(--orange);">Very little text found</div>';SFX.error()}}catch(e){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">PDF read failed</div>';SFX.error()}}else{showToast('Unsupported file type');SFX.error()}}
function generateMCQTest(){var text=document.getElementById('mcq-text-input').value.trim();var testName=document.getElementById('mcq-test-name').value.trim()||'MCQ Test';if(!text||text.length<30){showToast('Add more text content');SFX.error();return}var smartInfo=analyzeContentForQuestionCount(text);var count=smartInfo.count;mcqSourceText=text;mcqQuestions=generateMCQFromText(text,count);mcqAnswers={};mcqSubmitted=false;if(!mcqQuestions.length){showToast('Could not generate questions');SFX.error();return}addXP(15);SFX.success();burst(window.innerWidth/2,300);document.getElementById('mcq-gen-preview').innerHTML='<div style="background:var(--green-soft);border:1.5px solid rgba(16,185,129,0.3);border-radius:var(--r-lg);padding:18px;text-align:center;margin-top:14px;"><div style="font-size:36px;margin-bottom:8px;"></div><div style="font-size:16px;font-weight:800;">'+mcqQuestions.length+' questions generated!</div><div style="font-size:12px;color:var(--text2);margin-top:4px;">'+testName+'</div><button class="btn btn-primary" style="margin-top:12px;" onclick="SFX.tap();renderMCQTake();switchTestTab(\'mcq\',\'take\',null)">Take Test Now</button></div>'}
function generateMCQFromText(text,count){var questions=[];var sents=text.replace(/([.!;])\s+/g,'\$1|').split('|').map(function(s){return s.trim()}).filter(function(s){return s.length>15&&s.length<400&&!s.endsWith('?')});var isFil=detectFil(text);var factPairs=[];sents.forEach(function(s){var m=s.match(/^(The\s+|An?\s+)?([A-Z][a-zA-Z\s\-]{1,50}?)\s+(is|are|was|were|refers to|means|contains|includes|consists of|involves)\s+(.{5,250})$$/i);if(m)factPairs.push({subject:m[2].trim(),verb:m[3].toLowerCase(),object:m[4].trim().replace(/\.$$/,''),full:s})});var lines=text.split('\n').map(function(l){return l.trim()}).filter(function(l){return l.length>5});lines.forEach(function(ln){var m=ln.match(/^([A-Za-z\u00C0-\u024F][^:;\u2013\u2014\n]{1,60}?)\s*[:;\u2013\u2014]\s*(.{8,300})$$/);if(m)factPairs.push({subject:m[1].trim(),verb:'is',object:m[2].trim().replace(/\.$$/,''),full:ln})});var usedSubjects={};factPairs.forEach(function(fp){if(questions.length>=count)return;if(usedSubjects[fp.subject.toLowerCase()])return;usedSubjects[fp.subject.toLowerCase()]=true;var correctAns=fp.object.length>80?fp.object.substring(0,80)+'...':fp.object;var distractors=generateDistractors(fp.object,factPairs,fp.subject);if(distractors.length<3)return;var opts=[{text:correctAns,correct:true}];distractors.slice(0,3).forEach(function(d){opts.push({text:d,correct:false})});opts=shuffleArray(opts);questions.push({question:(isFil?'Ano ang ':'What ')+fp.verb+' '+fp.subject+'?',options:opts,explanation:fp.full})});if(questions.length<count){var words=extractKeyTerms(text);words.forEach(function(term){if(questions.length>=count)return;if(usedSubjects[term.word.toLowerCase()])return;usedSubjects[term.word.toLowerCase()]=true;var contextSent=sents.find(function(s){return s.toLowerCase().indexOf(term.word.toLowerCase())>=0});if(!contextSent)return;var blanked=contextSent.replace(new RegExp(term.word.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i'),'_____');var distractors=generateWordDistractors(term.word,words);if(distractors.length<3)return;var opts=[{text:term.word,correct:true}];distractors.slice(0,3).forEach(function(d){opts.push({text:d,correct:false})});opts=shuffleArray(opts);questions.push({question:'Fill in the blank: '+blanked,options:opts,explanation:contextSent})})}return questions.slice(0,count)}
function generateDistractors(correct,allFacts,excludeSubj){var distractors=[];allFacts.forEach(function(fp){if(fp.subject.toLowerCase()!==excludeSubj.toLowerCase()&&fp.object!==correct){var d=fp.object.length>80?fp.object.substring(0,80)+'...':fp.object;if(distractors.indexOf(d)<0)distractors.push(d)}});if(distractors.length<3){var parts=correct.split(/\s+/);if(parts.length>2)distractors.push(parts.reverse().join(' ').substring(0,correct.length));distractors.push('None of the above');distractors.push('All of the above')}return distractors.slice(0,3)}
function generateWordDistractors(word,allTerms){var d=[];allTerms.forEach(function(t){if(t.word.toLowerCase()!==word.toLowerCase()&&d.indexOf(t.word)<0)d.push(t.word)});if(d.length<3){d.push('undefined');d.push('unknown');d.push('various')}return d.slice(0,3)}
function extractKeyTerms(text){var words={};text.split(/\s+/).forEach(function(w){var clean=w.replace(/[^a-zA-Z\u00C0-\u024F]/g,'');if(clean.length>4&&!/^(about|after|again|along|among|being|between|could|doing|during|every|found|going|great|having|known|large|might|never|often|other|place|quite|right|since|small|their|there|these|thing|those|three|under|using|where|which|while|whole|world|would|years)$/i.test(clean))words[clean]=(words[clean]||0)+1});return Object.keys(words).sort(function(a,b){return words[b]-words[a]}).slice(0,20).map(function(w){return{word:w,count:words[w]}})}
function shuffleArray(arr){var a=arr.slice();for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t}return a}
function renderMCQTake(){var el=document.getElementById('mcq-take');if(!mcqQuestions.length){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:16px;font-weight:800;color:var(--text);">No test generated yet</div><div style="font-size:13px;">Go to Generate tab first</div></div>';return}el.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;"><span style="font-size:14px;font-weight:800;">'+mcqQuestions.length+' Questions</span>'+(mcqSubmitted?'<span class="pill" style="background:var(--green-soft);color:var(--green);">Submitted</span>':'<span class="pill">In Progress</span>')+'</div>'+mcqQuestions.map(function(q,i){var userAns=mcqAnswers[i];return'<div class="test-q-card"><div class="test-q-num">Question '+(i+1)+'</div><div class="test-q-text">'+esc(q.question)+'</div>'+q.options.map(function(opt,oi){var cls='test-opt';if(mcqSubmitted){if(opt.correct)cls+=' correct';else if(userAns===oi&&!opt.correct)cls+=' wrong'}else if(userAns===oi)cls+=' selected';return'<div class="'+cls+'" onclick="selectMCQ('+i+','+oi+')"><div class="opt-letter">'+String.fromCharCode(65+oi)+'</div><span>'+esc(opt.text)+'</span></div>'}).join('')+'<div class="test-explanation '+(mcqSubmitted?'show':'')+'"> '+esc(q.explanation)+'</div></div>'}).join('')+(mcqSubmitted?'':'<button class="btn btn-primary btn-full" style="margin-top:10px;" onclick="submitMCQ()">Submit Test</button>')}
function selectMCQ(qi,oi){if(mcqSubmitted)return;mcqAnswers[qi]=oi;SFX.select();renderMCQTake()}
function submitMCQ(){var answered=Object.keys(mcqAnswers).length;if(answered<mcqQuestions.length){showToast('Answer all '+mcqQuestions.length+' questions');SFX.error();return}mcqSubmitted=true;var correct=0;mcqQuestions.forEach(function(q,i){var userAns=mcqAnswers[i];if(userAns!==undefined&&q.options[userAns]&&q.options[userAns].correct)correct++});var pct=Math.round(correct/mcqQuestions.length*100);addXP(20);logSession('mcq','MCQ Test',15);save();SFX.success();burst(window.innerWidth/2,300);renderMCQTake();renderMCQResults(correct,pct);switchTestTab('mcq','results',null);saveReviewItem('mcq','MCQ Test  '+pct+'%','Score: '+correct+'/'+mcqQuestions.length+' ('+pct+'%)\n\nQuestions:\n'+mcqQuestions.map(function(q,i){var ua=mcqAnswers[i];var isCorrect=q.options[ua]&&q.options[ua].correct;return(i+1)+'. '+q.question+'  '+(isCorrect?' Correct':' Wrong')}).join('\n'))}
function renderMCQResults(correct,pct){var el=document.getElementById('mcq-results');correct=correct||0;pct=pct||0;if(!mcqSubmitted){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:16px;font-weight:800;color:var(--text);">No results yet</div><div style="font-size:13px;">Take the test first</div></div>';return}var emoji=pct>=90?'':pct>=70?'':pct>=50?'':'';el.innerHTML='<div class="test-score-card"><div style="font-size:48px;margin-bottom:8px;">'+emoji+'</div><div class="test-score-big">'+pct+'%</div><div class="test-score-label">'+correct+' out of '+mcqQuestions.length+' correct</div></div><div style="font-size:13px;color:var(--text2);margin-bottom:16px;text-align:center;">'+(pct>=90?'Outstanding!':pct>=70?'Great job!':pct>=50?'Good effort!':'Keep studying!')+'</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-primary" onclick="SFX.tap();initMCQ()">New Test</button><button class="btn btn-secondary" onclick="SFX.tap();renderMCQTake();switchTestTab(\'mcq\',\'take\',null)">Review</button></div>'}

var tfQuestions=[],tfAnswers={},tfSubmitted=false,tfSourceText='';
function initTF(){tfQuestions=[];tfAnswers={};tfSubmitted=false;tfSourceText='';renderTFGenerate();switchTestTab('tf','generate',document.querySelector('#screen-tf .test-tab'))}
function renderTFGenerate(){document.getElementById('tf-generate').innerHTML='<div class="ai-gen-box"><h4> Generate True/False Test</h4><p>Upload PDF, photo, or paste text. The app will automatically decide the best number of questions.</p><div class="upload-area" onclick="document.getElementById(\'tf-file-input\').click()" ondragover="event.preventDefault();this.classList.add(\'drag\')" ondragleave="this.classList.remove(\'drag\')" ondrop="event.preventDefault();this.classList.remove(\'drag\');if(event.dataTransfer.files[0])handleTestFile(event.dataTransfer.files[0],\'tf\')"><input type="file" id="tf-file-input" accept="image/*,.pdf,.txt" style="display:none" onchange="handleTestFile(this.files[0],\'tf\')"><span class="upload-icon"></span><div class="upload-text">Tap to upload</div><div class="upload-hint">Images, PDF, Text</div></div><div id="tf-upload-status"></div><textarea class="form-input" id="tf-text-input" placeholder="Or paste your notes/content here..." style="min-height:120px;margin:10px 0;" oninput="updateTFPreview()"></textarea><div id="tf-smart-count" style="padding:8px 14px;border-radius:var(--r-sm);background:rgba(5,150,105,0.12);border:1px solid rgba(5,150,105,0.2);font-size:12px;font-weight:700;color:#059669;margin-bottom:10px;display:none;"><span id="tf-smart-label"> Analyzing...</span></div><input class="form-input" id="tf-test-name" placeholder="Test name (e.g. History Ch.2)" style="margin-bottom:12px;"><button class="btn btn-primary btn-full" onclick="generateTFTest()"> Generate T/F Test</button></div><div id="tf-gen-preview"></div>'}
function updateTFPreview(){var text=document.getElementById('tf-text-input').value.trim();var el=document.getElementById('tf-smart-count');if(text.length<30){el.style.display='none';return}el.style.display='block';var info=analyzeContentForQuestionCount(text);document.getElementById('tf-smart-label').textContent=' '+info.label}
function generateTFTest(){var text=document.getElementById('tf-text-input').value.trim();var testName=document.getElementById('tf-test-name').value.trim()||'T/F Test';if(!text||text.length<30){showToast('Add more text content');SFX.error();return}var smartInfo=analyzeContentForQuestionCount(text);var count=smartInfo.count;tfSourceText=text;tfQuestions=generateTFFromText(text,count);tfAnswers={};tfSubmitted=false;if(!tfQuestions.length){showToast('Could not generate questions');SFX.error();return}addXP(15);SFX.success();burst(window.innerWidth/2,300);document.getElementById('tf-gen-preview').innerHTML='<div style="background:var(--green-soft);border:1.5px solid rgba(16,185,129,0.3);border-radius:var(--r-lg);padding:18px;text-align:center;margin-top:14px;"><div style="font-size:36px;margin-bottom:8px;"></div><div style="font-size:16px;font-weight:800;">'+tfQuestions.length+' T/F questions generated!</div><div style="font-size:12px;color:var(--text2);margin-top:4px;">'+testName+'</div><button class="btn btn-primary" style="margin-top:12px;" onclick="SFX.tap();renderTFTake();switchTestTab(\'tf\',\'take\',null)">Take Test Now</button></div>'}
function generateTFFromText(text,count){var questions=[];var sents=text.replace(/([.!;])\s+/g,'\$1|').split('|').map(function(s){return s.trim()}).filter(function(s){return s.length>15&&s.length<300&&!s.endsWith('?')});var factSents=[];sents.forEach(function(s){var m=s.match(/^(The\s+|An?\s+)?([A-Z][a-zA-Z\s\-]{1,50}?)\s+(is|are|was|were|has|have|can|will|refers to|means|contains|includes)\s+(.{5,200})$$/i);if(m)factSents.push({subject:m[2].trim(),verb:m[3].toLowerCase(),object:m[4].trim().replace(/\.$$/,''),full:s})});var lines=text.split('\n').map(function(l){return l.trim()}).filter(function(l){return l.length>5});lines.forEach(function(ln){var m=ln.match(/^([A-Za-z\u00C0-\u024F][^:;\u2013\u2014\n]{1,60}?)\s*[:;\u2013\u2014]\s*(.{8,250})$$/);if(m)factSents.push({subject:m[1].trim(),verb:'is',object:m[2].trim().replace(/\.$$/,''),full:ln})});var usedQ={};factSents.forEach(function(fp){if(questions.length>=count)return;var trueStatement=fp.subject+' '+fp.verb+' '+fp.object+'.';if(usedQ[trueStatement.toLowerCase()])return;usedQ[trueStatement.toLowerCase()]=true;if(Math.random()>0.5){questions.push({statement:trueStatement,answer:true,explanation:'This is correct. '+fp.full})}else{var falseObj=makeFalseStatement(fp,factSents);questions.push({statement:fp.subject+' '+fp.verb+' '+falseObj+'.',answer:false,explanation:'This is false. The correct statement is: '+fp.full})}});if(questions.length<count){sents.forEach(function(s){if(questions.length>=count)return;if(s.length<20||s.length>200)return;if(usedQ[s.toLowerCase()])return;usedQ[s.toLowerCase()]=true;if(Math.random()>0.4){questions.push({statement:s,answer:true,explanation:'This statement is correct.'})}else{var words=s.split(/\s+/);var negations=['not','never','rarely','seldom'];var insertIdx=Math.min(3,Math.floor(words.length/2));words.splice(insertIdx,0,negations[Math.floor(Math.random()*negations.length)]);questions.push({statement:words.join(' '),answer:false,explanation:'This is false. Original: '+s})}})}return shuffleArray(questions).slice(0,count)}
function makeFalseStatement(fp,allFacts){var others=allFacts.filter(function(f){return f.subject.toLowerCase()!==fp.subject.toLowerCase()&&f.object!==fp.object});if(others.length)return others[Math.floor(Math.random()*others.length)].object;return'the opposite of '+fp.object}
function renderTFTake(){var el=document.getElementById('tf-take');if(!tfQuestions.length){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:16px;font-weight:800;color:var(--text);">No test generated yet</div><div style="font-size:13px;">Go to Generate tab first</div></div>';return}el.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;"><span style="font-size:14px;font-weight:800;">'+tfQuestions.length+' Questions</span>'+(tfSubmitted?'<span class="pill" style="background:var(--green-soft);color:var(--green);">Submitted</span>':'<span class="pill">In Progress</span>')+'</div>'+tfQuestions.map(function(q,i){var userAns=tfAnswers[i];return'<div class="test-q-card"><div class="test-q-num">Question '+(i+1)+'</div><div class="test-q-text">'+esc(q.statement)+'</div><div class="tf-btns"><div class="tf-btn '+(tfSubmitted?(q.answer===true?'correct':(userAns===true&&q.answer!==true?'wrong':'')):(userAns===true?'selected':''))+'" onclick="selectTF('+i+',true)"> True</div><div class="tf-btn '+(tfSubmitted?(q.answer===false?'correct':(userAns===false&&q.answer!==false?'wrong':'')):(userAns===false?'selected':''))+'" onclick="selectTF('+i+',false)"> False</div></div><div class="test-explanation '+(tfSubmitted?'show':'')+'"> '+esc(q.explanation)+'</div></div>'}).join('')+(tfSubmitted?'':'<button class="btn btn-primary btn-full" style="margin-top:10px;" onclick="submitTF()">Submit Test</button>')}
function selectTF(qi,val){if(tfSubmitted)return;tfAnswers[qi]=val;SFX.select();renderTFTake()}
function submitTF(){var answered=Object.keys(tfAnswers).length;if(answered<tfQuestions.length){showToast('Answer all '+tfQuestions.length+' questions');SFX.error();return}tfSubmitted=true;var correct=0;tfQuestions.forEach(function(q,i){if(tfAnswers[i]===q.answer)correct++});var pct=Math.round(correct/tfQuestions.length*100);addXP(20);logSession('tf','T/F Test',10);save();SFX.success();burst(window.innerWidth/2,300);renderTFTake();renderTFResults(correct,pct);switchTestTab('tf','results',null);saveReviewItem('tf','T/F Test  '+pct+'%','Score: '+correct+'/'+tfQuestions.length+' ('+pct+'%)\n\nQuestions:\n'+tfQuestions.map(function(q,i){var isCorrect=tfAnswers[i]===q.answer;return(i+1)+'. '+q.statement+'  '+(isCorrect?' Correct':' Wrong')+' (Answer: '+(q.answer?'True':'False')+')'}).join('\n'))}
function renderTFResults(correct,pct){var el=document.getElementById('tf-results');correct=correct||0;pct=pct||0;if(!tfSubmitted){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:16px;font-weight:800;color:var(--text);">No results yet</div></div>';return}var emoji=pct>=90?'':pct>=70?'':pct>=50?'':'';el.innerHTML='<div class="test-score-card"><div style="font-size:48px;margin-bottom:8px;">'+emoji+'</div><div class="test-score-big">'+pct+'%</div><div class="test-score-label">'+correct+' out of '+tfQuestions.length+' correct</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-primary" onclick="SFX.tap();initTF()">New Test</button><button class="btn btn-secondary" onclick="SFX.tap();renderTFTake();switchTestTab(\'tf\',\'take\',null)">Review</button></div>'}

function saveReviewItem(technique,title,content){if(!S.savedReviews)S.savedReviews=[];S.savedReviews.push({id:Date.now()+'_'+Math.random().toString(36).substr(2,5),technique:technique,title:title||'Study Session',content:content||'',date:new Date().toISOString()});save();showToast(' Review saved!')}
function openSavedReviews(){renderSavedReviews();navigateTo('screen-saved','up')}
function renderSavedReviews(){var el=document.getElementById('saved-body');if(!S.savedReviews)S.savedReviews=[];document.getElementById('saved-count').textContent=S.savedReviews.length+' saved';if(!S.savedReviews.length){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:16px;font-weight:800;margin-bottom:6px;color:var(--text);">No saved reviews yet!</div><div style="font-size:13px;">Complete study sessions to save reviews here.</div></div>';return}var techMap=getTechMap();var reviews=S.savedReviews.slice().reverse();el.innerHTML='<div class="section-label">All Saved Reviews ('+reviews.length+')</div>'+reviews.map(function(r,revIdx){var realIdx=S.savedReviews.length-1-revIdx;var t=techMap[r.technique];var d=new Date(r.date);var dateStr=d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});var timeStr=d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});return'<div class="saved-review-card" onclick="SFX.tap();openSavedDetail('+realIdx+')"><div class="sr-header"><span class="sr-icon">'+(t?t.icon:'')+'</span><span class="sr-title">'+esc(r.title)+'</span><button class="sr-del" onclick="event.stopPropagation();deleteSavedReview('+realIdx+')"></button></div><div class="sr-meta"><span class="sr-badge" style="background:'+(t?t.soft:'var(--surface2)')+';color:'+(t?t.cval:'var(--text2)')+';">'+(t?t.name:r.technique)+'</span><span>'+dateStr+' '+timeStr+'</span></div></div>'}).join('')+'<div style="margin-top:16px;"><button class="btn btn-danger btn-full btn-sm" onclick="clearAllSavedReviews()"> Clear All Reviews</button></div>'}
function openSavedDetail(idx){if(!S.savedReviews||!S.savedReviews[idx])return;var r=S.savedReviews[idx];var techMap=getTechMap();var t=techMap[r.technique];var d=new Date(r.date);var dateStr=d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});var timeStr=d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});document.getElementById('saved-detail-title').textContent=r.title||'Review Detail';document.getElementById('saved-detail-body').innerHTML='<div class="card" style="margin-bottom:14px;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;"><span style="font-size:32px;">'+(t?t.icon:'')+'</span><div><div style="font-size:16px;font-weight:800;">'+esc(r.title)+'</div><div style="font-size:12px;color:var(--text2);">'+(t?t.name:r.technique)+'</div></div></div><div style="font-size:12px;color:var(--text3);display:flex;gap:12px;flex-wrap:wrap;"><span> '+dateStr+'</span><span> '+timeStr+'</span></div></div><div class="section-label">Content</div><div class="sr-detail-content">'+esc(r.content||'No content saved.')+'</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;"><button class="btn btn-secondary" onclick="SFX.tap();navigateTo(\'screen-saved\',\'down\')"> Back</button><button class="btn btn-danger btn-sm" onclick="deleteSavedReview('+idx+');navigateTo(\'screen-saved\',\'down\')">Delete</button></div>';navigateTo('screen-saved-detail','up')}
function deleteSavedReview(idx){if(!S.savedReviews||idx<0||idx>=S.savedReviews.length)return;S.savedReviews.splice(idx,1);save();renderSavedReviews();showToast('Review deleted');SFX.erase()}
function clearAllSavedReviews(){if(!confirm('Delete all saved reviews?'))return;S.savedReviews=[];save();renderSavedReviews();showToast('All reviews cleared');SFX.erase()}

// =====================================================
// RETAKEABLE SAVED REVIEWS
// =====================================================

(function(){

var _origSaveReview = saveReviewItem;
saveReviewItem = function(technique, title, content, sessionData) {
    if (!S.savedReviews) S.savedReviews = [];
    S.savedReviews.push({
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        technique: technique,
        title: title || 'Study Session',
        content: content || '',
        date: new Date().toISOString(),
        sessionData: sessionData || null
    });
    save();
};

window.saveReviewItem = saveReviewItem;

window.saveFCSession = function() {
    var deck = S.decks[fcDeckIdx];
    if (!deck || !deck.cards.length) return;
    var content = 'Deck: ' + deck.name + '\nSubject: ' + (deck.subject || 'General') + '\nTotal Cards: ' + deck.cards.length + '\n\nCards:\n' + deck.cards.map(function(c, i) {
        return (i + 1) + '. Q: ' + c.front + '\n   A: ' + c.back;
    }).join('\n');
    saveReviewItem('flashcards', 'Flashcards: ' + deck.name, content, {
        type: 'flashcards',
        deckName: deck.name,
        deckSubject: deck.subject,
        deckColor: deck.color,
        cards: JSON.parse(JSON.stringify(deck.cards))
    });
    addXP(5);
    showToast(' Flashcard session saved!');
};

window.saveBlurtWithData = function() {
    saveReviewItem('blurting', 'Blurting Session', 'Source:\n' + blurtSrc + '\n\nRecall:\n' + blurtTxt, {
        type: 'blurting',
        source: blurtSrc
    });
    showToast(' Blurting session saved!');
};

window.saveRRRWithData = function() {
    addXP(15);
    logSession('rrr');
    save();
    SFX.success();
    saveReviewItem('rrr', 'Read Recite Review', 'Original:\n' + _rS + '\n\nRecall:\n' + _rR, {
        type: 'rrr',
        source: _rS
    });
    showToast(' Done! +15 XP');
    rrrPhase = 'read';
    renderRRR();
};

window.saveCornellReview = function() {
    var q = document.getElementById('cn-q');
    var n = document.getElementById('cn-n');
    var s = document.getElementById('cn-s');
    var qVal = q ? q.value : '';
    var nVal = n ? n.value : '';
    var sVal = s ? s.value : '';
    var content = 'Questions:\n' + qVal + '\n\nNotes:\n' + nVal + '\n\nSummary:\n' + sVal;
    saveReviewItem('question', 'Cornell Notes', content, {
        type: 'question',
        questions: qVal,
        notes: nVal,
        summary: sVal
    });
    showToast(' Cornell notes saved!');
};

window.saveFeynman = function() {
    S.feynmanCt = (S.feynmanCt || 0) + 1;
    addXP(20);
    logSession('feynman');
    if (S.feynmanCt >= 5) unlock('feynman_5');
    var concept = document.getElementById('feyn-concept');
    var explain = document.getElementById('feyn-explain');
    var gaps = document.getElementById('feyn-gaps');
    var simple = document.getElementById('feyn-simple');
    var cVal = concept ? concept.value : '';
    var eVal = explain ? explain.value : '';
    var gVal = gaps ? gaps.value : '';
    var sVal = simple ? simple.value : '';
    var content = 'Concept: ' + cVal + '\n\nExplanation: ' + eVal + '\n\nGaps: ' + gVal + '\n\nSimplified: ' + sVal;
    saveReviewItem('feynman', 'Feynman: ' + (cVal ? cVal.substring(0, 30) : 'Topic'), content, {
        type: 'feynman',
        concept: cVal,
        explanation: eVal,
        gaps: gVal,
        simplified: sVal
    });
    save();
    SFX.success();
    showToast(' Done! +20 XP');
    feynStep = 0;
    renderFeynman();
};

window.wbSave = function() {
    addXP(10);
    logSession('whiteboard');
    unlock('first_wb');
    saveReviewItem('whiteboard', 'Brain Dump Drawing', '[Canvas drawing saved at ' + new Date().toLocaleString() + ']', {
        type: 'whiteboard'
    });
    save();
    SFX.success();
    showToast(' Saved! +10 XP');
    goBack();
};

window.diagSave = function() {
    S.diagCt = (S.diagCt || 0) + 1;
    addXP(15);
    logSession('diagram');
    if (S.diagCt >= 5) unlock('diagram_5');
    var nodeLabels = diagNodes.map(function(n) { return n.label; }).join(', ');
    saveReviewItem('diagram', 'Diagram: ' + (diagNodes.length ? diagNodes[0].label : 'Map'), 'Nodes: ' + nodeLabels + '\nConnections: ' + diagEdges.length, {
        type: 'diagram',
        nodes: JSON.parse(JSON.stringify(diagNodes)),
        edges: JSON.parse(JSON.stringify(diagEdges))
    });
    save();
    SFX.success();
    showToast(' Saved! +15 XP');
};

window.submitMCQ = function() {
    var answered = Object.keys(mcqAnswers).length;
    if (answered < mcqQuestions.length) {
        showToast('Answer all ' + mcqQuestions.length + ' questions');
        SFX.error();
        return;
    }
    mcqSubmitted = true;
    var correct = 0;
    mcqQuestions.forEach(function(q, i) {
        var userAns = mcqAnswers[i];
        if (userAns !== undefined && q.options[userAns] && q.options[userAns].correct) correct++;
    });
    var pct = Math.round(correct / mcqQuestions.length * 100);
    addXP(20);
    logSession('mcq', 'MCQ Test', 15);
    save();
    SFX.success();
    burst(window.innerWidth / 2, 300);
    renderMCQTake();
    renderMCQResults(correct, pct);
    switchTestTab('mcq', 'results', null);
    saveReviewItem('mcq', 'MCQ Test  ' + pct + '%', 'Score: ' + correct + '/' + mcqQuestions.length + ' (' + pct + '%)\n\nQuestions:\n' + mcqQuestions.map(function(q, i) {
        var ua = mcqAnswers[i];
        var isC = q.options[ua] && q.options[ua].correct;
        return (i + 1) + '. ' + q.question + '  ' + (isC ? ' Correct' : ' Wrong');
    }).join('\n'), {
        type: 'mcq',
        questions: JSON.parse(JSON.stringify(mcqQuestions)),
        sourceText: mcqSourceText
    });
};

window.submitTF = function() {
    var answered = Object.keys(tfAnswers).length;
    if (answered < tfQuestions.length) {
        showToast('Answer all ' + tfQuestions.length + ' questions');
        SFX.error();
        return;
    }
    tfSubmitted = true;
    var correct = 0;
    tfQuestions.forEach(function(q, i) {
        if (tfAnswers[i] === q.answer) correct++;
    });
    var pct = Math.round(correct / tfQuestions.length * 100);
    addXP(20);
    logSession('tf', 'T/F Test', 10);
    save();
    SFX.success();
    burst(window.innerWidth / 2, 300);
    renderTFTake();
    renderTFResults(correct, pct);
    switchTestTab('tf', 'results', null);
    saveReviewItem('tf', 'T/F Test  ' + pct + '%', 'Score: ' + correct + '/' + tfQuestions.length + ' (' + pct + '%)\n\nQuestions:\n' + tfQuestions.map(function(q, i) {
        var isC = tfAnswers[i] === q.answer;
        return (i + 1) + '. ' + q.statement + '  ' + (isC ? ' Correct' : ' Wrong') + ' (Answer: ' + (q.answer ? 'True' : 'False') + ')';
    }).join('\n'), {
        type: 'tf',
        questions: JSON.parse(JSON.stringify(tfQuestions)),
        sourceText: tfSourceText
    });
};

window.renderBlurt = function() {
    var el = document.getElementById('blurt-body');
    if (!el) return;
    if (blurtPhase === 'source') {
        el.innerHTML = '<div class="phase-badge" style="background:var(--blue-soft);color:var(--blue);">Step 1: Enter Source</div><div style="font-size:13px;color:var(--text2);margin-bottom:10px;">Paste what you want to memorize.</div><textarea class="form-input" id="blurt-src" placeholder="Paste notes here..." style="min-height:200px;margin-bottom:12px;">' + blurtSrc + '</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();startBlurt()">Start Blurting</button>';
    } else if (blurtPhase === 'blurt') {
        el.innerHTML = '<div class="phase-badge" style="background:var(--pink-soft);color:var(--pink);">Step 2: Write From Memory</div>' + renderDurationAdjuster('blurt-timer', blurtReviewDur, 30, 600, 30, [60, 120, 180, 300]) + '<div class="blurt-timer-big" id="bt-timer">' + Math.floor(blurtReviewDur / 60) + ':' + String(blurtReviewDur % 60).padStart(2, '0') + '</div><textarea class="form-input" id="blurt-txt" placeholder="Write from memory..." style="min-height:210px;margin-bottom:12px;"></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-secondary" onclick="SFX.erase();document.getElementById(\'blurt-txt\').value=\'\'">Clear</button><button class="btn btn-primary" onclick="SFX.tap();endBlurt()">Done  Compare</button></div>';
        startBlurtTimer();
    } else {
        el.innerHTML = '<div class="phase-badge" style="background:var(--green-soft);color:var(--green);">Step 3: Compare</div><div class="compare-grid"><div class="compare-box"><h5>Source</h5>' + esc(blurtSrc) + '</div><div class="compare-box"><h5>Your Recall</h5>' + (blurtTxt ? esc(blurtTxt) : '<span style="opacity:0.4;">Nothing</span>') + '</div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;"><button class="btn btn-primary" onclick="SFX.tap();initBlurt()">Again</button><button class="btn btn-secondary" onclick="SFX.tap();saveBlurtWithData()"> Save</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Done</button></div>';
    }
};

window.renderRRR = function() {
    var el = document.getElementById('rrr-body');
    if (!el) return;
    var phaseHTML = {
        read: '<textarea class="form-input" id="rrr-src" placeholder="Paste material..." style="min-height:200px;margin-bottom:12px;">' + _rS + '</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();_rS=document.getElementById(\'rrr-src\').value;rrrPhase=\'recite\';renderRRR()">Recite </button>',
        recite: '<div class="compare-box" style="margin-bottom:10px;">Source hidden!</div><textarea class="form-input" id="rrr-rec" placeholder="From memory..." style="min-height:200px;margin-bottom:12px;">' + _rR + '</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();_rR=document.getElementById(\'rrr-rec\').value;rrrPhase=\'review\';renderRRR()">Review </button>',
        review: '<div class="compare-grid"><div class="compare-box"><h5>Original</h5>' + (_rS ? esc(_rS) : '(empty)') + '</div><div class="compare-box"><h5>Recall</h5>' + (_rR ? esc(_rR) : '(empty)') + '</div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;"><button class="btn btn-primary" onclick="SFX.tap();saveRRRWithData()"> Done</button><button class="btn btn-secondary" onclick="SFX.tap();rrrPhase=\'read\';renderRRR()">Again</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Home</button></div>'
    };
    el.innerHTML = '<div class="rrr-btns"><div class="rrr-btn ' + (rrrPhase === 'read' ? 'active' : '') + '" onclick="SFX.tap();rrrPhase=\'read\';renderRRR()">Read</div><div class="rrr-btn ' + (rrrPhase === 'recite' ? 'active' : '') + '" onclick="SFX.tap();rrrPhase=\'recite\';renderRRR()">Recite</div><div class="rrr-btn ' + (rrrPhase === 'review' ? 'active' : '') + '" onclick="SFX.tap();rrrPhase=\'review\';renderRRR()">Review</div></div>' + (phaseHTML[rrrPhase] || '');
};

window.openSavedDetail = function(idx) {
    if (!S.savedReviews || !S.savedReviews[idx]) return;
    var r = S.savedReviews[idx];
    var techMap = getTechMap();
    var t = techMap[r.technique];
    var d = new Date(r.date);
    var dateStr = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    var timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    var canRetake = !!(r.sessionData && r.sessionData.type);
    var retakeLabel = getRetakeLabel(r.technique);
    document.getElementById('saved-detail-title').textContent = r.title || 'Review Detail';
    var html = '<div class="card" style="margin-bottom:14px;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;"><span style="font-size:32px;">' + (t ? t.icon : '') + '</span><div><div style="font-size:16px;font-weight:800;">' + esc(r.title) + '</div><div style="font-size:12px;color:var(--text2);">' + (t ? t.name : r.technique) + '</div></div></div><div style="font-size:12px;color:var(--text3);display:flex;gap:12px;flex-wrap:wrap;"><span> ' + dateStr + '</span><span> ' + timeStr + '</span></div></div>';
    if (canRetake) {
        html += '<div style="margin-bottom:14px;"><button class="btn btn-primary btn-full" onclick="SFX.tap();retakeSavedReview(' + idx + ')"> ' + retakeLabel + '</button></div>';
    }
    html += '<div class="section-label">Content</div><div class="sr-detail-content">' + esc(r.content || 'No content saved.') + '</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;"><button class="btn btn-secondary" onclick="SFX.tap();navigateTo(\'screen-saved\',\'down\')"> Back</button><button class="btn btn-danger btn-sm" onclick="deleteSavedReview(' + idx + ');navigateTo(\'screen-saved\',\'down\')">Delete</button></div>';
    document.getElementById('saved-detail-body').innerHTML = html;
    navigateTo('screen-saved-detail', 'up');
};

function getRetakeLabel(technique) {
    var labels = {
        mcq: 'Retake MCQ Test',
        tf: 'Retake True/False Test',
        flashcards: 'Study Flashcards Again',
        blurting: 'Redo Blurting Session',
        question: 'Reopen Cornell Notes',
        feynman: 'Redo Feynman Session',
        rrr: 'Redo Read, Recite, Review',
        whiteboard: 'Open Brain Dump',
        diagram: 'Reopen Diagram'
    };
    return labels[technique] || 'Retake Session';
}

window.retakeSavedReview = function(idx) {
    if (!S.savedReviews || !S.savedReviews[idx]) return;
    var r = S.savedReviews[idx];
    var sd = r.sessionData;
    if (!sd || !sd.type) {
        showToast('Cannot retake this review');
        SFX.error();
        return;
    }
    switch (sd.type) {
        case 'mcq': retakeMCQ(sd); break;
        case 'tf': retakeTF(sd); break;
        case 'flashcards': retakeFlashcards(sd); break;
        case 'blurting': retakeBlurting(sd); break;
        case 'question': retakeCornell(sd); break;
        case 'feynman': retakeFeynman(sd); break;
        case 'rrr': retakeRRR(sd); break;
        case 'whiteboard': retakeWhiteboard(sd); break;
        case 'diagram': retakeDiagram(sd); break;
        default: showToast('Unknown type'); SFX.error();
    }
};

function retakeMCQ(sd) {
    mcqQuestions = JSON.parse(JSON.stringify(sd.questions));
    mcqSourceText = sd.sourceText || '';
    mcqAnswers = {};
    mcqSubmitted = false;
    mcqQuestions.forEach(function(q) {
        if (q.options) q.options = shuffleArray(q.options);
    });
    renderMCQTake();
    switchTestTab('mcq', 'take', null);
    navigateTo('screen-mcq', 'up');
    SFX.correct();
    showToast(' MCQ test loaded!');
}

function retakeTF(sd) {
    tfQuestions = JSON.parse(JSON.stringify(sd.questions));
    tfSourceText = sd.sourceText || '';
    tfAnswers = {};
    tfSubmitted = false;
    tfQuestions = shuffleArray(tfQuestions);
    renderTFTake();
    switchTestTab('tf', 'take', null);
    navigateTo('screen-tf', 'up');
    SFX.correct();
    showToast(' T/F test loaded!');
}

function retakeFlashcards(sd) {
    var existingIdx = -1;
    if (S.decks) {
        for (var i = 0; i < S.decks.length; i++) {
            if (S.decks[i].name === sd.deckName) { existingIdx = i; break; }
        }
    }
    if (existingIdx >= 0) {
        fcDeckIdx = existingIdx;
    } else {
        if (!S.decks) S.decks = [];
        S.decks.push({
            name: sd.deckName || 'Restored Deck',
            subject: sd.deckSubject || 'Saved',
            color: sd.deckColor || '#8b5cf6',
            cards: JSON.parse(JSON.stringify(sd.cards || []))
        });
        save();
        fcDeckIdx = S.decks.length - 1;
    }
    fcCardIdx = 0;
    fcFlipped = false;
    renderFCStudy();
    switchFcTab('study', null);
    navigateTo('screen-flashcards', 'up');
    SFX.correct();
    showToast(' Flashcards loaded!');
}

function retakeBlurting(sd) {
    blurtPhase = 'source';
    blurtSrc = sd.source || '';
    blurtTxt = '';
    renderBlurt();
    navigateTo('screen-blurting', 'up');
    SFX.correct();
    showToast(' Blurting loaded!');
}

function retakeCornell(sd) {
    navigateTo('screen-question', 'up');
    setTimeout(function() {
        var body = document.getElementById('cornell-body');
        if (!body) return;
        body.innerHTML = '<div style="font-size:13px;color:var(--text2);margin-bottom:12px;"><strong>Cornell Notes:</strong> Questions left, notes right.</div><div class="cornell-grid"><div><div class="cornell-lbl">Questions</div><textarea class="form-input" id="cn-q" placeholder="What causes...?" style="min-height:200px;">' + (sd.questions || '') + '</textarea></div><div><div class="cornell-lbl">Notes</div><textarea class="form-input" id="cn-n" placeholder="Detailed notes..." style="min-height:200px;">' + (sd.notes || '') + '</textarea></div></div><div style="margin-top:10px;"><div class="cornell-lbl">Summary</div><textarea class="form-input" id="cn-s" placeholder="Key takeaways..." style="min-height:70px;">' + (sd.summary || '') + '</textarea></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px;"><button class="btn btn-primary" onclick="SFX.tap();addXP(10);logSession(\'question\');SFX.correct();showToast(\'Saved! +10 XP\');saveCornellReview()"> Save</button><button class="btn btn-secondary" onclick="SFX.tap();cornellQuiz()">Quiz</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Done</button></div>';
        SFX.correct();
        showToast(' Cornell notes loaded!');
    }, 500);
}

function retakeFeynman(sd) {
    feynStep = 0;
    navigateTo('screen-feynman', 'up');
    setTimeout(function() {
        var body = document.getElementById('feynman-body');
        if (!body) return;
        var safeConceptVal = (sd.concept || '').replace(/"/g, '&quot;');
        body.innerHTML = '<div class="feynman-steps">' + ['Concept', 'Explain', 'Gaps', 'Simplify'].map(function(s, i) {
            return '<div class="feynman-step ' + (i === 0 ? 'active' : '') + '" onclick="SFX.tap();feynStep=' + i + ';renderFeynman();">' + (i + 1) + '. ' + s + '</div>';
        }).join('') + '</div><div style="font-size:13px;color:var(--purple);margin-bottom:8px;font-weight:700;"> Loaded from saved session</div><div style="font-size:13px;color:var(--text2);margin-bottom:12px;">What concept?</div><input class="form-input" id="feyn-concept" placeholder="Concept name" value="' + safeConceptVal + '" style="margin-bottom:10px;"><textarea class="form-input" id="feyn-know" placeholder="What you know..." style="min-height:180px;margin-bottom:12px;">' + (sd.explanation || '') + '</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=1;renderFeynman()">Next</button>';
        SFX.correct();
        showToast(' Feynman loaded!');
    }, 500);
}

function retakeRRR(sd) {
    rrrPhase = 'read';
    _rS = sd.source || '';
    _rR = '';
    renderRRR();
    navigateTo('screen-rrr', 'up');
    SFX.correct();
    showToast(' RRR loaded!');
}

function retakeWhiteboard() {
    navigateTo('screen-whiteboard', 'up');
    setTimeout(initWB, 400);
    SFX.correct();
    showToast(' Fresh canvas ready!');
}

function retakeDiagram(sd) {
    navigateTo('screen-diagram', 'up');
    setTimeout(function() {
        diagNodes = sd.nodes ? JSON.parse(JSON.stringify(sd.nodes)) : [];
        diagEdges = sd.edges ? JSON.parse(JSON.stringify(sd.edges)) : [];
        diagConnectMode = false;
        diagConnectFrom = null;
        renderDiagToolbar();
        renderDiagCanvas();
        SFX.correct();
        showToast(' Diagram loaded!');
    }, 500);
}

window.renderSavedReviews = function() {
    var el = document.getElementById('saved-body');
    if (!el) return;
    if (!S.savedReviews) S.savedReviews = [];
    document.getElementById('saved-count').textContent = S.savedReviews.length + ' saved';
    if (!S.savedReviews.length) {
        el.innerHTML = '<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:16px;font-weight:800;margin-bottom:6px;color:var(--text);">No saved reviews yet!</div><div style="font-size:13px;">Complete study sessions to save reviews here.</div></div>';
        return;
    }
    var techMap = getTechMap();
    var reviews = S.savedReviews.slice().reverse();
    el.innerHTML = '<div class="section-label">All Saved Reviews (' + reviews.length + ')</div>' + reviews.map(function(r, revIdx) {
        var realIdx = S.savedReviews.length - 1 - revIdx;
        var t = techMap[r.technique];
        var d = new Date(r.date);
        var dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        var timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        var canRetake = !!(r.sessionData && r.sessionData.type);
        return '<div class="saved-review-card" onclick="SFX.tap();openSavedDetail(' + realIdx + ')"><div class="sr-header"><span class="sr-icon">' + (t ? t.icon : '') + '</span><span class="sr-title">' + esc(r.title) + '</span>' + (canRetake ? '<span style="font-size:10px;font-weight:900;padding:2px 8px;border-radius:8px;background:var(--purple-g);color:var(--purple);margin-left:4px;">RETAKE</span>' : '') + '<button class="sr-del" onclick="event.stopPropagation();deleteSavedReview(' + realIdx + ')"></button></div><div class="sr-meta"><span class="sr-badge" style="background:' + (t ? t.soft : 'var(--surface2)') + ';color:' + (t ? t.cval : 'var(--text2)') + ';">' + (t ? t.name : r.technique) + '</span><span>' + dateStr + ' ' + timeStr + '</span></div></div>';
    }).join('') + '<div style="margin-top:16px;"><button class="btn btn-danger btn-full btn-sm" onclick="clearAllSavedReviews()"> Clear All Reviews</button></div>';
};

})();

// =====================================================
// END RETAKEABLE BLOCK
// =====================================================
hideSplash();
scheduleNotificationCheck();
</script>
</body>
</html>